<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kerala | Doctors</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="assets/images/favicon.png" />
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <!-- Custom CSS for cards, tabs, and modal -->
    <style>
        .patient-card {
            margin-bottom: 15px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
        }
        .patient-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        .nav-tabs .nav-link {
            border: 1px solid #dee2e6;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff #007bff #dee2e6;
        }
        #patientCards {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        #patientModal .modal-dialog {
            max-width: 800px;
        }
        #patientModal .modal-body {
            max-height: 70vh;
            overflow-y: auto;
        }
        .appointment-list {
            list-style: none;
            padding: 0;
        }
        .appointment-list li {
            border-bottom: 1px solid #dee2e6;
            padding: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container-scroller">
        <div class="row p-0 m-0 proBanner" id="proBanner">
            <div class="col-md-12 p-0 m-0">
                <div class="card-body card-body-padding d-flex align-items-center justify-content-between">
                    <div class="ps-lg-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <p class="mb-0 font-weight-medium me-3 buy-now-text">Free 24/7 customer support, updates</p>
                            <a href="" target="_blank" class="btn me-2 buy-now-btn border-0">Book Appointment</a>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <a href=""><i class="mdi mdi-home me-3 text-white"></i></a>
                        <button id="bannerClose" class="btn border-0 p-0">
                            <i class="mdi mdi-close text-white mr-0"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
                <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-stretch">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="mdi mdi-menu"></span>
                </button>
                <div class="search-field d-none d-md-block">
                    <form class="d-flex align-items-center h-100" action="#">
                        <div class="input-group">
                            <div class="input-group-prepend bg-transparent">
                                <i class="input-group-text border-0 mdi mdi-magnify"></i>
                            </div>
                            <input type="text" class="form-control bg-transparent border-0" placeholder="Search patients, appointments">
                        </div>
                    </form>
                </div>
                <ul class="navbar-nav navbar-nav-right">
                    <!-- Profile Dropdown -->
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="nav-profile-img">
                                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                                <span class="availability-status online"></span>
                            </div>
                            <div class="nav-profile-text">
                                <p class="mb-1 text-black"><span id="logged_in_user_name"></span></p>
                            </div>
                        </a>
                        <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item" href="#">
                                <i class="mdi mdi-account-circle me-2 text-success"></i> My Profile </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" id="logoutButton">
                                <i class="mdi mdi-logout me-2 text-primary"></i> Logout </a>
                        </div>
                    </li>
                    <!-- Messages and Notifications Dropdowns (unchanged) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-email-outline"></i>
                            <span class="count-symbol bg-warning" id="message-count">3</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
                            <h6 class="p-3 mb-0">Messages</h6>
                            <div id="message-list">
                                <p class="text-gray mb-0 text-center">No new messages</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all messages</h6>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-bell-outline"></i>
                            <span class="count-symbol bg-danger" id="notification-count">5</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                            <h6 class="p-3 mb-0">Notifications</h6>
                            <div id="notification-list">
                                <p class="text-gray mb-0 text-center">No new notifications</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all notifications</h6>
                        </div>
                    </li>
                    <li class="nav-item nav-logout d-none d-lg-block">
                        <a class="nav-link" href="#" id="logoutButton">
                            <i class="mdi mdi-power"> Logout</i>
                        </a>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                    <span class="mdi mdi-menu"></span>
                </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item nav-profile">
                        <a href="#" class="nav-link">
                            <div class="nav-profile-image">
                                <img src="assets/images/faces/face1.jpg" alt="profile" />
                                <span class="login-status online"></span>
                            </div>
                            <div class="nav-profile-text d-flex flex-column">
                                <span class="font-weight-bold mb-2">Dr. David Grey</span>
                                <span class="text-secondary text-small">Cardiologist</span>
                            </div>
                            <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <span class="menu-title">Dashboard</span>
                            <i class="mdi mdi-home menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="patients.html">
                            <span class="menu-title">Patients</span>
                            <i class="mdi mdi-account-group menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="appointments.html">
                            <span class="menu-title">Appointments</span>
                            <i class="mdi mdi-calendar-check menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
                            <span class="menu-title">Medical Records</span>
                            <i class="menu-arrow"></i>
                            <i class="mdi mdi-folder-multiple menu-icon"></i>
                        </a>
                        <div class="collapse" id="medical-records">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a class="nav-link" href="records/view-records.html">View Records</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="records/upload-records.html">Upload Records</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="prescriptions.html">
                            <span class="menu-title">Prescriptions</span>
                            <i class="mdi mdi-pill menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <span class="menu-title">Reports</span>
                            <i class="mdi mdi-chart-bar menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="lab-tests.html">
                            <span class="menu-title">Lab Tests</span>
                            <i class="mdi mdi-flask-outline menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <span class="menu-title">Settings</span>
                            <i class="mdi mdi-settings menu-icon"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">
                            <span class="page-title-icon bg-gradient-primary text-white me-2">
                                <i class="mdi mdi-account-group"></i>
                            </span> Patients
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item active" aria-current="page">
                                    <span>Welcome, <span id="logged_in_user_name"></span> - Good <span id="timeOfDay">Morning</span></span>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div class="row" id="patientCards">
                        <!-- Patient cards will be dynamically inserted here -->
                    </div>

                </div>

                <!-- Modal for Patient Details -->
                <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="patientModalLabel">Patient Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="modalPatientDetails">
                                <!-- Patient details will be inserted here -->
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- content-wrapper ends -->
                <!-- partial:partials/_footer.html -->
                <footer class="footer">
                    <div class="d-sm-flex justify-content-center justify-content-sm-between">
                        <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright ¬© 2025 <a href="https://www.kerala.com/" target="_blank">Kerala. All rights reserved.</span>
                        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
                    </div>
                </footer>
                <!-- partial -->
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- plugins:js -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="assets/vendors/chart.js/chart.umd.js"></script>
    <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="assets/js/dashboard.js"></script>
    <!-- End custom js for this page -->

    <script>
        // Function to retrieve authentication headers
        function getAuthHeaders() {
            const token = sessionStorage.getItem('token') || localStorage.getItem('token');
            const username = sessionStorage.getItem('username') || localStorage.getItem('username');
            const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken');
            
            if (token && username && csrftoken) {
                return {
                    'Authorization': 'Token ' + token,
                    'X-CSRFToken': csrftoken,
                    'Username': username
                };
            }
            console.warn('Missing authentication details.');
            return {};
        }

        // Function to check session data on page load
        function checkSessionOnLoad() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            const userType = localStorage.getItem('user_type');

            if (!token || !username || !userType) {
                console.warn('üî¥ Session data missing or invalid. Redirecting...');
                window.location.href = 'http://smarthospitalmaintain.com';
                return;
            }

            console.log('üü¢ Session data exists. Validating session...');
            validateUserSession();
        }

        // Validate user session
        function validateUserSession() {
            const headers = getAuthHeaders();

            if (!headers['Authorization']) {
                console.warn('üî¥ No valid token. User is not authenticated.');
                window.location.href = 'http://smarthospitalmaintain.com';
                return;
            }

            $.ajax({
                url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
                type: 'GET',
                headers: headers,
                success: function(response) {
                    console.log('üü¢ Session validation success:', response);

                    if (response.message !== 'Cookie is valid.') {
                        console.warn('üî¥ Invalid session. Logging out...');
                        alert('Invalid session. Logging out.');
                        attemptLogout();
                    } else {
                        // Update navigation bar with user details
                        document.getElementById("logged_in_user_name").textContent = response.name;
                        document.getElementById("timeOfDay").textContent = getGreetingTime();
                        fetchPatients(); // Fetch patients after session validation
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‚ùå Error validating session:', xhr.responseText);
                    attemptLogout();
                }
            });
        }

        // Attempt to logout and handle failures
        function attemptLogout() {
            logoutUser();

            setTimeout(function() {
                if (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) {
                    console.warn('üî¥ Logout failed! Forcing session cleanup.');
                    forceLogout();
                }
            }, 3000);
        }

        // Force logout by clearing session data and redirecting
        function forceLogout() {
            sessionStorage.clear();
            localStorage.clear();
            document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            console.log('üîÑ Redirecting to landing page after forced logout...');
            window.location.href = 'http://smarthospitalmaintain.com/';
        }

        // Function to get time of day greeting
        function getGreetingTime() {
            const hours = new Date().getHours();
            if (hours < 12) return "Morning";
            else if (hours < 18) return "Afternoon";
            else return "Evening";
        }

        // Logout function
        function logoutUser() {
            const headers = getAuthHeaders();

            if (!headers['Authorization']) {
                console.error('No authentication token. Redirecting to login...');
                window.location.href = 'http://smarthospitalmaintain.com/';
                return;
            }

            $.ajax({
                url: 'http://smarthospitalmaintain.com:8000/users/logout/',
                type: 'POST',
                headers: headers,
                success: function(response) {
                    console.log('User logged out successfully:', response);
                    sessionStorage.clear();
                    localStorage.clear();
                    document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    window.location.href = 'http://smarthospitalmaintain.com/';
                },
                error: function(xhr, status, error) {
                    console.error('Logout error:', xhr.responseText);
                }
            });
        }

        // Attach logout event
        $(document).ready(function() {
            $('#logoutButton').on('click', function(event) {
                event.preventDefault();
                logoutUser();
            });
        });

        // Function to fetch patients with role-based restrictions
        function fetchPatients() {
            const headers = getAuthHeaders();
            const userType = localStorage.getItem('user_type');
            let url = 'http://smarthospitalmaintain.com:8000/patients/list/';

            // For doctors, filter patients based on their assigned appointments
            if (userType === 'doctor') {
                const username = localStorage.getItem('username');
                url += `?doctor=${encodeURIComponent(username)}`; // Adjust based on your API endpoint logic
            }

            $.ajax({
                url: url,
                type: 'GET',
                headers: headers,
                success: function(response) {
                    console.log('Patients fetched:', response);
                    displayPatientCards(response);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching patients:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch patients. Please try again.'
                    });
                }
            });
        }

        // Function to display patient cards with tabs
        function displayPatientCards(patients) {
            const patientCards = document.getElementById("patientCards");
            patientCards.innerHTML = "";

            patients.forEach((patient, index) => {
                const card = document.createElement("div");
                card.className = "col-md-6 patient-card";
                card.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${patient.first_name} ${patient.last_name}</h5>
                            <p class="card-text"><strong>Patient ID:</strong> ${patient.patient_id}</p>
                            <ul class="nav nav-tabs" role="tablist">
                                <li class="nav-item">
                                    <a class="nav-link active" id="personal-${patient.patient_id}-tab" data-bs-toggle="tab" href="#personal-${patient.patient_id}" role="tab" aria-controls="personal-${patient.patient_id}" aria-selected="true">Personal Info</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="appointments-${patient.patient_id}-tab" data-bs-toggle="tab" href="#appointments-${patient.patient_id}" role="tab" aria-controls="appointments-${patient.patient_id}" aria-selected="false">Appointments</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" id="vitals-${patient.patient_id}-tab" data-bs-toggle="tab" href="#vitals-${patient.patient_id}" role="tab" aria-controls="vitals-${patient.patient_id}" aria-selected="false">Vitals</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="personal-${patient.patient_id}" role="tabpanel" aria-labelledby="personal-${patient.patient_id}-tab">
                                    <p><strong>Contact:</strong> ${patient.contact_number}</p>
                                    <p><strong>Age:</strong> ${patient.age || "Unknown"}</p>
                                    <p><strong>Illness:</strong> ${patient.current_illness || "None"}</p>
                                    <p><strong>Email:</strong> ${patient.email || "N/A"}</p>
                                    <p><strong>Date of Birth:</strong> ${patient.date_of_birth || "N/A"}</p>
                                </div>
                                <div class="tab-pane fade" id="appointments-${patient.patient_id}" role="tabpanel" aria-labelledby="appointments-${patient.patient_id}-tab">
                                    <p>No appointments available.</p>
                                </div>
                                <div class="tab-pane fade" id="vitals-${patient.patient_id}" role="tabpanel" aria-labelledby="vitals-${patient.patient_id}-tab">
                                    <p>No vitals recorded.</p>
                                </div>
                            </div>
                            <button class="btn btn-primary mt-3 view-details-btn" data-patient-id="${patient.patient_id}">View Details</button>
                        </div>
                    </div>
                `;
                patientCards.appendChild(card);

                // Populate appointments tab
                if (patient.appointments && patient.appointments.length > 0) {
                    const appointmentsTab = document.getElementById(`appointments-${patient.patient_id}`);
                    appointmentsTab.innerHTML = '<ul class="appointment-list">' + patient.appointments
                        .map(appt => `
                            <li>
                                <strong>Date:</strong> ${new Date(appt.appointment_date).toLocaleString()}<br>
                                <strong>Status:</strong> ${appt.status}<br>
                                <strong>Notes:</strong> ${appt.notes || "N/A"}<br>
                                <strong>Doctor:</strong> ${appt.doctor ? `${appt.doctor.first_name} ${appt.doctor.last_name} (${appt.doctor.specialization})` : "Not Assigned"}
                            </li>
                        `).join("") + '</ul>';
                }

                // Populate vitals tab (using the first appointment with vitals, if any)
                if (patient.appointments && patient.appointments.some(appt => appt.vitals)) {
                    const vitalsTab = document.getElementById(`vitals-${patient.patient_id}`);
                    const vitals = patient.appointments.reduce((acc, appt) => appt.vitals || acc, {});
                    vitalsTab.innerHTML = `
                        <p><strong>Temperature:</strong> ${vitals.temperature || 'N/A'}¬∞C</p>
                        <p><strong>Blood Pressure:</strong> ${vitals.blood_pressure || 'N/A'}</p>
                        <p><strong>Heart Rate:</strong> ${vitals.heart_rate || 'N/A'} bpm</p>
                        <p><strong>Weight:</strong> ${vitals.weight || 'N/A'} kg</p>
                        <p><strong>Height:</strong> ${vitals.height || 'N/A'} cm</p>
                    `;
                }
            });

            // Add event listener to view details buttons
            document.querySelectorAll(".view-details-btn").forEach(button => {
                button.addEventListener("click", function() {
                    const patientId = this.getAttribute("data-patient-id");
                    showPatientModal(patientId);
                });
            });
        }

        // Function to show patient details in modal
        function showPatientModal(patientId) {
            const headers = getAuthHeaders();
            $.ajax({
                url: `http://smarthospitalmaintain.com:8000/patients/list/?patient_id=${encodeURIComponent(patientId)}`,
                type: 'GET',
                headers: headers,
                success: function(response) {
                    if (response.length > 0) {
                        const patient = response[0];
                        let appointmentInfo = "No appointments available.";
                        if (patient.appointments && patient.appointments.length > 0) {
                            appointmentInfo = '<ul class="appointment-list">' + patient.appointments
                                .map(appt => `
                                    <li>
                                        <strong>Date:</strong> ${new Date(appt.appointment_date).toLocaleString()}<br>
                                        <strong>Status:</strong> ${appt.status}<br>
                                        <strong>Notes:</strong> ${appt.notes || "N/A"}<br>
                                        <strong>Doctor:</strong> ${appt.doctor ? `${appt.doctor.first_name} ${appt.doctor.last_name} (${appt.doctor.specialization})` : "Not Assigned"}<br>
                                        <strong>Vitals:</strong> ${appt.vitals ? `
                                            Temperature: ${appt.vitals.temperature || 'N/A'}¬∞C, 
                                            Blood Pressure: ${appt.vitals.blood_pressure || 'N/A'}, 
                                            Heart Rate: ${appt.vitals.heart_rate || 'N/A'} bpm, 
                                            Weight: ${appt.vitals.weight || 'N/A'} kg, 
                                            Height: ${appt.vitals.height || 'N/A'} cm` : 'N/A'}
                                    </li>
                                `).join("") + '</ul>';
                        }

                        document.getElementById("modalPatientDetails").innerHTML = `
                            <h5>${patient.first_name} ${patient.last_name}</h5>
                            <p><strong>Patient ID:</strong> ${patient.patient_id}</p>
                            <p><strong>Contact:</strong> ${patient.contact_number}</p>
                            <p><strong>Age:</strong> ${patient.age || "Unknown"}</p>
                            <p><strong>Illness:</strong> ${patient.current_illness || "None"}</p>
                            <p><strong>Email:</strong> ${patient.email || "N/A"}</p>
                            <p><strong>Date of Birth:</strong> ${patient.date_of_birth || "N/A"}</p>
                            <h6>Appointments</h6>
                            ${appointmentInfo}
                        `;
                        $('#patientModal').modal('show');
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Patient not found.'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching patient details:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch patient details. Please try again.'
                    });
                }
            });
        }

        // Run session check and fetch patients on page load
        document.addEventListener("DOMContentLoaded", function () {
            checkSessionOnLoad();
        });
    </script>
</body>
</html>