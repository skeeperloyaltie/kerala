<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kerala | Patients</title>
    <!-- Plugins: CSS -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="shortcut icon" href="assets/images/favicon.png" />
    <!-- Custom CSS -->
    <style>
        .filter-container { margin-bottom: 20px; }
        #patientFilter { width: 100%; padding: 10px; margin-bottom: 10px; }
        #patientsTable { width: 100%; border-collapse: collapse; }
        #patientsTable th, #patientsTable td { padding: 10px; text-align: left; border: 1px solid #dee2e6; }
        #patientsTable th { background-color: #007bff; color: white; position: sticky; top: 0; cursor: pointer; }
        #patientsTable th:hover { background-color: #0056b3; }
        #patientsTable tr:nth-child(even) { background-color: #f8f9fa; }
        #patientsTable tr:hover { background-color: #e9ecef; }
        .btn-sm { margin: 2px; }
        .modal-body table { width: 100%; border-collapse: collapse; }
        .modal-body th, .modal-body td { padding: 8px; border: 1px solid #dee2e6; }
        .sort-arrow { margin-left: 5px; }
    </style>
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>
<body>
    <div class="container-scroller">
        <!-- Banner -->
        <div class="row p-0 m-0 proBanner" id="proBanner">
            <div class="col-md-12 p-0 m-0">
                <div class="card-body card-body-padding d-flex align-items-center justify-content-between">
                    <p class="mb-0 font-weight-medium me-3 buy-now-text">Free 24/7 customer support, updates</p>
                    <a href="" target="_blank" class="btn me-2 buy-now-btn border-0">Book Appointment</a>
                    <div class="d-flex align-items-center">
                        <a href=""><i class="mdi mdi-home me-3 text-white"></i></a>
                        <button id="bannerClose" class="btn border-0 p-0"><i class="mdi mdi-close text-white"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navbar -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
                <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-stretch">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="mdi mdi-menu"></span>
                </button>
                <ul class="navbar-nav navbar-nav-right">
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="nav-profile-img">
                                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                                <span class="availability-status online"></span>
                            </div>
                            <div class="nav-profile-text"><p class="mb-1 text-black" id="logged_in_user_name"></p></div>
                        </a>
                        <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item" href="#"><i class="mdi mdi-account-circle me-2 text-success"></i> My Profile </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" id="logoutButtonDropdown"><i class="mdi mdi-logout me-2 text-primary"></i> Logout </a>
                        </div>
                    </li>
                    <li class="nav-item nav-logout d-none d-lg-block">
                        <button class="btn btn-outline-danger" id="logoutButton">Logout</button>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                    <span class="mdi mdi-menu"></span>
                </button>
            </div>
        </nav>

        <!-- Sidebar -->
        <div class="container-fluid page-body-wrapper">
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item nav-profile">
                        <a href="#" class="nav-link">
                            <div class="nav-profile-image"><img src="assets/images/faces/face1.jpg" alt="profile" /><span class="login-status online"></span></div>
                            <div class="nav-profile-text d-flex flex-column">
                                <span class="font-weight-bold mb-2" id="sidebar_user_name"></span>
                                <span class="text-secondary text-small" id="sidebar_user_role"></span>
                            </div>
                            <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
                        </a>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="index.html"><span class="menu-title">Dashboard</span><i class="mdi mdi-home menu-icon"></i></a></li>
                    <li class="nav-item active"><a class="nav-link" href="patients.html"><span class="menu-title">Patients</span><i class="mdi mdi-account-group menu-icon"></i></a></li>
                    <li class="nav-item"><a class="nav-link" href="appointments.html"><span class="menu-title">Appointments</span><i class="mdi mdi-calendar-check menu-icon"></i></a></li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
                            <span class="menu-title">Medical Records</span><i class="menu-arrow"></i><i class="mdi mdi-folder-multiple menu-icon"></i>
                        </a>
                        <div class="collapse" id="medical-records">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item"><a class="nav-link" href="records/view-records.html">View Records</a></li>
                                <li class="nav-item"><a class="nav-link" href="records/upload-records.html">Upload Records</a></li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item"><a class="nav-link" href="prescriptions.html"><span class="menu-title">Prescriptions</span><i class="mdi mdi-pill menu-icon"></i></a></li>
                    <li class="nav-item"><a class="nav-link" href="reports.html"><span class="menu-title">Reports</span><i class="mdi mdi-chart-bar menu-icon"></i></a></li>
                    <li class="nav-item"><a class="nav-link" href="lab-tests.html"><span class="menu-title">Lab Tests</span><i class="mdi mdi-flask-outline menu-icon"></i></a></li>
                    <li class="nav-item"><a class="nav-link" href="settings.html"><span class="menu-title">Settings</span><i class="mdi mdi-settings menu-icon"></i></a></li>
                </ul>
            </nav>

            <!-- Main Panel -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">
                            <span class="page-title-icon bg-gradient-primary text-white me-2"><i class="mdi mdi-account-group"></i></span> Patients
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item active" aria-current="page">
                                    Welcome, <span id="welcome_user_name"></span> - Good <span id="timeOfDay"></span>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div class="row">
                        <div class="col-md-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Patient List</h4>
                                    <div class="filter-container">
                                        <input type="text" id="patientFilter" class="form-control" placeholder="Search by Patient ID, Name, Age, DOB...">
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table" id="patientsTable">
                                            <thead>
                                                <tr>
                                                    <th data-sort="patient_id">Patient ID <span class="sort-arrow"></span></th>
                                                    <th data-sort="first_name">First Name <span class="sort-arrow"></span></th>
                                                    <th data-sort="last_name">Last Name <span class="sort-arrow"></span></th>
                                                    <th data-sort="age">Age <span class="sort-arrow"></span></th>
                                                    <th data-sort="date_of_birth">DOB <span class="sort-arrow"></span></th>
                                                    <th data-sort="mobile_number">Mobile Number <span class="sort-arrow"></span></th>
                                                    <th data-sort="email">Email <span class="sort-arrow"></span></th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="patientsList"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal for Patient Details -->
                <div class="modal fade" id="patientModal" tabindex="-1" aria-labelledby="patientModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="patientModalLabel">Patient Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body" id="modalPatientDetails"></div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Appointment Modal -->
                <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="editModalLabel">Edit Appointment</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <form id="editForm">
                                    <div class="mb-3">
                                        <label for="editNotes" class="form-label">Notes</label>
                                        <input type="text" class="form-control" id="editNotes" name="notes">
                                    </div>
                                    <div class="mb-3">
                                        <label for="editStatus" class="form-label">Status</label>
                                        <select class="form-control" id="editStatus" name="status">
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="Active">Active</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Canceled">Canceled</option>
                                            <option value="Rescheduled">Rescheduled</option>
                                            <option value="Waiting">Waiting</option>
                                            <option value="Pending">Pending</option>
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" id="saveEdit">Save</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="footer">
                    <div class="d-sm-flex justify-content-center justify-content-sm-between">
                        <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2025 <a href="https://www.kerala.com/" target="_blank">Kerala</a>. All rights reserved.</span>
                        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
                    </div>
                </footer>
            </div>
        </div>

        <!-- Scripts -->
        <script src="assets/vendors/js/vendor.bundle.base.js"></script>
        <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
        <script src="assets/js/off-canvas.js"></script>
        <script src="assets/js/misc.js"></script>
        <script src="assets/js/settings.js"></script>
        <script src="assets/js/todolist.js"></script>
        <script src="assets/js/jquery.cookie.js"></script>
        <script src="assets/js/dashboard.js"></script>

        <script>
            // Authentication Headers
            function getAuthHeaders() {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken');
                return token && username && csrftoken ? {
                    'Authorization': 'Token ' + token,
                    'X-CSRFToken': csrftoken,
                    'Username': username
                } : {};
            }

            // Session Check
            function checkSessionOnLoad() {
                const token = localStorage.getItem('token');
                const username = localStorage.getItem('username');
                const userType = localStorage.getItem('user_type');
                if (!token || !username || !userType) {
                    console.warn('🔴 Session data missing. Redirecting...');
                    window.location.href = 'http://smarthospitalmaintain.com';
                    return;
                }
                validateUserSession();
            }

            // Validate Session
            function validateUserSession() {
                const headers = getAuthHeaders();
                if (!headers['Authorization']) {
                    console.warn('🔴 No token. Redirecting...');
                    window.location.href = 'http://smarthospitalmaintain.com';
                    return;
                }
                $.ajax({
                    url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        if (response.message !== 'Cookie is valid.') {
                            console.warn('🔴 Invalid session. Logging out...');
                            logoutUser();
                            return;
                        }
                        const prefix = response.user_type === 'Doctor' ? 'Dr. ' : '';
                        const fullName = prefix + response.name;
                        $('#logged_in_user_name, #sidebar_user_name, #welcome_user_name').text(fullName);
                        $('#sidebar_user_role').text(response.user_type === 'Doctor' ? 'Doctor' : 'Receptionist');
                        $('#timeOfDay').text(getGreetingTime());
                        fetchPatients();
                    },
                    error: function(xhr) {
                        console.error('❌ Session validation error:', xhr.responseText);
                        logoutUser();
                    }
                });
            }

            // Greeting Time
            function getGreetingTime() {
                const hours = new Date().getHours();
                return hours < 12 ? 'Morning' : hours < 18 ? 'Afternoon' : 'Evening';
            }

            // Logout
            function logoutUser() {
                const headers = getAuthHeaders();
                $.ajax({
                    url: 'http://smarthospitalmaintain.com:8000/users/logout/',
                    type: 'POST',
                    headers: headers,
                    success: function(response) {
                        console.log('✅ Logged out:', response);
                        sessionStorage.clear();
                        localStorage.clear();
                        document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        window.location.href = 'http://smarthospitalmaintain.com/';
                    },
                    error: function(xhr) {
                        console.error('❌ Logout error:', xhr.responseText);
                        Swal.fire('Error', 'Logout failed. Please try again.', 'error');
                    }
                });
            }

            // Fetch Patients
            let allPatients = [];
            function fetchPatients() {
                const headers = getAuthHeaders();
                const userType = localStorage.getItem('user_type');
                let url = 'http://smarthospitalmaintain.com:8000/patients/list/';
                if (userType === 'Doctor') {
                    const doctorId = localStorage.getItem('doctor_id') || '';
                    url += `?primary_doctor=${doctorId}`; // Filter by primary_doctor for doctors
                }
                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('✅ Patients fetched:', response);
                        allPatients = response; // Assuming response is a list of patients
                        fetchAppointmentsForPatients();
                    },
                    error: function(xhr) {
                        console.error('❌ Fetch patients error:', xhr.responseText);
                        Swal.fire('Error', 'Failed to fetch patients.', 'error');
                    }
                });
            }

            // Fetch Appointments for Patients
            function fetchAppointmentsForPatients() {
                const headers = getAuthHeaders();
                const patientIds = allPatients.map(p => p.patient_id).join(',');
                $.ajax({
                    url: `http://smarthospitalmaintain.com:8000/appointments/search/?patient_ids=${patientIds}`,
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('✅ Appointments fetched:', response);
                        allPatients = allPatients.map(patient => {
                            patient.appointments = response.appointments.filter(appt => appt.patient.patient_id === patient.patient_id);
                            return patient;
                        });
                        populatePatientsTable(allPatients);
                    },
                    error: function(xhr) {
                        console.error('❌ Fetch appointments error:', xhr.responseText);
                        Swal.fire('Error', 'Failed to fetch appointments.', 'error');
                    }
                });
            }

            // Populate Patients Table
            function populatePatientsTable(patients) {
                const tbody = $('#patientsList');
                tbody.empty();
                patients.forEach(patient => {
                    tbody.append(`
                        <tr>
                            <td>${patient.patient_id}</td>
                            <td>${patient.first_name}</td>
                            <td>${patient.last_name || 'N/A'}</td>
                            <td>${patient.age || 'N/A'}</td>
                            <td>${patient.date_of_birth || 'N/A'}</td>
                            <td>${patient.mobile_number || 'N/A'}</td>
                            <td>${patient.email || 'N/A'}</td>
                            <td><button class="btn btn-primary btn-sm view-details-btn" data-patient-id="${patient.patient_id}">View Appointments</button></td>
                        </tr>
                    `);
                });
                $('.view-details-btn').on('click', function() {
                    const patientId = $(this).data('patient-id');
                    showPatientModal(patientId);
                });
            }

            // Sorting Function
            let sortDirection = {};
            function sortTable(column) {
                sortDirection[column] = !sortDirection[column]; // Toggle direction
                const sortedPatients = [...allPatients].sort((a, b) => {
                    let valA = a[column] || '';
                    let valB = b[column] || '';
                    if (column === 'age') {
                        valA = parseInt(valA) || 0;
                        valB = parseInt(valB) || 0;
                    } else if (column === 'date_of_birth') {
                        valA = new Date(valA).getTime() || 0;
                        valB = new Date(valB).getTime() || 0;
                    } else {
                        valA = valA.toString().toLowerCase();
                        valB = valB.toString().toLowerCase();
                    }
                    return sortDirection[column] ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
                });
                populatePatientsTable(sortedPatients);
                updateSortArrows(column);
            }

            // Update Sort Arrows
            function updateSortArrows(column) {
                $('th').each(function() {
                    const th = $(this);
                    const col = th.data('sort');
                    const arrow = th.find('.sort-arrow');
                    if (col === column) {
                        arrow.text(sortDirection[column] ? '↑' : '↓');
                    } else {
                        arrow.text('');
                    }
                });
            }

            // Filter Patients
            function filterPatients() {
                const searchTerm = $('#patientFilter').val().toLowerCase();
                const filtered = allPatients.filter(patient =>
                    patient.patient_id.toLowerCase().includes(searchTerm) ||
                    patient.first_name.toLowerCase().includes(searchTerm) ||
                    (patient.last_name && patient.last_name.toLowerCase().includes(searchTerm)) ||
                    (patient.age && patient.age.toString().includes(searchTerm)) ||
                    (patient.date_of_birth && patient.date_of_birth.toLowerCase().includes(searchTerm)) ||
                    (patient.mobile_number && patient.mobile_number.toLowerCase().includes(searchTerm)) ||
                    (patient.email && patient.email.toLowerCase().includes(searchTerm))
                );
                populatePatientsTable(filtered);
            }

            // Show Patient Modal
            function showPatientModal(patientId) {
                const patient = allPatients.find(p => p.patient_id === patientId);
                if (!patient) return Swal.fire('Error', 'Patient not found.', 'error');
                const userType = localStorage.getItem('user_type');
                const doctorId = localStorage.getItem('doctor_id');
                $('#modalPatientDetails').html(`
                    <h5>${patient.first_name} ${patient.last_name || ''}</h5>
                    <table class="table table-bordered">
                        <tr><th>Patient ID</th><td>${patient.patient_id}</td></tr>
                        <tr><th>Mobile Number</th><td>${patient.mobile_number || 'N/A'}</td></tr>
                        <tr><th>Email</th><td>${patient.email || 'N/A'}</td></tr>
                        <tr><th>DOB</th><td>${patient.date_of_birth || 'N/A'}</td></tr>
                        <tr><th>Age</th><td>${patient.age || 'N/A'}</td></tr>
                        <tr><th>Illness</th><td>${patient.current_illness || 'None'}</td></tr>
                    </table>
                    <h6>Appointments</h6>
                    ${patient.appointments && patient.appointments.length ? '<table class="table table-bordered"><thead><tr><th>ID</th><th>Date</th><th>Status</th><th>Doctor</th><th>Emergency</th><th>Actions</th></tr></thead><tbody>' + patient.appointments.map(appt => `
                        <tr>
                            <td>${appt.id}</td>
                            <td>${new Date(appt.appointment_date).toLocaleString()}</td>
                            <td>${appt.status}</td>
                            <td>${appt.doctor ? `${appt.doctor.first_name} ${appt.doctor.last_name}` : 'N/A'}</td>
                            <td>${appt.is_emergency ? 'Yes' : 'No'}</td>
                            <td>
                                ${userType === 'Receptionist' || (userType === 'Doctor' && appt.doctor && appt.doctor.id === parseInt(doctorId)) ? `
                                    <button class="btn btn-primary btn-sm" onclick="viewAppointment(${appt.id})">View</button>
                                    <button class="btn btn-warning btn-sm" onclick="editAppointment(${appt.id})">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appt.id})">Cancel</button>
                                    <button class="btn btn-info btn-sm" onclick="rescheduleAppointment(${appt.id})">Reschedule</button>
                                ` : 'N/A'}
                            </td>
                        </tr>
                    `).join('') + '</tbody></table>' : '<p>No appointments.</p>'}
                `);
                $('#patientModal').modal('show');
            }

            // View Appointment
            function viewAppointment(id) {
                const appt = allPatients.flatMap(p => p.appointments || []).find(a => a.id === id);
                if (!appt) return Swal.fire('Error', 'Appointment not found.', 'error');
                Swal.fire({
                    title: 'Appointment Details',
                    html: `
                        <p><strong>ID:</strong> ${appt.id}</p>
                        <p><strong>Patient:</strong> ${appt.patient.first_name} ${appt.patient.last_name || ''}</p>
                        <p><strong>Doctor:</strong> ${appt.doctor ? `${appt.doctor.first_name} ${appt.doctor.last_name}` : 'N/A'}</p>
                        <p><strong>Date:</strong> ${new Date(appt.appointment_date).toLocaleString()}</p>
                        <p><strong>Status:</strong> ${appt.status}</p>
                        <p><strong>Notes:</strong> ${appt.notes || 'N/A'}</p>
                        <p><strong>Emergency:</strong> ${appt.is_emergency ? 'Yes' : 'No'}</p>
                        <p><strong>Created By:</strong> ${appt.created_by_username || 'N/A'}</p>
                        <p><strong>Updated By:</strong> ${appt.updated_by_username || 'N/A'}</p>
                    `,
                    icon: 'info'
                });
            }

            // Edit Appointment
            function editAppointment(id) {
                const appt = allPatients.flatMap(p => p.appointments || []).find(a => a.id === id);
                if (!appt) return Swal.fire('Error', 'Appointment not found.', 'error');
                $('#editNotes').val(appt.notes || '');
                $('#editStatus').val(appt.status);
                $('#saveEdit').off('click').on('click', function() {
                    const data = {
                        notes: $('#editNotes').val(),
                        status: $('#editStatus').val()
                    };
                    $.ajax({
                        url: `http://smarthospitalmaintain.com:8000/appointments/edit/${id}/`,
                        type: 'PATCH',
                        headers: getAuthHeaders(),
                        data: JSON.stringify(data),
                        contentType: 'application/json',
                        success: function(response) {
                            console.log('✅ Appointment updated:', response);
                            Swal.fire('Success', 'Appointment updated successfully.', 'success');
                            fetchPatients();
                            $('#editModal').modal('hide');
                        },
                        error: function(xhr) {
                            console.error('❌ Edit error:', xhr.responseText);
                            Swal.fire('Error', 'Failed to update appointment.', 'error');
                        }
                    });
                });
                $('#editModal').modal('show');
            }

            // Cancel Appointment
            function cancelAppointment(id) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, cancel it!'
                }).then(result => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `http://smarthospitalmaintain.com:8000/appointments/cancel/${id}/`,
                            type: 'PATCH',
                            headers: getAuthHeaders(),
                            data: JSON.stringify({ status: 'Canceled' }),
                            contentType: 'application/json',
                            success: function(response) {
                                console.log('✅ Appointment canceled:', response);
                                Swal.fire('Canceled', 'Appointment has been canceled.', 'success');
                                fetchPatients();
                            },
                            error: function(xhr) {
                                console.error('❌ Cancel error:', xhr.responseText);
                                Swal.fire('Error', 'Failed to cancel appointment.', 'error');
                            }
                        });
                    }
                });
            }

            // Reschedule Appointment
            function rescheduleAppointment(id) {
                Swal.fire({
                    title: 'Reschedule Appointment',
                    html: `
                        <input type="datetime-local" id="newDate" class="swal2-input" value="${new Date().toISOString().slice(0, 16)}">
                        <select id="newStatus" class="swal2-select mt-2">
                            <option value="Rescheduled">Rescheduled</option>
                            <option value="Scheduled">Scheduled</option>
                        </select>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'Reschedule',
                    preConfirm: () => {
                        const newDate = $('#newDate').val();
                        if (!newDate) return Swal.showValidationMessage('Please select a date.');
                        return { appointment_date: newDate, status: $('#newStatus').val() };
                    }
                }).then(result => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `http://smarthospitalmaintain.com:8000/appointments/reschedule/${id}/`,
                            type: 'PATCH',
                            headers: getAuthHeaders(),
                            data: JSON.stringify(result.value),
                            contentType: 'application/json',
                            success: function(response) {
                                console.log('✅ Appointment rescheduled:', response);
                                Swal.fire('Success', 'Appointment rescheduled successfully.', 'success');
                                fetchPatients();
                            },
                            error: function(xhr) {
                                console.error('❌ Reschedule error:', xhr.responseText);
                                Swal.fire('Error', 'Failed to reschedule appointment.', 'error');
                            }
                        });
                    }
                });
            }

            // Event Listeners
            $(document).ready(function() {
                checkSessionOnLoad();
                $('#logoutButton, #logoutButtonDropdown').on('click', logoutUser);
                $('#patientFilter').on('input', filterPatients);
                $('#patientsTable th[data-sort]').on('click', function() {
                    const column = $(this).data('sort');
                    sortTable(column);
                });
            });
        </script>
    </body>
</html>