<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kerala | Receptionsist </title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <!-- endinject -->
    <!-- Layout styles -->
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="assets/images/favicon.png" />
    <!-- Additional CSS for custom styling -->
    <style>
        .filter-container {
            margin-bottom: 20px;
        }
        #appointmentFilter {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
        #appointmentsTable {
            width: 100%;
        }
        #appointmentsTable th, #appointmentsTable td {
            padding: 10px;
            text-align: left;
        }
        #appointmentsTable th {
            background-color: #007bff;
            color: white;
        }
        #appointmentsTable tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        #appointmentsTable tr:hover {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container-scroller">
        <div class="row p-0 m-0 proBanner" id="proBanner">
            <div class="col-md-12 p-0 m-0">
                <div class="card-body card-body-padding d-flex align-items-center justify-content-between">
                    <div class="ps-lg-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <p class="mb-0 font-weight-medium me-3 buy-now-text">Free 24/7 customer support, updates</p>
                            <a href="" target="_blank" class="btn me-2 buy-now-btn border-0">Book Appointment</a>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <a href=""><i class="mdi mdi-home me-3 text-white"></i></a>
                        <button id="bannerClose" class="btn border-0 p-0">
                            <i class="mdi mdi-close text-white mr-0"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
                <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-stretch">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="mdi mdi-menu"></span>
                </button>
                <div class="search-field d-none d-md-block">
                    <form class="d-flex align-items-center h-100" action="#">
                        <div class="input-group">
                            <div class="input-group-prepend bg-transparent">
                                <i class="input-group-text border-0 mdi mdi-magnify"></i>
                            </div>
                            <input type="text" class="form-control bg-transparent border-0" placeholder="Search patients, appointments">
                        </div>
                    </form>
                </div>
                <ul class="navbar-nav navbar-nav-right">
                    <!-- Profile Dropdown -->
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="nav-profile-img">
                                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                                <span class="availability-status online"></span>
                            </div>
                            <div class="nav-profile-text">
                                <p class="mb-1 text-black" id="doctor-name">Dr. Placeholder Name</p>
                            </div>
                        </a>
                        <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item" href="#">
                                <i class="mdi mdi-account-circle me-2 text-success"></i> My Profile </a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#" id="logoutButton">
                                <i class="mdi mdi-logout me-2 text-primary"></i> Logout </a>
                        </div>
                    </li>
                    <!-- Messages and Notifications Dropdowns (unchanged) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-email-outline"></i>
                            <span class="count-symbol bg-warning" id="message-count">3</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
                            <h6 class="p-3 mb-0">Messages</h6>
                            <div id="message-list">
                                <p class="text-gray mb-0 text-center">No new messages</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all messages</h6>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-bell-outline"></i>
                            <span class="count-symbol bg-danger" id="notification-count">5</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                            <h6 class="p-3 mb-0">Notifications</h6>
                            <div id="notification-list">
                                <p class="text-gray mb-0 text-center">No new notifications</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all notifications</h6>
                        </div>
                    </li>
                    <li class="nav-item nav-logout d-none d-lg-block">
                        <a class="nav-link" href="#" id="logoutButton">
                            <i class="mdi mdi-power"> Logout</i>
                        </a>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                    <span class="mdi mdi-menu"></span>
                </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item nav-profile">
                        <a href="#" class="nav-link">
                            <div class="nav-profile-image">
                                <img src="assets/images/faces/face1.jpg" alt="profile" />
                                <span class="login-status online"></span>
                            </div>
                            <div class="nav-profile-text d-flex flex-column">
                                <span class="font-weight-bold mb-2">Dr. David Grey</span>
                                <span class="text-secondary text-small">Cardiologist</span>
                            </div>
                            <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <span class="menu-title">Dashboard</span>
                            <i class="mdi mdi-home menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="patients.html">
                            <span class="menu-title">Patients</span>
                            <i class="mdi mdi-account-group menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="appointments.html">
                            <span class="menu-title">Appointments</span>
                            <i class="mdi mdi-calendar-check menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
                            <span class="menu-title">Medical Records</span>
                            <i class="menu-arrow"></i>
                            <i class="mdi mdi-folder-multiple menu-icon"></i>
                        </a>
                        <div class="collapse" id="medical-records">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a class="nav-link" href="records/view-records.html">View Records</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="records/upload-records.html">Upload Records</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="prescriptions.html">
                            <span class="menu-title">Prescriptions</span>
                            <i class="mdi mdi-pill menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <span class="menu-title">Reports</span>
                            <i class="mdi mdi-chart-bar menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="lab-tests.html">
                            <span class="menu-title">Lab Tests</span>
                            <i class="mdi mdi-flask-outline menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <span class="menu-title">Settings</span>
                            <i class="mdi mdi-settings menu-icon"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">
                            <span class="page-title-icon bg-gradient-primary text-white me-2">
                                <i class="mdi mdi-calendar-check"></i>
                            </span> Appointments
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item active" aria-current="page">
                                    <span>Doctor Appointment Management <i class="mdi mdi-alert-circle-outline icon-sm text-primary align-middle"></i></span>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <div class="row">
                        <!-- Appointment Booking Section -->
                        <div class="col-md-12 grid-margin stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Appointment Search and List</h4>
                                    <!-- Filter Section -->
                                    <div class="filter-container">
                                        <input type="text" id="appointmentFilter" class="form-control" placeholder="Filter appointments by patient name, doctor, status, or date...">
                                        <select id="statusFilter" class="form-control mt-2">
                                            <option value="">All Statuses</option>
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="Active">Active</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Canceled">Canceled</option>
                                            <option value="Rescheduled">Rescheduled</option>
                                            <option value="Waiting">Waiting</option>
                                            <option value="Pending">Pending</option>
                                        </select>
                                        <input type="date" id="dateFilter" class="form-control mt-2" placeholder="Filter by date">
                                    </div>
                                    <!-- Appointments Table -->
                                    <div class="table-responsive">
                                        <table class="table" id="appointmentsTable">
                                            <thead>
                                                <tr>
                                                    <th>#</th>
                                                    <th>Patient Name</th>
                                                    <th>Doctor</th>
                                                    <th>Date & Time</th>
                                                    <th>Status</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="appointmentsList">
                                                <!-- Appointments will be dynamically inserted here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- content-wrapper ends -->
                <!-- partial:partials/_footer.html -->
                <footer class="footer">
                    <div class="d-sm-flex justify-content-center justify-content-sm-between">
                        <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2025 <a href="https://www.kerala.com/" target="_blank">Kerala. All rights reserved.</span>
                        <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
                    </div>
                </footer>
                <!-- partial -->
            </div>
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>
    <!-- container-scroller -->

    <!-- plugins:js -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <!-- endinject -->
    <!-- Plugin js for this page -->
    <script src="assets/vendors/chart.js/chart.umd.js"></script>
    <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <!-- End plugin js for this page -->
    <!-- inject:js -->
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <!-- endinject -->
    <!-- Custom js for this page -->
    <script src="assets/js/dashboard.js"></script>
    <!-- End custom js for this page -->

    <script>
        // Function to retrieve authentication headers
        function getAuthHeaders() {
            const token = sessionStorage.getItem('token') || localStorage.getItem('token');
            const username = sessionStorage.getItem('username') || localStorage.getItem('username');
            const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken');
            
            if (token && username && csrftoken) {
                return {
                    'Authorization': 'Token ' + token,
                    'X-CSRFToken': csrftoken,
                    'Username': username
                };
            }
            console.warn('Missing authentication details.');
            return {};
        }

        // Function to check session data on page load
        function checkSessionOnLoad() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            const userType = localStorage.getItem('user_type');

            if (!token || !username || !userType) {
                console.warn('🔴 Session data missing or invalid. Redirecting...');
                window.location.href = 'http://smarthospitalmaintain.com';
                return;
            }

            console.log('🟢 Session data exists. Validating session...');
            validateUserSession();
        }

        // Validate user session
        function validateUserSession() {
            const headers = getAuthHeaders();

            if (!headers['Authorization']) {
                console.warn('🔴 No valid token. User is not authenticated.');
                window.location.href = 'http://smarthospitalmaintain.com';
                return;
            }

            $.ajax({
                url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
                type: 'GET',
                headers: headers,
                success: function(response) {
                    console.log('🟢 Session validation success:', response);

                    if (response.message !== 'Cookie is valid.') {
                        console.warn('🔴 Invalid session. Logging out...');
                        alert('Invalid session. Logging out.');
                        attemptLogout();
                    } else {
                        // Update navigation bar with user details
                        document.getElementById("logged_in_user_name").textContent = response.name;
                        document.getElementById("timeOfDay").textContent = getGreetingTime();
                        fetchAppointments(); // Fetch appointments after session validation
                    }
                },
                error: function(xhr, status, error) {
                    console.error('❌ Error validating session:', xhr.responseText);
                    attemptLogout();
                }
            });
        }

        // Attempt to logout and handle failures
        function attemptLogout() {
            logoutUser();

            setTimeout(function() {
                if (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) {
                    console.warn('🔴 Logout failed! Forcing session cleanup.');
                    forceLogout();
                }
            }, 3000);
        }

        // Force logout by clearing session data and redirecting
        function forceLogout() {
            sessionStorage.clear();
            localStorage.clear();
            document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            console.log('🔄 Redirecting to landing page after forced logout...');
            window.location.href = 'http://smarthospitalmaintain.com/';
        }

        // Function to get time of day greeting
        function getGreetingTime() {
            const hours = new Date().getHours();
            if (hours < 12) return "Morning";
            else if (hours < 18) return "Afternoon";
            else return "Evening";
        }

        // Logout function
        function logoutUser() {
            const headers = getAuthHeaders();

            if (!headers['Authorization']) {
                console.error('No authentication token. Redirecting to login...');
                window.location.href = 'http://smarthospitalmaintain.com/';
                return;
            }

            $.ajax({
                url: 'http://smarthospitalmaintain.com:8000/users/logout/',
                type: 'POST',
                headers: headers,
                success: function(response) {
                    console.log('User logged out successfully:', response);
                    sessionStorage.clear();
                    localStorage.clear();
                    document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                    window.location.href = 'http://smarthospitalmaintain.com/';
                },
                error: function(xhr, status, error) {
                    console.error('Logout error:', xhr.responseText);
                }
            });
        }

        // Attach logout event
        $(document).ready(function() {
            $('#logoutButton').on('click', function(event) {
                event.preventDefault();
                logoutUser();
            });
        });

        // Function to fetch appointments with role-based restrictions
        function fetchAppointments(status = 'Scheduled') {
            const headers = getAuthHeaders();
            const userType = localStorage.getItem('user_type');

            $.ajax({
                url: `http://smarthospitalmaintain.com:8000/appointments/list/?status=${encodeURIComponent(status)}`,
                type: 'GET',
                headers: headers,
                success: function(response) {
                    console.log('Appointments fetched:', response);
                    let appointments = response.appointments || [];
                    populateAppointmentsTable(appointments);
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching appointments:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch appointments. Please try again.'
                    });
                }
            });
        }

        // Function to populate appointments table
        function populateAppointmentsTable(appointments) {
            const appointmentsList = document.getElementById("appointmentsList");
            appointmentsList.innerHTML = "";

            appointments.forEach((appointment, index) => {
                const row = document.createElement("tr");
                const patientName = `${appointment.patient.first_name} ${appointment.patient.last_name}`;
                const doctorName = appointment.doctor ? `${appointment.doctor.first_name} ${appointment.doctor.last_name}` : "Not Assigned";
                const dateTime = new Date(appointment.appointment_date).toLocaleString();

                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${patientName}</td>
                    <td>${doctorName}</td>
                    <td>${dateTime}</td>
                    <td>${appointment.status}</td>
                    <td>${appointment.notes || "N/A"}</td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewAppointmentDetails(${appointment.id})">View</button>
                        <button class="btn btn-warning btn-sm ms-2" onclick="editAppointment(${appointment.id})">Edit</button>
                        <button class="btn btn-danger btn-sm ms-2" onclick="cancelAppointment(${appointment.id})">Cancel</button>
                        <button class="btn btn-info btn-sm ms-2" onclick="rescheduleAppointment(${appointment.id})">Reschedule</button>
                    </td>
                `;
                appointmentsList.appendChild(row);
            });
        }

        // Function to filter appointments
        function filterAppointments() {
            const searchTerm = document.getElementById('appointmentFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            fetchAppointments().then(appointments => {
                let filteredAppointments = appointments;

                if (searchTerm) {
                    filteredAppointments = filteredAppointments.filter(appointment => 
                        `${appointment.patient.first_name} ${appointment.patient.last_name}`.toLowerCase().includes(searchTerm) ||
                        (appointment.doctor && `${appointment.doctor.first_name} ${appointment.doctor.last_name}`.toLowerCase().includes(searchTerm)) ||
                        appointment.status.toLowerCase().includes(searchTerm) ||
                        new Date(appointment.appointment_date).toLocaleString().toLowerCase().includes(searchTerm)
                    );
                }

                if (statusFilter) {
                    filteredAppointments = filteredAppointments.filter(appointment => 
                        appointment.status === statusFilter
                    );
                }

                if (dateFilter) {
                    const filterDate = new Date(dateFilter);
                    filteredAppointments = filteredAppointments.filter(appointment => {
                        const appointmentDate = new Date(appointment.appointment_date);
                        return appointmentDate.toDateString() === filterDate.toDateString();
                    });
                }

                populateAppointmentsTable(filteredAppointments);
            });
        }

        // Add event listeners for filters
        document.getElementById('appointmentFilter').addEventListener('input', filterAppointments);
        document.getElementById('statusFilter').addEventListener('change', filterAppointments);
        document.getElementById('dateFilter').addEventListener('change', filterAppointments);

        // Function to view appointment details (example, can be expanded)
        function viewAppointmentDetails(appointmentId) {
            const headers = getAuthHeaders();
            $.ajax({
                url: `http://smarthospitalmaintain.com:8000/appointments/list/?appointment_id=${appointmentId}`,
                type: 'GET',
                headers: headers,
                success: function(response) {
                    if (response.appointments && response.appointments.length > 0) {
                        const appointment = response.appointments[0];
                        Swal.fire({
                            title: 'Appointment Details',
                            html: `
                                <p><strong>Patient:</strong> ${appointment.patient.first_name} ${appointment.patient.last_name}</p>
                                <p><strong>Doctor:</strong> ${appointment.doctor ? `${appointment.doctor.first_name} ${appointment.doctor.last_name}` : "Not Assigned"}</p>
                                <p><strong>Date & Time:</strong> ${new Date(appointment.appointment_date).toLocaleString()}</p>
                                <p><strong>Status:</strong> ${appointment.status}</p>
                                <p><strong>Notes:</strong> ${appointment.notes || "N/A"}</p>
                            `,
                            icon: 'info',
                            confirmButtonText: 'Close'
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Appointment not found.'
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error fetching appointment details:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'Failed to fetch appointment details. Please try again.'
                    });
                }
            });
        }

        // Function to edit appointment (example, can be expanded)
        function editAppointment(appointmentId) {
            Swal.fire({
                title: 'Edit Appointment',
                html: `
                    <input type="text" id="editNotes" class="swal2-input" placeholder="Notes">
                    <select id="editStatus" class="swal2-select">
                        <option value="Scheduled">Scheduled</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Canceled">Canceled</option>
                        <option value="Rescheduled">Rescheduled</option>
                        <option value="Waiting">Waiting</option>
                        <option value="Pending">Pending</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Save',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const notes = document.getElementById('editNotes').value;
                    const status = document.getElementById('editStatus').value;
                    return { notes, status };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const headers = getAuthHeaders();
                    $.ajax({
                        url: `http://smarthospitalmaintain.com:8000/appointments/edit/${appointmentId}/`,
                        type: 'PATCH',
                        headers: headers,
                        data: JSON.stringify(result.value),
                        contentType: 'application/json',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Appointment updated successfully.'
                            });
                            fetchAppointments(); // Refresh the list
                        },
                        error: function(xhr, status, error) {
                            console.error('Error editing appointment:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to update appointment. Please try again.'
                            });
                        }
                    });
                }
            });
        }

        // Function to cancel appointment
        function cancelAppointment(appointmentId) {
            Swal.fire({
                title: 'Are you sure?',
                text: "You won't be able to revert this!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, cancel it!'
            }).then((result) => {
                if (result.isConfirmed) {
                    const headers = getAuthHeaders();
                    $.ajax({
                        url: `http://smarthospitalmaintain.com:8000/appointments/cancel/${appointmentId}/`,
                        type: 'PATCH',
                        headers: headers,
                        data: JSON.stringify({ status: "Canceled" }),
                        contentType: 'application/json',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Canceled',
                                text: 'Appointment has been canceled.'
                            });
                            fetchAppointments(); // Refresh the list
                        },
                        error: function(xhr, status, error) {
                            console.error('Error canceling appointment:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to cancel appointment. Please try again.'
                            });
                        }
                    });
                }
            });
        }

        // Function to reschedule appointment
        function rescheduleAppointment(appointmentId) {
            Swal.fire({
                title: 'Reschedule Appointment',
                html: `
                    <input type="datetime-local" id="newAppointmentDate" class="swal2-input" placeholder="New Date & Time">
                    <select id="newStatus" class="swal2-select mt-2">
                        <option value="Rescheduled">Rescheduled</option>
                        <option value="Scheduled">Scheduled</option>
                    </select>
                `,
                showCancelButton: true,
                confirmButtonText: 'Reschedule',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const newDate = document.getElementById('newAppointmentDate').value;
                    const status = document.getElementById('newStatus').value;
                    if (!newDate) {
                        Swal.showValidationMessage('Please enter a new date and time');
                        return false;
                    }
                    return { appointment_date: newDate, status };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const headers = getAuthHeaders();
                    $.ajax({
                        url: `http://smarthospitalmaintain.com:8000/appointments/reschedule/${appointmentId}/`,
                        type: 'PATCH',
                        headers: headers,
                        data: JSON.stringify(result.value),
                        contentType: 'application/json',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Appointment rescheduled successfully.'
                            });
                            fetchAppointments(); // Refresh the list
                        },
                        error: function(xhr, status, error) {
                            console.error('Error rescheduling appointment:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Failed to reschedule appointment. Please try again.'
                            });
                        }
                    });
                }
            });
        }

        // Run session check and fetch appointments on page load
        document.addEventListener("DOMContentLoaded", function () {
            checkSessionOnLoad();
        });
    </script>
</body>
</html>