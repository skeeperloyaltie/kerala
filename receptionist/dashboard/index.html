<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kerala | Receptionist</title>

  <!-- CSS -->
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="shortcut icon" href="assets/images/favicon.png">

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>

  <style>
    .tab-pane {
      display: none;
  }
  .tab-pane.show {
      display: block;
  }
  #appointmentFormContainer {
      position: relative;
      z-index: 10;
  }
   /* Table Styles */
   .table-responsive {
    max-height: 400px;
    overflow-y: auto;
    position: relative;
  }
  .table {
    table-layout: auto;
    width: 100%;
    border-collapse: collapse;
  }
  .table th, .table td {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 14px;
    padding: 8px;
    text-align: left;
  }
  .table thead th {
    position: sticky;
    top: 0;
    background-color: #fff;
    z-index: 1;
  }
  .table .btn {
    font-size: 12px;
    padding: 5px 8px;
    margin: 2px;
  }
  
    /* Search Filter */
    .search-filter {
      margin-bottom: 15px;
    }
    .search-filter input, .search-filter select {
      font-size: 14px;
      padding: 6px;
    }

    /* Notification Styling */
    .custom-notification {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 15px 30px;
      border-radius: 5px;
      font-size: 16px;
      text-align: center;
      z-index: 9999;
      min-width: 250px;
      max-width: 400px;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
    }
    @keyframes fadeInOut {
      0% { opacity: 0; }
      20% { opacity: 1; }
      80% { opacity: 1; }
      100% { opacity: 0; }
    }

    /* Modal Styles */
    .modal-content {
      padding: 20px;
      border-radius: 5px;
    }
    .close-btn {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .close-btn:hover, .close-btn:focus {
      color: black;
      text-decoration: none;
    }
    .success-message { color: green; }
    .error-message { color: red; }

    /* Responsive Adjustments */
    @media (max-width: 768px) {
      .table th, .table td { font-size: 12px; padding: 6px; }
      .table .btn { font-size: 10px; padding: 4px 6px; }
      .search-filter input, .search-filter select { font-size: 12px; }
    }
    @media (max-width: 480px) {
      .table th, .table td { font-size: 10px; padding: 4px; }
      .table .btn { font-size: 9px; padding: 3px 5px; }
    }
  </style>

  <script>
    // CSRF and Auth Functions
    function getCSRFToken() {
      const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
      return csrfTokenMeta ? csrfTokenMeta.getAttribute('content') : (document.cookie.match(/csrftoken=([^;]+)/) ? document.cookie.match(/csrftoken=([^;]+)/)[1] : null);
    }
    function getAuthHeaders() {
      const token = sessionStorage.getItem('token') || localStorage.getItem('token');
      const username = sessionStorage.getItem('username') || localStorage.getItem('username');
      const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken');
      if (token && username && csrftoken) {
        return {
          'Authorization': 'Token ' + token,
          'X-CSRFToken': csrftoken,
          'Username': username
        };
      }
      console.warn('Missing authentication details.');
      return {};
    }
  </script>
</head>
<body>
  <div class="container-scroller">
    <!-- Navbar -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
        <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="mdi mdi-menu"></span>
        </button>
        <div class="search-field d-none d-md-block">
          <form class="d-flex align-items-center h-100">
            <div class="input-group">
              <div class="input-group-prepend bg-transparent">
                <i class="input-group-text border-0 mdi mdi-magnify"></i>
              </div>
              <input type="text" class="form-control bg-transparent border-0" placeholder="Search patients, appointments">
            </div>
          </form>
        </div>
        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item nav-profile dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="profileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="nav-profile-img">
                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                <span class="availability-status online"></span>
              </div>
              <div class="nav-profile-text">
                <p class="mb-1 text-black"><span id="logged_in_user_name"></span></p>
              </div>
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" href="#" id="messageDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="mdi mdi-email-outline"></i>
              <span class="count-symbol bg-warning" id="message-count">3</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
              <h6 class="p-3 mb-0">Messages</h6>
              <div id="message-list"><p class="text-gray mb-0 text-center">No new messages</p></div>
              <div class="dropdown-divider"></div>
              <h6 class="p-3 mb-0 text-center">See all messages</h6>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" href="#" id="notificationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="mdi mdi-bell-outline"></i>
              <span class="count-symbol bg-danger" id="notification-count">5</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
              <h6 class="p-3 mb-0">Notifications</h6>
              <div id="notification-list"><p class="text-gray mb-0 text-center">No new notifications</p></div>
              <div class="dropdown-divider"></div>
              <h6 class="p-3 mb-0 text-center">See all notifications</h6>
            </div>
          </li>
          <li class="nav-item nav-logout d-none d-lg-block">
            <button class="btn btn-sm btn-danger" id="logoutButton"><i class="mdi mdi-power"></i> Logout</button>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-bs-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>

    <!-- Sidebar -->
    <div class="container-fluid page-body-wrapper">
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item nav-profile">
            <a href="#" class="nav-link">
              <div class="nav-profile-image">
                <img src="assets/images/faces/face1.jpg" alt="profile">
                <span class="login-status online"></span>
              </div>
              <div class="nav-profile-text d-flex flex-column">
                <span class="font-weight-bold mb-2" id="logged_in_user_name_sidebar"></span>
                <span class="text-secondary text-small" id="logged_in_user_role"></span>
              </div>
              <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
            </a>
          </li>
          <li class="nav-item"><a class="nav-link" href="index.html"><span class="menu-title">Dashboard</span><i class="mdi mdi-home menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="patients.html"><span class="menu-title">Patients</span><i class="mdi mdi-account-group menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="appointments.html"><span class="menu-title">Appointments</span><i class="mdi mdi-calendar-check menu-icon"></i></a></li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
              <span class="menu-title">Medical Records</span><i class="menu-arrow"></i><i class="mdi mdi-folder-multiple menu-icon"></i>
            </a>
            <div class="collapse" id="medical-records">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"><a class="nav-link" href="records/view-records.html">View Records</a></li>
                <li class="nav-item"><a class="nav-link" href="records/upload-records.html">Upload Records</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="prescriptions.html"><span class="menu-title">Prescriptions</span><i class="mdi mdi-pill menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="reports.html"><span class="menu-title">Reports</span><i class="mdi mdi-chart-bar menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="lab-tests.html"><span class="menu-title">Lab Tests</span><i class="mdi mdi-flask-outline menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="settings.html"><span class="menu-title">Settings</span><i class="mdi mdi-settings menu-icon"></i></a></li>
        </ul>
      </nav>

      <!-- Main Content -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">
              <span class="page-title-icon bg-gradient-primary text-white me-2"><i class="mdi mdi-home"></i></span> Dashboard
            </h3>
            <nav aria-label="breadcrumb">
              <ul class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">
                  Welcome, <span id="logged_in_user_name_breadcrumb"></span> - Good <span id="timeOfDay">Morning</span>
                </li>
              </ul>
            </nav>
          </div>

          <!-- Notification -->
          <div id="customNotification" class="custom-notification">
            <p id="notificationMessage"></p>
          </div>

          <!-- Message Modal -->
          <div id="messageModal" class="modal fade" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <span class="close-btn" data-bs-dismiss="modal">×</span>
                <p id="modalMessage">This is a message!</p>
              </div>
            </div>
          </div>

          <!-- Tabbed Table Section -->
          <div class="row">
            <div class="col-md-12 stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Current Patient Details & Appointments</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <div>
                      <button class="btn btn-success btn-sm d-none me-2" id="cancelBtn" onclick="bulkCancel()">Cancel</button>
                      <button class="btn btn-warning btn-sm d-none" id="rescheduleBtn" onclick="bulkReschedule()">Reschedule</button>
                     </div>
                    <button class="btn btn-primary btn-sm"><a href="search.html" class="text-white text-decoration-none">Search Patient</a></button>
                  </div>

                  <!-- Search Filter -->
                  <div class="search-filter row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control" id="searchPatientId" placeholder="Patient ID">
                    </div>
                    <div class="col-md-3">
                      <input type="text" class="form-control" id="searchName" placeholder="Patient Name">
                    </div>
                    <div class="col-md-2">
                      <input type="number" class="form-control" id="searchAge" placeholder="Age">
                    </div>
                    <div class="col-md-2">
                      <input type="date" class="form-control" id="searchDob" placeholder="Date of Birth">
                    </div>
                    <div class="col-md-2">
                      <input type="date" class="form-control" id="searchDate" placeholder="Appointment Date">
                    </div>
                  </div>

                  <!-- Tabs -->
                  <ul class="nav nav-tabs" id="appointmentTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="waiting-tab" data-bs-toggle="tab" href="#waiting" role="tab">Waiting in Clinic</a></li>
                    <li class="nav-item"><a class="nav-link" id="scheduled-tab" data-bs-toggle="tab" href="#scheduled" role="tab">Scheduled</a></li>
                    <li class="nav-item"><a class="nav-link" id="pending-tab" data-bs-toggle="tab" href="#pending" role="tab">Pending</a></li>
                    <li class="nav-item"><a class="nav-link" id="active-tab" data-bs-toggle="tab" href="#active" role="tab">Active</a></li>
                    <li class="nav-item"><a class="nav-link" id="completed-tab" data-bs-toggle="tab" href="#completed" role="tab">Completed</a></li>
                    <li class="nav-item"><a class="nav-link" id="canceled-tab" data-bs-toggle="tab" href="#canceled" role="tab">Canceled</a></li>
                    <li class="nav-item"><a class="nav-link" id="rescheduled-tab" data-bs-toggle="tab" href="#rescheduled" role="tab">Rescheduled</a></li>
                  </ul>

                  <!-- Tab Content -->
                  <div class="tab-content mt-3" id="appointmentTabContent">
                    <div class="tab-pane fade show active" id="waiting" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Waiting-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="scheduled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Scheduled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="pending" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Pending-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="active" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Active-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Completed-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="canceled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Canceled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="rescheduled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Rescheduled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Create Patient Modal -->
<div class="modal fade" id="createPatientModal" tabindex="-1" aria-labelledby="createPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPatientModalLabel">Create New Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createPatientForm">
          <!-- Basic Information -->
          <h6>Basic Information</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="patientFirstName">First Name <span class="text-danger">*</span></label>
              <input type="text" id="patientFirstName" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="patientLastName">Last Name <span class="text-danger">*</span></label>
              <input type="text" id="patientLastName" class="form-control" required>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="patientGender">Gender <span class="text-danger">*</span></label>
              <select id="patientGender" class="form-control" required>
                <option value="" disabled selected>Select Gender</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientDob">Date of Birth <span class="text-danger">*</span></label>
              <input type="date" id="patientDob" class="form-control" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientAge">Age <span class="text-danger">*</span></label>
              <input type="number" id="patientAge" class="form-control" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="patientFatherName">Father's Name <span class="text-danger">*</span></label>
              <input type="text" id="patientFatherName" class="form-control" required>
            </div>
            <div class="col-md-6 mb-3">
              <label for="patientAddress">Address</label>
              <input type="text" id="patientAddress" class="form-control">
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="patientCity">City</label>
              <input type="text" id="patientCity" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientPincode">Pincode</label>
              <input type="number" id="patientPincode" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientEmail">Email Address</label>
              <input type="email" id="patientEmail" class="form-control">
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="patientMobile">Mobile Number <span class="text-danger">*</span></label>
              <input type="tel" id="patientMobile" class="form-control" required>
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientAltMobile">Alternate Mobile Number</label>
              <input type="tel" id="patientAltMobile" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="patientAadhar">Aadhar Number</label>
              <input type="text" id="patientAadhar" class="form-control" maxlength="12" pattern="\d{12}">
            </div>
          </div>

          <!-- Medical Information -->
          <h6>Medical Information</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="patientBloodGroup">Blood Group</label>
              <select id="patientBloodGroup" class="form-control">
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
            <div class="col-md-8 mb-3">
              <label for="patientAllergies">Known Allergies</label>
              <textarea id="patientAllergies" class="form-control"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="patientMedications">Current Medications</label>
              <textarea id="patientMedications" class="form-control"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label for="patientPastHistory">Past Medical History</label>
              <textarea id="patientPastHistory" class="form-control"></textarea>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="patientNotes">Specific Notes</label>
              <textarea id="patientNotes" class="form-control"></textarea>
            </div>
            <div class="col-md-6 mb-3">
              <label for="patientPrimaryDoctor">Primary Doctor Assigned</label>
              <select id="patientPrimaryDoctor" class="form-control">
                <option value="" disabled selected>Select a doctor</option>
              </select>
            </div>
          </div>

          <!-- Emergency Contact -->
          <h6>Emergency Contact</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="emergencyName">Emergency Contact Name</label>
              <input type="text" id="emergencyName" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="emergencyRelation">Relationship to Patient</label>
              <input type="text" id="emergencyRelation" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="emergencyNumber">Emergency Contact Number</label>
              <input type="tel" id="emergencyNumber" class="form-control">
            </div>
          </div>

          <!-- Insurance & Billing Details -->
          <h6>Insurance & Billing Details</h6>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="insuranceProvider">Insurance Provider Name</label>
              <input type="text" id="insuranceProvider" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="policyNumber">Policy Number</label>
              <input type="text" id="policyNumber" class="form-control">
            </div>
            <div class="col-md-4 mb-3">
              <label for="paymentPreference">Payment Preferences</label>
              <select id="paymentPreference" class="form-control">
                <option value="">Select Preference</option>
                <option value="Cash">Cash</option>
                <option value="Card">Card</option>
                <option value="Insurance">Insurance</option>
              </select>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="savePatient()">Save Patient</button>
      </div>
    </div>
  </div>
</div>

   <!-- Appointment Form -->
<div id="appointmentFormContainer" class="card mt-3" style="display: none;">
  <div class="card-body">
    <h5 class="card-title">Create New Appointment</h5>
    <form id="appointmentForm">
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="patientID">Patient ID <span class="text-danger">*</span></label>
          <div class="input-group">
            <input type="text" id="patientID" class="form-control" placeholder="Enter Patient ID" required>
            <button type="button" class="btn btn-outline-primary" onclick="$('#createPatientModal').modal('show')">Add Patient</button>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <label for="firstName">First Name</label>
          <input type="text" id="firstName" class="form-control" readonly>
        </div>
        <div class="col-md-4 mb-3">
          <label for="lastName">Last Name</label>
          <input type="text" id="lastName" class="form-control" readonly>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="contactNumber">Contact Number</label>
          <input type="tel" id="contactNumber" class="form-control" readonly>
        </div>
        <div class="col-md-4 mb-3">
          <label for="dateOfBirth">Date of Birth</label>
          <input type="date" id="dateOfBirth" class="form-control" readonly>
        </div>
        <div class="col-md-4 mb-3">
          <label for="age">Age</label>
          <input type="number" id="age" class="form-control" readonly>
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="appointmentDate">Appointment Date <span class="text-danger">*</span></label>
          <input type="datetime-local" id="appointmentDate" class="form-control" required>
        </div>
        <div class="col-md-4 mb-3">
          <label for="doctor">Doctor <span class="text-danger">*</span></label>
          <select id="doctor" class="form-control" required>
            <option value="" disabled selected>Select a doctor</option>
          </select>
        </div>
        <div class="col-md-4 mb-3">
          <label for="notes">Notes</label>
          <input type="text" id="notes" class="form-control">
        </div>
      </div>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label for="currentIllness">Current Illness</label>
          <input type="text" id="currentIllness" class="form-control">
        </div>
      </div>
      <div class="mt-3">
        <button type="button" class="btn btn-success" onclick="addAppointment()">Next</button>
        <button type="button" class="btn btn-danger" onclick="hideAppointmentForm()">Cancel</button>
      </div>
    </form>
  </div>
</div>

         <!-- Vitals Modal -->
<div class="modal fade" id="vitalsModal" tabindex="-1" aria-labelledby="vitalsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="vitalsModalLabel">Enter Patient Vitals</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="vitalsForm">
          <div class="mb-3">
            <label for="modalBloodPressure">Blood Pressure</label>
            <div class="input-group">
              <input type="text" id="modalBloodPressure" class="form-control" placeholder="e.g., 120/80">
              <select class="form-select unit-select" data-input="modalBloodPressure">
                <option value="mmHg">mmHg</option>
                <option value="kPa">kPa</option>
              </select>
              <button type="button" class="btn btn-outline-secondary convert-btn" data-input="modalBloodPressure">Convert</button>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalHeartRate">Heart Rate</label>
            <div class="input-group">
              <input type="text" id="modalHeartRate" class="form-control" placeholder="e.g., 70">
              <span class="input-group-text">bpm</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalTemperature">Temperature</label>
            <div class="input-group">
              <input type="text" id="modalTemperature" class="form-control" placeholder="e.g., 37">
              <select class="form-select unit-select" data-input="modalTemperature">
                <option value="°C">°C</option>
                <option value="°F">°F</option>
              </select>
              <button type="button" class="btn btn-outline-secondary convert-btn" data-input="modalTemperature">Convert</button>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalRespiratoryRate">Respiratory Rate</label>
            <div class="input-group">
              <input type="text" id="modalRespiratoryRate" class="form-control" placeholder="e.g., 16">
              <span class="input-group-text">breaths/min</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalOxygenSaturation">Oxygen Saturation</label>
            <div class="input-group">
              <input type="text" id="modalOxygenSaturation" class="form-control" placeholder="e.g., 98">
              <span class="input-group-text">%</span>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalWeight">Weight</label>
            <div class="input-group">
              <input type="text" id="modalWeight" class="form-control" placeholder="e.g., 70">
              <select class="form-select unit-select" data-input="modalWeight">
                <option value="kg">kg</option>
                <option value="lbs">lbs</option>
              </select>
              <button type="button" class="btn btn-outline-secondary convert-btn" data-input="modalWeight">Convert</button>
            </div>
          </div>
          <div class="mb-3">
            <label for="modalHeight">Height</label>
            <div class="input-group">
              <input type="text" id="modalHeight" class="form-control" placeholder="e.g., 170">
              <select class="form-select unit-select" data-input="modalHeight">
                <option value="cm">cm</option>
                <option value="in">in</option>
              </select>
              <button type="button" class="btn btn-outline-secondary convert-btn" data-input="modalHeight">Convert</button>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="saveVitals()">Save Vitals</button>
      </div>
    </div>
  </div>
</div>

          <!-- Edit Appointment Modal -->
          <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editAppointmentModalLabel">Edit Appointment</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="editAppointmentForm">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAppointmentID">Appointment ID</label>
                        <input type="text" id="editAppointmentID" class="form-control" readonly>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editPatientID">Patient ID</label>
                        <input type="text" id="editPatientID" class="form-control" readonly>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" class="form-control" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" class="form-control" required>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editContactNumber">Contact Number</label>
                        <input type="tel" id="editContactNumber" class="form-control" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editDateOfBirth">Date of Birth</label>
                        <input type="date" id="editDateOfBirth" class="form-control" required>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAge">Age</label>
                        <input type="number" id="editAge" class="form-control" readonly>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editCurrentIllness">Current Illness</label>
                        <input type="text" id="editCurrentIllness" class="form-control">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAppointmentDate">Appointment Date</label>
                        <input type="datetime-local" id="editAppointmentDate" class="form-control" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editDoctor">Doctor</label>
                        <select id="editDoctor" class="form-control" required>
                          <option value="" disabled selected>Select a doctor</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-12 mb-3">
                        <label for="editNotes">Notes</label>
                        <textarea id="editNotes" class="form-control"></textarea>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-12 mb-3">
                        <label for="editAppointmentStatus">Status</label>
                        <select id="editAppointmentStatus" class="form-control">
                          <option value="Waiting">Waiting</option>
                          <option value="Scheduled">Scheduled</option>
                          <option value="Pending">Pending</option>
                          <option value="Active">Active</option>
                          <option value="Completed">Completed</option>
                          <option value="Canceled">Canceled</option>
                          <option value="Rescheduled">Rescheduled</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-check mb-3">
                      <input type="checkbox" id="editIsEmergency" class="form-check-input">
                      <label for="editIsEmergency" class="form-check-label">Is this an emergency?</label>
                    </div>
                    <div class="mt-3">
                      <button type="button" class="btn btn-success" onclick="updateAppointment()">Save Changes</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Reschedule Modal -->
          <div class="modal fade" id="rescheduleAppointmentModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="rescheduleModalLabel">Reschedule Appointment</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="rescheduleForm">
                    <input type="hidden" id="rescheduleAppointmentID">
                    <div class="mb-3">
                      <label for="newAppointmentDate">New Date & Time</label>
                      <input type="datetime-local" class="form-control" id="newAppointmentDate" required>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" onclick="rescheduleAppointment()">Confirm Reschedule</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
          <div class="d-sm-flex justify-content-center justify-content-sm-between">
            <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2025 <a href="" target="_blank">Kerala. All rights reserved.</a></span>
            <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
          </div>
        </footer>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    // Modal Handling
    const modal = document.getElementById("messageModal");
    const closeBtn = document.querySelector(".close-btn");
    const modalMessage = document.getElementById("modalMessage");

    function showModal(message, type) {
      modalMessage.textContent = message;
      modalMessage.classList.toggle("success-message", type === 'success');
      modalMessage.classList.toggle("error-message", type === 'error');
      modal.classList.add("show");
      modal.style.display = "block";
    }

    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; };

   // Modified appointment form visibility functions
function showAppointmentForm() {
  $("#appointmentFormContainer").show();
  // Hide all tab contents except the form
  $(".tab-pane").removeClass("show active");
  $("#appointmentTabs .nav-link").removeClass("active");
}

function hideAppointmentForm() {
  $("#appointmentFormContainer").hide();
  $("#appointmentForm")[0].reset();
  $("#appointmentForm .form-control").removeClass("is-invalid");
  // Restore the previously active tab
  var activeTab = localStorage.getItem("activeTab") || "#waiting";
  $(`#appointmentTabs a[href="${activeTab}"]`).tab("show");
}

    // Date Restrictions
    document.getElementById("dateOfBirth").setAttribute("max", new Date().toISOString().split("T")[0]);
    let now = new Date();
    let formattedNow = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
    document.getElementById("appointmentDate").setAttribute("min", formattedNow);

    // Age Calculation
    $("#dateOfBirth, #editDateOfBirth").on("change", function() {
      const dob = new Date(this.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
      $(this.id === "dateOfBirth" ? "#age" : "#editAge").val(age >= 0 ? age : "");
    });

    // Search Filter Logic
    function filterTable() {
      const patientId = $("#searchPatientId").val().toLowerCase();
      const name = $("#searchName").val().toLowerCase();
      const age = $("#searchAge").val();
      const dob = $("#searchDob").val();
      const date = $("#searchDate").val();

      $(".tab-pane tbody tr").each(function() {
        const row = $(this);
        const rowPatientId = row.find("td:nth-child(3)").text().toLowerCase();
        const rowName = row.find("td:nth-child(4)").text().toLowerCase();
        const rowAge = row.find("td:nth-child(5)").text();
        const rowDob = row.find("td:nth-child(6)").text(); // Assuming DOB is populated
        const rowDate = row.find("td:nth-child(8)").text(); // Appointment date

        const matches = (!patientId || rowPatientId.includes(patientId)) &&
                       (!name || rowName.includes(name)) &&
                       (!age || rowAge === age) &&
                       (!dob || rowDob.includes(dob)) &&
                       (!date || rowDate.includes(date));
        row.toggle(matches);
      });
    }

    $("#searchPatientId, #searchName, #searchAge, #searchDob, #searchDate").on("input change", filterTable);
  </script>

  <!-- Existing JavaScript (unchanged functionality) -->
  <script src="assets/vendors/js/vendor.bundle.base.js"></script>
  <script src="assets/vendors/chart.js/chart.umd.js"></script>
  <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
  <script src="assets/js/off-canvas.js"></script>
  <script src="assets/js/misc.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/todolist.js"></script>
  <script src="assets/js/jquery.cookie.js"></script>
  <script src="assets/js/dashboard.js"></script>

  <!-- Inline Scripts (Moved from body for organization) -->
  <script>

    // Utility function to format error messages from server responses
function getErrorMessage(xhrOrError, defaultMessage) {
    let message = defaultMessage;
    if (xhrOrError.responseJSON) {
        const response = xhrOrError.responseJSON;
        if (response.detail) {
            message = response.detail; // Standard Django REST Framework error
        } else if (response.error) {
            message = response.error; // Custom error field
        } else if (response.non_field_errors) {
            message = response.non_field_errors.join(", "); // Form validation errors
        } else {
            message = JSON.stringify(response); // Fallback to raw response
        }
    } else if (xhrOrError.status) {
        switch (xhrOrError.status) {
            case 400: message = "Bad request: Invalid data provided."; break;
            case 401: message = "Unauthorized: Please log in again."; break;
            case 403: message = "Forbidden: You don’t have permission."; break;
            case 404: message = "Not found: Resource unavailable."; break;
            case 409: message = "Conflict: Duplicate entry detected."; break;
            case 500: message = "Server error: Please try again later."; break;
            default: message = `Error ${xhrOrError.status}: ${xhrOrError.statusText || "Unknown error"}`;
        }
    } else if (xhrOrError.message) {
        message = xhrOrError.message; // Generic JS error
    }
    return message;
}
    // Session and Logout (unchanged)
    function checkSessionOnLoad() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      const userType = localStorage.getItem('user_type');
      if (!token || !username || !userType) {
        console.warn('🔴 Session data missing or invalid. Redirecting...');
        window.location.href = 'http://smarthospitalmaintain.com';
        return;
      }
      validateUserSession();
    }

// Modified validateUserSession with detailed logging and error handling
function validateUserSession() {
  const headers = getAuthHeaders();
  if (!headers['Authorization']) {
      console.warn("No authorization token found, redirecting to login...");
      window.location.href = 'http://smarthospitalmaintain.com';
      return;
  }
  console.log("Validating user session with headers:", headers);

  $.ajax({
      url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
      type: 'GET',
      headers: headers,
      success: function(response) {
          if (response.message !== 'Cookie is valid.') {
              console.error("Invalid session response:", response);
              showModal("Invalid session. Logging out.", "error");
              attemptLogout();
          } else {
              console.log("Session validated successfully:", response);
              $("#logged_in_user_name, #logged_in_user_name_sidebar, #logged_in_user_name_breadcrumb").text(response.name);
              $("#timeOfDay").text(getGreetingTime());
              const statuses = ["Waiting", "Scheduled", "Pending", "Active", "Completed", "Canceled", "Rescheduled"];
              statuses.forEach(fetchAppointments);
              loadDoctors();
          }
      },
      error: function(xhr) {
          console.error("Failed to validate session:", {
              status: xhr.status,
              statusText: xhr.statusText,
              response: xhr.responseJSON
          });
          const errorMsg = getErrorMessage(xhr, "Failed to validate session.");
          showNotification(errorMsg, "error");
          attemptLogout();
      }
  });
}

    function attemptLogout() {
      logoutUser();
      setTimeout(() => {
        if (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) {
          forceLogout();
        }
      }, 3000);
    }

    function forceLogout() {
      sessionStorage.clear();
      localStorage.clear();
      document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      window.location.href = 'http://smarthospitalmaintain.com/';
    }

    function logoutUser() {
      const headers = getAuthHeaders();
      if (!headers['Authorization']) {
        window.location.href = 'http://smarthospitalmaintain.com/profiling/login.html';
        return;
      }
      $.ajax({
        url: 'http://smarthospitalmaintain.com:8000/users/logout/',
        type: 'POST',
        headers: headers,
        success: function() {
          sessionStorage.clear();
          localStorage.clear();
          document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          window.location.href = 'http://smarthospitalmaintain.com/';
        },
        error: function(xhr) { console.error('Logout error:', xhr.responseText); }
      });
    }

    function getGreetingTime() {
      const hours = new Date().getHours();
      return hours < 12 ? "Morning" : hours < 18 ? "Afternoon" : "Evening";
    }

    $(document).ready(function() {
      checkSessionOnLoad();
      $("#logoutButton").on("click", function(e) {
        e.preventDefault();
        logoutUser();
      });
    });

    // Enhanced notification function with type parameter
function showNotification(message, type = "error", duration = 4000) {
  $("#notificationMessage").text(message);
  $("#customNotification")
      .removeClass("success-message error-message")
      .addClass(type === "success" ? "success-message" : "error-message")
      .show()
      .css("animation", `fadeInOut ${duration / 1000}s ease-in-out`);
  setTimeout(() => $("#customNotification").hide(), duration);
}



// Age calculation for patient modal
$("#patientDob").on("change", function() {
  const dob = new Date(this.value);
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
  $("#patientAge").val(age >= 0 ? age : "");
});

// Load doctors into patient modal
function loadDoctorsForPatientModal() {
  $.ajax({
    url: "http://smarthospitalmaintain.com:8000/appointments/doctors/list/",
    type: "GET",
    headers: getAuthHeaders(),
    success: function(response) {
      $("#patientPrimaryDoctor").empty().append('<option value="" disabled selected>Select a doctor</option>');
      response.doctors.forEach(doctor => {
        let option = `<option value="${doctor.id}">Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}</option>`;
        $("#patientPrimaryDoctor").append(option);
      });
    },
    error: function(xhr) {
      showNotification("Failed to load doctors.", "error");
    }
  });
}

// Call this when the patient modal opens
$("#createPatientModal").on("show.bs.modal", function() {
  loadDoctorsForPatientModal();
});

// Save patient
function savePatient() {
  const patientData = {
    first_name: $("#patientFirstName").val().trim(),
    last_name: $("#patientLastName").val().trim(),
    gender: $("#patientGender").val(),
    date_of_birth: $("#patientDob").val(),
    father_name: $("#patientFatherName").val().trim(),
    address: $("#patientAddress").val().trim() || null,
    city: $("#patientCity").val().trim() || null,
    pincode: $("#patientPincode").val() || null,
    email: $("#patientEmail").val().trim() || null,
    mobile_number: $("#patientMobile").val().trim(),
    alternate_mobile_number: $("#patientAltMobile").val().trim() || null,
    aadhar_number: $("#patientAadhar").val().trim() || null,
    blood_group: $("#patientBloodGroup").val() || null,
    known_allergies: $("#patientAllergies").val().trim() || null,
    current_medications: $("#patientMedications").val().trim() || null,
    past_medical_history: $("#patientPastHistory").val().trim() || null,
    specific_notes: $("#patientNotes").val().trim() || null,
    primary_doctor: $("#patientPrimaryDoctor").val() || null,
    emergency_contact_name: $("#emergencyName").val().trim() || null,
    emergency_contact_relationship: $("#emergencyRelation").val().trim() || null,
    emergency_contact_number: $("#emergencyNumber").val().trim() || null,
    insurance_provider: $("#insuranceProvider").val().trim() || null,
    policy_number: $("#policyNumber").val().trim() || null,
    payment_preference: $("#paymentPreference").val() || null
  };

  // Validation
  const requiredFields = {
    "First Name": patientData.first_name,
    "Last Name": patientData.last_name,
    "Gender": patientData.gender,
    "Date of Birth": patientData.date_of_birth,
    "Father's Name": patientData.father_name,
    "Mobile Number": patientData.mobile_number
  };
  let missingFields = Object.keys(requiredFields).filter(key => !requiredFields[key]);
  if (missingFields.length > 0) {
    showModal(`Please fill in: ${missingFields.join(", ")}`);
    return;
  }

  if (patientData.aadhar_number && !/^\d{12}$/.test(patientData.aadhar_number)) {
    showModal("Aadhar number must be exactly 12 digits.");
    return;
  }

  if (!/^\d{10}$/.test(patientData.mobile_number)) {
    showModal("Mobile number must be exactly 10 digits.");
    return;
  }

  if (patientData.alternate_mobile_number && !/^\d{10}$/.test(patientData.alternate_mobile_number)) {
    showModal("Alternate mobile number must be exactly 10 digits.");
    return;
  }

  if (patientData.emergency_contact_number && !/^\d{10}$/.test(patientData.emergency_contact_number)) {
    showModal("Emergency contact number must be exactly 10 digits.");
    return;
  }

  $.ajax({
    url: "http://smarthospitalmaintain.com:8000/patients/create/", // Adjust this endpoint as per your backend
    type: "POST",
    headers: getAuthHeaders(),
    data: JSON.stringify(patientData),
    contentType: "application/json",
    success: function(response) {
      showNotification("Patient created successfully!", "success");
      $("#createPatientModal").modal("hide");
      $("#createPatientForm")[0].reset();
    },
    error: function(xhr) {
      const errorMsg = getErrorMessage(xhr, "Failed to create patient.");
      showNotification(errorMsg, "error");
    }
  });
}

// Fetch patient details for appointment form
$("#patientID").on("blur", function() {
  let patientId = $(this).val().trim();
  if (patientId) {
    $.ajax({
      url: `http://smarthospitalmaintain.com:8000/appointments/get-patient-details/${patientId}/`,
      type: "GET",
      headers: getAuthHeaders(),
      success: function(response) {
        if (response.patient) {
          $("#firstName").val(response.patient.first_name);
          $("#lastName").val(response.patient.last_name);
          $("#contactNumber").val(response.patient.mobile_number);
          $("#dateOfBirth").val(response.patient.date_of_birth);
          $("#age").val(calculateAge(response.patient.date_of_birth));
        } else {
          showNotification("Patient not found.", "error");
        }
      },
      error: function(xhr) {
        showNotification("Failed to fetch patient details.", "error");
      }
    });
  }
});

// Ensure intl-tel-input works for patient mobile numbers
$(document).ready(function() {
  ["#patientMobile", "#patientAltMobile", "#emergencyNumber"].forEach(selector => {
    const input = document.querySelector(selector);
    if (input) {
      window.intlTelInput(input, {
        initialCountry: "in",
        preferredCountries: ["in", "us", "gb", "ke", "ng"],
        separateDialCode: true
      });
    }
  });
});
// Modified fetchAppointments with detailed logging and error handling
function fetchAppointments(status) {
  const headers = getAuthHeaders();
  let url = `http://smarthospitalmaintain.com:8000/appointments/list/?status=${status}`;
  console.log(`Fetching appointments for status: ${status}, URL: ${url}`);
  
  $.ajax({
      url: url,
      type: 'GET',
      headers: headers,
      success: function(response) {
          console.log(`Successfully fetched ${status} appointments:`, response);
          populateAppointmentsTable(status, response.appointments);
      },
      error: function(xhr) {
          console.error(`Failed to fetch ${status} appointments:`, {
              status: xhr.status,
              statusText: xhr.statusText,
              response: xhr.responseJSON
          });
          const errorMsg = getErrorMessage(xhr, `Failed to fetch ${status} appointments.`);
          showNotification(errorMsg, "error");
      }
  });
}

    let filteredAppointments = [];
    function populateAppointmentsTable(status, appointments) {
      let tbodyId = `${status}-tbody`;
      let tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = "";

      filteredAppointments = appointments;

      if (!document.getElementById(`${status}-select-all`)) {
        let thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th><input type="checkbox" id="${status}-select-all" onclick="toggleAll('${status}')"></th>
            <th>#</th>
            <th>Patient ID</th>
            <th>Patient Name</th>
            <th>Age</th>
            <th>Contact Number</th>
            <th>Current Illness</th>
            <th>Notes</th>
            <th>Appointment Time</th>
            <th>Doctor</th>
            <th>Created By</th>
            <th>Updated By</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        `;
        tbody.parentElement.insertBefore(thead, tbody);
      }

      appointments.forEach((appointment, index) => {
        let patient = appointment.patient || {};
        let doctor = appointment.doctor || {};
        let doctorName = `${doctor.first_name || ''} ${doctor.last_name || ''}` || "Unknown Doctor";
        let appointmentTime = new Date(appointment.appointment_date).toLocaleString();

        let row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" class="${status}-checkbox" value="${appointment.id}" onclick="updateBulkSelection('${status}')"></td>
          <td>${index + 1}</td>
          <td>${patient.patient_id || "N/A"}</td>
          <td>${patient.first_name} ${patient.last_name}</td>
          <td>${patient.age >= 0 ? patient.age : "N/A"}</td>
          <td>${patient.contact_number || "N/A"}</td>
          <td>${patient.current_illness || "N/A"}</td>
          <td>${appointment.notes || "N/A"}</td>
          <td>${appointmentTime}</td>
          <td>Dr. ${doctorName} (${doctor.specialization || "N/A"})</td>
          <td>${appointment.created_by_username || "N/A"}</td>
          <td>${appointment.updated_by ? `${appointment.updated_by_username} updated` : "Not Updated"}</td>
          <td>${appointment.status || "N/A"}</td>
          <td>${getActionButton(appointment.status, appointment, index)}</td>
        `;
        tbody.appendChild(row);
      });

      filterTable(); // Apply filter after populating
    }

    // Function to toggle all checkboxes when "Select All" is clicked
function toggleAll(status) {
  let selectAllCheckbox = document.getElementById(`${status}-select-all`);
  let checkboxes = document.querySelectorAll(`.${status}-checkbox`);
  let selectedIds = [];

  checkboxes.forEach((checkbox) => {
      checkbox.checked = selectAllCheckbox.checked;
      if (checkbox.checked) {
          selectedIds.push(checkbox.value);
      }
  });

  updateBulkActions(status, selectedIds);
}

function bulkCancel() { // Remove status parameter
  const status = $("#appointmentTabs .nav-link.active").attr("href").substring(1).charAt(0).toUpperCase() + $("#appointmentTabs .nav-link.active").attr("href").substring(2);
  let selectedIds = Array.from(document.querySelectorAll(`.${status}-checkbox:checked`))
    .map(checkbox => checkbox.value);
  console.log("bulkCancel selectedIds:", selectedIds); // Debug log
  if (selectedIds.length === 0) {
    showModal("No appointments selected for cancellation.");
    return;
  }
  cancelAppointment(selectedIds, null, status);
}

// Function to update selection when individual checkboxes are clicked
function updateBulkSelection(status) {
  let checkboxes = document.querySelectorAll(`.${status}-checkbox`);
  let selectAllCheckbox = document.getElementById(`${status}-select-all`);

  let selectedIds = Array.from(checkboxes)
      .filter(checkbox => checkbox.checked)
      .map(checkbox => checkbox.value);

  selectAllCheckbox.checked = checkboxes.length > 0 && selectedIds.length === checkboxes.length;

  updateBulkActions(status, selectedIds);
}

function updateBulkActions(status, selectedIds) {
  let cancelBtn = document.getElementById("cancelBtn");
  let rescheduleBtn = document.getElementById("rescheduleBtn");

  if (!cancelBtn || !rescheduleBtn) {
      console.warn("Bulk action buttons not found in the DOM.");
      return; // Prevent errors if elements don't exist
  }

  let shouldShow = selectedIds.length > 0;
  cancelBtn.classList.toggle("d-none", !shouldShow);
  rescheduleBtn.classList.toggle("d-none", !shouldShow);
}

function bulkReschedule() { // Remove status parameter
  const status = $("#appointmentTabs .nav-link.active").attr("href").substring(1).charAt(0).toUpperCase() + $("#appointmentTabs .nav-link.active").attr("href").substring(2);
  let selectedIds = Array.from(document.querySelectorAll(`.${status}-checkbox:checked`))
    .map(checkbox => checkbox.value);
  console.log("bulkReschedule selectedIds:", selectedIds); // Debug log
  if (selectedIds.length === 0) {
    showModal("No appointments selected for rescheduling.");
    return;
  }
  openRescheduleModal(selectedIds, null, status);
}
console.log(document.querySelectorAll(`.${status}-checkbox:checked`)); // Check if elements are found
console.log("Active tab status:", $("#appointmentTabs .nav-link.active").attr("href"));

    function getActionButton(status, appointment, rowIndex) {
      let buttons = "";
      let appointmentData = encodeURIComponent(JSON.stringify(appointment));
      switch (status) {
        case 'Waiting':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-success btn-sm">Start Consulting</button>`;
          break;
        case 'Scheduled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id}, '${appointment.appointment_date}')">Reschedule</button>`;
          break;
        case 'Pending':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id}, '${appointment.appointment_date}')">Reschedule</button>`;
          break;
        case 'Canceled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id}, '${appointment.appointment_date}')">Reschedule</button>`;
          break;
        case 'Completed':
          buttons += `<button class="btn btn-secondary btn-sm">Review</button>`;
          break;
        case 'Rescheduled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id}, '${appointment.appointment_date}')">Reschedule</button>`;
          break;
        default:
          buttons += `<button class="btn btn-light btn-sm">No Action</button>`;
      }
      return buttons;
    }

    $(document).ready(function() {
      const statuses = ["Waiting", "Scheduled", "Pending", "Active", "Completed", "Canceled", "Rescheduled"];
      statuses.forEach(fetchAppointments);
      $("#appointmentTabs a").on("shown.bs.tab", function(e) {
        localStorage.setItem("activeTab", $(e.target).attr("href"));
      });
      var activeTab = localStorage.getItem("activeTab");
      if (activeTab) $("#appointmentTabs a[href='" + activeTab + "']").tab("show");
    });

    // Doctor Loading (unchanged)
    let doctorMap = {};
    // Modified loadDoctors with detailed logging and error handling
function loadDoctors(selectedId = null) {
  console.log("Loading doctors list...");
  $.ajax({
      url: "http://smarthospitalmaintain.com:8000/appointments/doctors/list/",
      type: "GET",
      headers: getAuthHeaders(),
      success: function(response) {
          console.log("Doctors loaded successfully:", response);
          $("#doctor, #editDoctor").empty().append('<option value="" disabled selected>Select a doctor</option>');
          response.doctors.forEach(doctor => {
              doctorMap[doctor.id] = doctor;
              let option = `<option value="${doctor.id}">Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}</option>`;
              $("#doctor, #editDoctor").append(option);
          });
          if (selectedId) $("#editDoctor").val(selectedId);
      },
      error: function(xhr) {
          console.error("Failed to load doctors:", {
              status: xhr.status,
              statusText: xhr.statusText,
              response: xhr.responseJSON
          });
          const errorMsg = getErrorMessage(xhr, "Failed to load doctors list.");
          showNotification(errorMsg, "error");
      }
  });
}
    $(document).ready(loadDoctors);

    // Modified addAppointment with detailed logging and error handling
function addAppointment() {
  const doctorId = $("#doctor").val();
  const patientId = $("#patientID").val().trim();
  const appointmentDate = $("#appointmentDate").val();
  const dateOfBirth = $("#dateOfBirth").val();
  const firstName = $("#firstName").val().trim();
  const lastName = $("#lastName").val().trim();
  const contactNumber = $("#contactNumber").val().trim();
  const notes = $("#notes").val().trim();
  const isEmergency = $("#isEmergency")?.is(":checked") || false;

  $(".form-control").removeClass("is-invalid");
  let missingFields = [];
  if (!doctorId) missingFields.push("Doctor");
  if (!patientId) missingFields.push("Patient ID");
  if (!firstName) missingFields.push("First Name");
  if (!lastName) missingFields.push("Last Name");
  if (!contactNumber) missingFields.push("Contact Number");
  if (!appointmentDate) missingFields.push("Appointment Date");

  if (missingFields.length > 0) {
      $("#" + missingFields.map(f => f.toLowerCase().replace(" ", "")).join(", #")).addClass("is-invalid");
      console.warn("Missing fields:", missingFields);
      showModal("Please fill in: " + missingFields.join(", "));
      return;
  }

  const contactRegex = /^\d{10}$/;
  if (!contactRegex.test(contactNumber)) {
      $("#contactNumber").addClass("is-invalid");
      console.warn("Invalid contact number:", contactNumber);
      showModal("Contact Number must be exactly 10 digits.");
      return;
  }

  if (dateOfBirth && new Date(dateOfBirth) > new Date()) {
      $("#dateOfBirth").addClass("is-invalid");
      console.warn("Future date of birth:", dateOfBirth);
      showModal("Date of birth cannot be in the future.");
      return;
  }

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  if (new Date(appointmentDate) < today) {
      $("#appointmentDate").addClass("is-invalid");
      console.warn("Past appointment date:", appointmentDate);
      showModal("Appointment date cannot be in the past.");
      return;
  }

  const age = dateOfBirth ? calculateAge(dateOfBirth) : null;
  if (age !== null && age < 0) {
      $("#dateOfBirth").addClass("is-invalid");
      console.warn("Invalid age calculated:", age);
      showModal("Invalid Date of Birth.");
      return;
  }
  if (age !== null) $("#age").val(age);

  const appointmentData = {
      appointment: { patient_id: patientId, first_name: firstName, last_name: lastName, contact_number: contactNumber, date_of_birth: dateOfBirth },
      appointment_date: appointmentDate,
      doctor: doctorId,
      notes: notes,
      is_emergency: isEmergency
  };

  console.log("Creating appointment with data:", appointmentData);

  $.ajax({
      url: "http://smarthospitalmaintain.com:8000/appointments/create/",
      type: "POST",
      headers: getAuthHeaders(),
      data: JSON.stringify(appointmentData),
      contentType: "application/json",
      success: function(response) {
          console.log("Appointment created successfully:", response);
          const appointmentId = response.appointment?.id;
          if (!appointmentId) {
              console.error("Appointment ID missing in response:", response);
              showModal("Error: Appointment ID missing.");
              return;
          }
          hideAppointmentForm();
          fetchAppointments("Scheduled");
          $("#vitalsModal").modal("show").data("appointmentId", appointmentId);
          showNotification("Appointment created successfully!", "success");
      },
      error: function(xhr) {
          console.error("Failed to create appointment:", {
              status: xhr.status,
              statusText: xhr.statusText,
              response: xhr.responseJSON
          });
          const errorMsg = getErrorMessage(xhr, "Failed to create appointment.");
          showNotification(errorMsg, "error");
      }
  });
}

   

    function calculateAge(dob) {
      const birthDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      if (today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) age--;
      return age;
    }
// Add this at the top of your script to store original values and units
const originalVitals = {};

// Initialize original values when the modal opens
$("#vitalsModal").on("show.bs.modal", function() {
  ["modalBloodPressure", "modalTemperature", "modalHeartRate", "modalRespiratoryRate", 
   "modalOxygenSaturation", "modalWeight", "modalHeight"].forEach(id => {
    const input = document.getElementById(id);
    const select = document.querySelector(`.unit-select[data-input="${id}"]`);
    originalVitals[id] = {
      value: input.value || "", // Store original input (e.g., "120/80" for BP)
      unit: select ? (select.getAttribute("data-prev-unit") || select.options[0].value) : null // Default to first option if unset
    };
  });
});

// Handle unit change without immediate conversion
document.addEventListener("DOMContentLoaded", function() {
  $(".unit-select").on("change", function() {
    let inputId = this.dataset.input;
    let select = this;
    let toUnit = select.value;

    // Update the previous unit without converting the value
    select.setAttribute("data-prev-unit", toUnit);
    // Log the change for debugging
    console.log(`Unit for ${inputId} changed to ${toUnit}`);
  });

  // Handle explicit conversion when "Convert" button is clicked
  $(".convert-btn").on("click", function() {
    let inputId = this.dataset.input;
    convertMeasurement(inputId);
  });
});

function convertMeasurement(inputId) {
  let inputField = document.getElementById(inputId);
  let select = document.querySelector(`.unit-select[data-input="${inputId}"]`);
  let toUnit = select.value;
  let fromUnit = select.getAttribute("data-prev-unit") || select.options[0].value;
  let currentValue = inputField.value.trim();

  // If no value entered yet, do nothing
  if (!currentValue) {
    console.log(`No value to convert for ${inputId}`);
    return;
  }

  let newValue;
  if (inputId === "modalBloodPressure") {
    // Handle blood pressure (systolic/diastolic)
    const [systolic, diastolic] = currentValue.split("/").map(v => parseFloat(v.trim()));
    if (isNaN(systolic) || isNaN(diastolic)) {
      showNotification("Invalid blood pressure format. Use 'systolic/diastolic'.", "error");
      return;
    }
    const convertedSystolic = convertValue(systolic, fromUnit, toUnit);
    const convertedDiastolic = convertValue(diastolic, fromUnit, toUnit);
    newValue = `${convertedSystolic.toFixed(2)}/${convertedDiastolic.toFixed(2)}`;
  } else {
    // Handle single-value inputs (e.g., temperature, weight)
    const numericValue = parseFloat(currentValue);
    if (isNaN(numericValue)) {
      showNotification(`Invalid value for ${inputId}. Enter a number.`, "error");
      return;
    }
    newValue = convertValue(numericValue, fromUnit, toUnit).toFixed(2);
  }

  inputField.value = newValue;
  // Update the previous unit to the new unit after conversion
  select.setAttribute("data-prev-unit", toUnit);
  console.log(`Converted ${inputId} from ${fromUnit} to ${toUnit}: ${newValue}`);
}

function convertValue(value, fromUnit, toUnit) {
  if (fromUnit === toUnit) return value;

  const conversions = {
    "cm": { "in": v => v / 2.54 },
    "in": { "cm": v => v * 2.54 },
    "kg": { "lbs": v => v * 2.20462 },
    "lbs": { "kg": v => v / 2.20462 },
    "°C": { "°F": v => (v * 9/5) + 32 },
    "°F": { "°C": v => (v - 32) * 5/9 },
    "mmHg": { "kPa": v => v * 0.133322 },
    "kPa": { "mmHg": v => v / 0.133322 }
  };

  const conversionFunc = conversions[fromUnit]?.[toUnit];
  return conversionFunc ? conversionFunc(value) : value;
}

// Modified saveVitals with detailed logging and error handling
function saveVitals() {
  const appointmentId = $("#vitalsModal").data("appointmentId");
  if (!appointmentId) {
      console.error("Missing appointment ID for vitals");
      showNotification("Appointment ID is missing.", "error");
      return;
  }

  let vitalsData = {
      appointment: appointmentId,
      blood_pressure: $("#modalBloodPressure").val().trim() || null,
      heart_rate: $("#modalHeartRate").val().trim() || null,
      temperature: $("#modalTemperature").val().trim() || null,
      respiratory_rate: $("#modalRespiratoryRate").val().trim() || null,
      oxygen_saturation: $("#modalOxygenSaturation").val().trim() || null,
      weight: $("#modalWeight").val().trim() || null,
      height: $("#modalHeight").val().trim() || null,
      blood_pressure_unit: document.querySelector(`.unit-select[data-input="modalBloodPressure"]`)?.value || "mmHg",
      temperature_unit: document.querySelector(`.unit-select[data-input="modalTemperature"]`)?.value || "°C",
      weight_unit: document.querySelector(`.unit-select[data-input="modalWeight"]`)?.value || "kg",
      height_unit: document.querySelector(`.unit-select[data-input="modalHeight"]`)?.value || "cm"
  };

  Object.keys(vitalsData).forEach(key => { if (vitalsData[key] === null) delete vitalsData[key]; });

  console.log("Saving vitals with data:", vitalsData);

  $.ajax({
      url: `http://smarthospitalmaintain.com:8000/appointments/vitals/${appointmentId}/`,
      type: "POST",
      headers: getAuthHeaders(),
      data: JSON.stringify(vitalsData),
      contentType: "application/json",
      success: function(response) {
          console.log("Vitals saved successfully:", response);
          $("#vitalsModal").modal("hide");
          showNotification("Vitals saved successfully!", "success");
          location.reload();
      },
      error: function(xhr) {
          console.error("Failed to save vitals:", {
              status: xhr.status,
              statusText: xhr.statusText,
              response: xhr.responseJSON
          });
          const errorMsg = getErrorMessage(xhr, "Failed to save vitals.");
          showNotification(errorMsg, "error");
      }
  });
}

// Updated openEditModal with age calculation and non-editable fields
let currentAppointment = null; // Global variable to store the current appointment

function openEditModal(appointmentData, rowIndex) {
    currentAppointment = JSON.parse(decodeURIComponent(appointmentData));
    
    $("#editFirstName").val(currentAppointment.patient?.first_name || "");
    $("#editLastName").val(currentAppointment.patient?.last_name || "");
    $("#editContactNumber").val(currentAppointment.patient?.contact_number || "");
    $("#editDateOfBirth").val(currentAppointment.patient?.date_of_birth || "");
    
    // Calculate and update age
    const dob = currentAppointment.patient?.date_of_birth;
    if (dob) {
        const calculatedAge = calculateAge(dob);
        $("#editAge").val(calculatedAge >= 0 ? calculatedAge : "");
    } else {
        $("#editAge").val("");
    }
    
    $("#editCurrentIllness").val(currentAppointment.current_illness || "");
    $("#editAppointmentDate").val(formatDateTime(currentAppointment.appointment_date));
    $("#editAppointmentStatus").val(currentAppointment.status || "");
    $("#editNotes").val(currentAppointment.notes || "");
    $("#editAppointmentID").val(currentAppointment.id);
    $("#editPatientID").val(currentAppointment.patient?.patient_id || "");

    // Make fields read-only
    $("#editFirstName, #editLastName, #editContactNumber, #editPatientID, #editDateOfBirth").prop("readonly", true);
    $("#editAge").prop("readonly", true); // Age should also be readonly since it's calculated
    $("#editCurrentIllness, #editNotes, #editAppointmentDate, #editAppointmentStatus").prop("readonly", false);

    let previousDoctorId = currentAppointment.doctor?.id || "";
    loadDoctors(previousDoctorId);

    $("#editAppointmentModal").modal("show");
}

// Modified updateAppointment with detailed logging and error handling
function updateAppointment() {
  let updatedAppointment = {
      id: $("#editAppointmentID").val(),
      patient_id: $("#editPatientID").val(),
      date_of_birth: $("#editDateOfBirth").val(),
      current_illness: $("#editCurrentIllness").val(),
      doctor_id: $("#editDoctor").val() || currentAppointment.doctor?.id || "",
      status: $("#editAppointmentStatus").val(),
      notes: $("#editNotes").val(),
      appointment_date: $("#editAppointmentDate").val()
  };

  console.log("Updating appointment with data:", updatedAppointment);

  fetch(`http://smarthospitalmaintain.com:8000/appointments/edit/${updatedAppointment.id}/`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify(updatedAppointment)
  })
  .then(response => {
      if (!response.ok) {
          return response.json().then(err => {
              console.error("Failed to update appointment:", {
                  status: response.status,
                  statusText: response.statusText,
                  response: err
              });
              throw err;
          });
      }
      return response.json();
  })
  .then(data => {
      console.log("Appointment updated successfully:", data);
      showNotification("Appointment updated successfully!", "success");
      $("#editAppointmentModal").modal("hide");
      location.reload();
  })
  .catch(error => {
      const errorMsg = getErrorMessage(error, "Failed to update appointment.");
      showNotification(errorMsg, "error");
  });
}

    // Cancel and Reschedule (unchanged)
    function cancelAppointments() {
      const status = $("#appointmentTabs .nav-link.active").attr("href").substring(1);
      cancelAppointment(null, null, status);
    }

  // Modified cancelAppointment with detailed logging and error handling
function cancelAppointment(appointmentIds, rowIndex = null, status = null) {
  let selectedIds = Array.isArray(appointmentIds) ? appointmentIds : [appointmentIds];

  if (selectedIds.length === 0 || !selectedIds[0]) {
      console.warn("No appointments selected for cancellation");
      showModal("No appointments selected.");
      return;
  }

  if (!confirm(`Are you sure you want to cancel ${selectedIds.length} appointment(s)?`)) return;

  const payload = { appointment_ids: selectedIds, status: "Canceled" };
  console.log("Cancelling appointments with payload:", payload);

  fetch("http://smarthospitalmaintain.com:8000/appointments/cancel/", {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify(payload)
  })
  .then(response => {
      if (!response.ok) {
          return response.json().then(err => {
              console.error("Failed to cancel appointments:", {
                  status: response.status,
                  statusText: response.statusText,
                  response: err
              });
              throw err;
          });
      }
      return response.json();
  })
  .then(data => {
      console.log(`Successfully canceled ${selectedIds.length} appointments:`, data);
      showModal(`Successfully canceled ${selectedIds.length} appointment(s).`, "success");
      fetchAppointments(status || "Canceled");
      location.reload();
  })
  .catch(error => {
      const errorMsg = getErrorMessage(error, "Failed to cancel appointments.");
      showModal(errorMsg, "error");
  });
}

    function openRescheduleModal(appointmentIds = null, date = null, status = null) {
      let selectedIds = [];
    
      if (Array.isArray(appointmentIds)) {
        selectedIds = appointmentIds; // Use passed IDs for bulk case
      } else if (appointmentIds) {
        selectedIds = [appointmentIds]; // Single appointment case
      } else if (status) {
        // Fallback to collecting IDs if none provided (for backward compatibility)
        selectedIds = Array.from(document.querySelectorAll(`.${status}-checkbox:checked`))
          .map(cb => cb.value);
      }
    
      if (selectedIds.length === 0) {
        showModal("No appointments selected.");
        return;
      }
    
      $("#rescheduleAppointmentID").val(selectedIds.join(","));
      $("#newAppointmentDate").val(date || "");
      $("#rescheduleAppointmentModal").modal("show");
    }

   // Modified rescheduleAppointment with detailed logging and error handling
function rescheduleAppointment() {
  let appointmentIds = $("#rescheduleAppointmentID").val().split(",");
  let newDate = $("#newAppointmentDate").val().trim();
  if (!newDate) {
      console.warn("No new date provided for rescheduling");
      showModal("Please select a new date and time.");
      return;
  }

  const payload = { appointment_ids: appointmentIds, appointment_date: new Date(newDate).toISOString() };
  console.log("Rescheduling appointments with payload:", payload);

  fetch("http://smarthospitalmaintain.com:8000/appointments/reschedule/", {
      method: "PATCH",
      headers: { "Content-Type": "application/json", ...getAuthHeaders() },
      body: JSON.stringify(payload)
  })
  .then(response => {
      if (!response.ok) {
          return response.json().then(err => {
              console.error("Failed to reschedule appointments:", {
                  status: response.status,
                  statusText: response.statusText,
                  response: err
              });
              throw err;
          });
      }
      return response.json();
  })
  .then(data => {
      console.log(`Successfully rescheduled ${appointmentIds.length} appointments:`, data);
      showModal(`Successfully rescheduled ${appointmentIds.length} appointment(s).`, "success");
      $("#rescheduleAppointmentModal").modal("hide");
      fetchAppointments("Rescheduled");
      location.reload();
  })
  .catch(error => {
      const errorMsg = getErrorMessage(error, "Failed to reschedule appointments.");
      showModal(errorMsg, "error");
  });
}

    function formatDateTime(dateTimeString) {
      return new Date(dateTimeString).toISOString().slice(0, 16);
    }

  

    
// Ensure tab switching works correctly and integrates with form
document.addEventListener("DOMContentLoaded", function() {
  ["#contactNumber", "#editContactNumber"].forEach(selector => {
      const input = document.querySelector(selector);
      if (input) {
          const iti = window.intlTelInput(input, {
              initialCountry: "in",
              preferredCountries: ["in", "us", "gb", "ke", "ng"],
              separateDialCode: true
          });
          input.addEventListener("blur", () => console.log(`Full Phone Number (${selector}):`, iti.getNumber()));
      }
  });

  $("#dateOfBirth").attr("max", new Date().toISOString().split("T")[0]);
  let now = new Date();
  let formattedNow = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
  $("#appointmentDate").attr("min", formattedNow);

  $("#dateOfBirth, #editDateOfBirth").on("change", function() {
      const dob = new Date(this.value);
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) age--;
      $(this.id === "dateOfBirth" ? "#age" : "#editAge").val(age >= 0 ? age : "");
  });

  $("#appointmentTabs a").on("shown.bs.tab", function(e) {
      localStorage.setItem("activeTab", $(e.target).attr("href"));
      $("#appointmentFormContainer").hide(); // Hide form when switching tabs
  });
  
  var activeTab = localStorage.getItem("activeTab");
  if (activeTab) $("#appointmentTabs a[href='" + activeTab + "']").tab("show");

  $("#logoutButton").on("click", function(e) {
      e.preventDefault();
      logoutUser();
  });

  checkSessionOnLoad();
  const statuses = ["Waiting", "Scheduled", "Pending", "Active", "Completed", "Canceled", "Rescheduled"];
  statuses.forEach(fetchAppointments);
  loadDoctors();
});
  </script>
</body>
</html>