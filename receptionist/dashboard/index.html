<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Kerala | Receptionist</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css" />
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <!-- End layout styles -->
    <link rel="shortcut icon" href="assets/images/favicon.png" />
    <!-- jQuery and Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
    <!-- Custom CSS -->
    <style>
        .table {
            table-layout: auto;
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 14px;
            padding: 8px;
            text-align: left;
        }
        .table-responsive {
            width: 100%;
            overflow-x: auto;
        }
        .table .btn {
            font-size: 12px;
            padding: 5px 8px;
            margin: 2px;
            white-space: nowrap;
        }
        .filter-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .filter-container input, .filter-container select {
            width: 100%;
            max-width: 200px;
            padding: 5px;
            font-size: 14px;
        }
        .custom-notification {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            text-align: center;
            z-index: 9999;
            min-width: 250px;
            max-width: 400px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.3);
        }
        @keyframes fadeInOut {
            0% { opacity: 0; }
            20% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover, .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .success-message { color: green; }
        .error-message { color: red; }
        @media (max-width: 768px) {
            .table th, .table td { font-size: 12px; padding: 6px; }
            .table .btn { font-size: 10px; padding: 4px 6px; }
            .filter-container input, .filter-container select { max-width: 150px; }
        }
        @media (max-width: 480px) {
            .table th, .table td { font-size: 10px; padding: 4px; }
            .table .btn { font-size: 9px; padding: 3px 5px; }
            .filter-container input, .filter-container select { max-width: 100px; }
        }
    </style>
</head>
<body>
    <div class="container-scroller">
        <div class="row p-0 m-0 proBanner" id="proBanner">
            <div class="col-md-12 p-0 m-0">
                <div class="card-body card-body-padding d-flex align-items-center justify-content-between">
                    <div class="ps-lg-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <p class="mb-0 font-weight-medium me-3 buy-now-text">Free 24/7 customer support, updates</p>
                            <a href="" target="_blank" class="btn me-2 buy-now-btn border-0">Book Appointment</a>
                        </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between">
                        <a href=""><i class="mdi mdi-home me-3 text-white"></i></a>
                        <button id="bannerClose" class="btn border-0 p-0">
                            <i class="mdi mdi-close text-white mr-0"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- partial:partials/_navbar.html -->
        <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
            <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
                <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
            </div>
            <div class="navbar-menu-wrapper d-flex align-items-stretch">
                <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-toggle="minimize">
                    <span class="mdi mdi-menu"></span>
                </button>
                <div class="search-field d-none d-md-block">
                    <form class="d-flex align-items-center h-100" action="#">
                        <div class="input-group">
                            <div class="input-group-prepend bg-transparent">
                                <i class="input-group-text border-0 mdi mdi-magnify"></i>
                            </div>
                            <input type="text" class="form-control bg-transparent border-0" placeholder="Search patients, appointments">
                        </div>
                    </form>
                </div>
                <ul class="navbar-nav navbar-nav-right">
                    <!-- Profile Dropdown -->
                    <li class="nav-item nav-profile dropdown">
                        <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <div class="nav-profile-img">
                                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                                <span class="availability-status online"></span>
                            </div>
                            <div class="nav-profile-text">
                                <p class="mb-1 text-black"><span id="logged_in_user_name"></span></p>
                            </div>
                        </a>
                        <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
                            <a class="dropdown-item" href="#">
                                <i class="mdi mdi-account-circle me-2 text-success"></i> My Profile </a>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item" id="logoutButton">
                                <i class="mdi mdi-logout me-2 text-primary"></i> Logout </button>
                        </div>
                    </li>
                    <!-- Messages and Notifications Dropdowns (unchanged) -->
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-email-outline"></i>
                            <span class="count-symbol bg-warning" id="message-count">3</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
                            <h6 class="p-3 mb-0">Messages</h6>
                            <div id="message-list">
                                <p class="text-gray mb-0 text-center">No new messages</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all messages</h6>
                        </div>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="mdi mdi-bell-outline"></i>
                            <span class="count-symbol bg-danger" id="notification-count">5</span>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
                            <h6 class="p-3 mb-0">Notifications</h6>
                            <div id="notification-list">
                                <p class="text-gray mb-0 text-center">No new notifications</p>
                            </div>
                            <div class="dropdown-divider"></div>
                            <h6 class="p-3 mb-0 text-center">See all notifications</h6>
                        </div>
                    </li>
                    <li class="nav-item nav-logout d-none d-lg-block">
                        <button class="btn btn-sm btn-danger" id="logoutButton">
                            <i class="mdi mdi-power"> Logout</i>
                        </button>
                    </li>
                </ul>
                <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-toggle="offcanvas">
                    <span class="mdi mdi-menu"></span>
                </button>
            </div>
        </nav>
        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:partials/_sidebar.html -->
            <nav class="sidebar sidebar-offcanvas" id="sidebar">
                <ul class="nav">
                    <li class="nav-item nav-profile">
                        <a href="#" class="nav-link">
                            <div class="nav-profile-image">
                                <img src="assets/images/faces/face1.jpg" alt="profile" />
                                <span class="login-status online"></span>
                            </div>
                            <div class="nav-profile-text d-flex flex-column">
                                <span class="font-weight-bold mb-2" id="logged_in_user_name"></span>
                                <span class="text-secondary text-small">Receptionist</span>
                            </div>
                            <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <span class="menu-title">Dashboard</span>
                            <i class="mdi mdi-home menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="patients.html">
                            <span class="menu-title">Patients</span>
                            <i class="mdi mdi-account-group menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="appointments.html">
                            <span class="menu-title">Appointments</span>
                            <i class="mdi mdi-calendar-check menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
                            <span class="menu-title">Medical Records</span>
                            <i class="menu-arrow"></i>
                            <i class="mdi mdi-folder-multiple menu-icon"></i>
                        </a>
                        <div class="collapse" id="medical-records">
                            <ul class="nav flex-column sub-menu">
                                <li class="nav-item">
                                    <a class="nav-link" href="records/view-records.html">View Records</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" href="records/upload-records.html">Upload Records</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="prescriptions.html">
                            <span class="menu-title">Prescriptions</span>
                            <i class="mdi mdi-pill menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="reports.html">
                            <span class="menu-title">Reports</span>
                            <i class="mdi mdi-chart-bar menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="lab-tests.html">
                            <span class="menu-title">Lab Tests</span>
                            <i class="mdi mdi-flask-outline menu-icon"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.html">
                            <span class="menu-title">Settings</span>
                            <i class="mdi mdi-settings menu-icon"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="page-header">
                        <h3 class="page-title">
                            <span class="page-title-icon bg-gradient-primary text-white me-2">
                                <i class="mdi mdi-calendar-check"></i>
                            </span> Appointments
                        </h3>
                        <nav aria-label="breadcrumb">
                            <ul class="breadcrumb">
                                <li class="breadcrumb-item active" aria-current="page">
                                    <span>Receptionist Appointment Management <i class="mdi mdi-alert-circle-outline icon-sm text-primary align-middle"></i></span>
                                </li>
                            </ul>
                        </nav>
                    </div>

                    <!-- Notification Container -->
                    <div id="customNotification" class="custom-notification">
                        <p id="notificationMessage"></p>
                    </div>

                    <!-- Modal HTML -->
                    <div id="messageModal" class="modal">
                        <div class="modal-content">
                            <span class="close-btn">×</span>
                            <p id="modalMessage">This is a message!</p>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Appointment Section -->
                        <div class="col-md-12 stretch-card">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Appointments</h4>
                                    <!-- Filter Section -->
                                    <div class="filter-container">
                                        <input type="text" id="appointmentFilter" class="filter form-control" placeholder="Filter by patient name, doctor, or status...">
                                        <select id="statusFilter" class="filter form-control">
                                            <option value="">All Statuses</option>
                                            <option value="Waiting">Waiting</option>
                                            <option value="Scheduled">Scheduled</option>
                                            <option value="Pending">Pending</option>
                                            <option value="Active">Active</option>
                                            <option value="Completed">Completed</option>
                                            <option value="Canceled">Canceled</option>
                                            <option value="Rescheduled">Rescheduled</option>
                                        </select>
                                        <input type="date" id="dateFilter" class="filter form-control" placeholder="Filter by date">
                                        <button class="btn btn-primary btn-sm" onclick="applyFilters()">Apply Filters</button>
                                    </div>
                                    <!-- Tabbed Appointments -->
                                    <ul class="nav nav-tabs" id="appointmentTabs" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="waiting-tab" data-bs-toggle="tab" href="#waiting" role="tab">Waiting in Clinic</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="scheduled-tab" data-bs-toggle="tab" href="#scheduled" role="tab">Scheduled</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="pending-tab" data-bs-toggle="tab" href="#pending" role="tab">Pending</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="active-tab" data-bs-toggle="tab" href="#active" role="tab">Active</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="completed-tab" data-bs-toggle="tab" href="#completed" role="tab">Completed</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="canceled-tab" data-bs-toggle="tab" href="#canceled" role="tab">Canceled</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="rescheduled-tab" data-bs-toggle="tab" href="#rescheduled" role="tab">Rescheduled</a>
                                        </li>
                                    </ul>
                                    <div class="tab-content mt-3" id="appointmentTabContent">
                                        <!-- Waiting in Clinic Tab -->
                                        <div class="tab-pane fade show active" id="waiting" role="tabpanel">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Waiting-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Scheduled Tab -->
                                        <div class="tab-pane fade" id="scheduled" role="tabpanel">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Scheduled-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Pending Tab -->
                                        <div class="tab-pane fade" id="pending" role="tabpanel" aria-labelledby="pending-tab">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Pending-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Active Tab -->
                                        <div class="tab-pane fade" id="active" role="tabpanel" aria-labelledby="active-tab">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Active-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Completed Tab -->
                                        <div class="tab-pane fade" id="completed" role="tabpanel" aria-labelledby="completed-tab">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Completed-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Canceled Tab -->
                                        <div class="tab-pane fade" id="canceled" role="tabpanel" aria-labelledby="canceled-tab">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Canceled-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- Rescheduled Tab -->
                                        <div class="tab-pane fade" id="rescheduled" role="tabpanel" aria-labelledby="rescheduled-tab">
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                                <table class="table">
                                                    <thead>
                                                        <tr>
                                                            <th>#</th>
                                                            <th>Patient ID</th>
                                                            <th>Patient Name</th>
                                                            <th>Age</th>
                                                            <th>Mobile Number</th>
                                                            <th>Illness</th>
                                                            <th>Appointment Time</th>
                                                            <th>Doctor</th>
                                                            <th>Status</th>
                                                            <th>Created By</th>
                                                            <th>Updated By</th>
                                                            <th>Notes</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="Rescheduled-tbody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Appointment Form -->
                    <div id="appointmentFormContainer" class="card mt-3" style="display: none;">
                        <div class="card-body">
                            <h5 class="card-title">Create New Appointment</h5>
                            <form id="appointmentForm">
                                <!-- Patient ID Field -->
                                <div class="row">
                                    <div class="col-md-4">
                                        <label for="patientID">Patient ID</label>
                                        <input type="text" id="patientID" class="form-control" placeholder="Enter Patient ID" required>
                                    </div>
                                </div>
                                <!-- Patient Information -->
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="firstName">First Name</label>
                                        <input type="text" id="firstName" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="lastName">Last Name</label>
                                        <input type="text" id="lastName" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="contactNumber">Contact Number</label>
                                        <input type="tel" id="contactNumber" class="form-control" required>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="dateOfBirth">Date of Birth</label>
                                        <input type="date" id="dateOfBirth" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="age">Age</label>
                                        <input type="number" id="age" class="form-control" readonly>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="currentIllness">Current Illness</label>
                                        <input type="text" id="currentIllness" class="form-control">
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-md-4">
                                        <label for="appointmentDate">Appointment Date</label>
                                        <input type="datetime-local" id="appointmentDate" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="doctor">Doctor</label>
                                        <select id="doctor" class="form-control" required>
                                            <option value="" disabled selected>Select a doctor</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="notes">Notes</label>
                                        <input type="text" id="notes" class="form-control">
                                    </div>
                                </div>
                                <div class="col-md-12 mt-3">
                                    <label for="isEmergency">Is this an emergency?</label>
                                    <input type="checkbox" id="isEmergency" class="form-check-input">
                                </div>
                                <div class="mt-3">
                                    <button type="button" class="btn btn-success" onclick="addAppointment()">Submit</button>
                                    <button type="button" class="btn btn-danger" onclick="hideAppointmentForm()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Vitals Modal -->
                    <div class="modal fade" id="vitalsModal" tabindex="-1" aria-labelledby="vitalsModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="vitalsModalLabel">Enter Patient Vitals</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="vitalsForm">
                                        <div class="mb-3">
                                            <label for="modalBloodPressure">Blood Pressure</label>
                                            <div class="input-group">
                                                <input type="text" id="modalBloodPressure" class="form-control" placeholder="120/80">
                                                <div class="input-group-append">
                                                    <select class="form-select unit-select" data-input="modalBloodPressure">
                                                        <option value="mmHg">mmHg</option>
                                                        <option value="kPa">kPa</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalHeartRate">Heart Rate</label>
                                            <div class="input-group">
                                                <input type="text" id="modalHeartRate" class="form-control" placeholder="60-100">
                                                <div class="input-group-append">
                                                    <div class="input-group-text">bpm</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalTemperature">Temperature</label>
                                            <div class="input-group">
                                                <input type="text" id="modalTemperature" class="form-control" placeholder="37.0">
                                                <div class="input-group-append">
                                                    <select class="form-select unit-select" data-input="modalTemperature">
                                                        <option value="°C">°C</option>
                                                        <option value="°F">°F</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalRespiratoryRate">Respiratory Rate</label>
                                            <div class="input-group">
                                                <input type="text" id="modalRespiratoryRate" class="form-control" placeholder="12-20">
                                                <div class="input-group-append">
                                                    <div class="input-group-text">breaths/min</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalOxygenSaturation">Oxygen Saturation</label>
                                            <div class="input-group">
                                                <input type="text" id="modalOxygenSaturation" class="form-control" placeholder="95-100">
                                                <div class="input-group-append">
                                                    <div class="input-group-text">%</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalWeight">Weight</label>
                                            <div class="input-group">
                                                <input type="text" id="modalWeight" class="form-control" placeholder="70">
                                                <div class="input-group-append">
                                                    <select class="form-select unit-select" data-input="modalWeight">
                                                        <option value="kg">kg</option>
                                                        <option value="lbs">lbs</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="modalHeight">Height</label>
                                            <div class="input-group">
                                                <input type="text" id="modalHeight" class="form-control" placeholder="170">
                                                <div class="input-group-append">
                                                    <select class="form-select unit-select" data-input="modalHeight">
                                                        <option value="cm">cm</option>
                                                        <option value="in">in</option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="saveVitals()">Save Vitals</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Edit Appointment Modal -->
                    <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editAppointmentModalLabel">Edit Appointment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editAppointmentForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <label for="editAppointmentID">Appointment ID</label>
                                                <input type="text" id="editAppointmentID" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editPatientID">Patient ID</label>
                                                <input type="text" id="editPatientID" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="editFirstName">First Name</label>
                                                <input type="text" id="editFirstName" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editLastName">Last Name</label>
                                                <input type="text" id="editLastName" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="editContactNumber">Contact Number</label>
                                                <input type="tel" id="editContactNumber" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editDateOfBirth">Date of Birth</label>
                                                <input type="date" id="editDateOfBirth" class="form-control" readonly>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="editAge">Age</label>
                                                <input type="number" id="editAge" class="form-control" readonly>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editCurrentIllness">Current Illness</label>
                                                <input type="text" id="editCurrentIllness" class="form-control">
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-6">
                                                <label for="editAppointmentDate">Appointment Date</label>
                                                <input type="datetime-local" id="editAppointmentDate" class="form-control" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editDoctor">Doctor</label>
                                                <select id="editDoctor" class="form-control" required>
                                                    <option value="" disabled selected>Select a doctor</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <label for="editNotes">Notes</label>
                                                <textarea id="editNotes" class="form-control"></textarea>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <label for="editAppointmentStatus">Status</label>
                                                <select id="editAppointmentStatus" class="form-control">
                                                    <option value="Waiting">Waiting</option>
                                                    <option value="Scheduled">Scheduled</option>
                                                    <option value="Pending">Pending</option>
                                                    <option value="Active">Active</option>
                                                    <option value="Completed">Completed</option>
                                                    <option value="Canceled">Canceled</option>
                                                    <option value="Rescheduled">Rescheduled</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-12 mt-3">
                                            <label for="editIsEmergency">Is this an emergency?</label>
                                            <input type="checkbox" id="editIsEmergency" class="form-check-input">
                                        </div>
                                        <div class="mt-3">
                                            <button type="button" class="btn btn-success" onclick="updateAppointment()">Save Changes</button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reschedule Appointment Modal -->
                    <div class="modal fade" id="rescheduleAppointmentModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="rescheduleModalLabel">Reschedule Appointment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="rescheduleForm">
                                        <input type="hidden" id="rescheduleAppointmentID">
                                        <div class="form-group">
                                            <label for="newAppointmentDate">New Date & Time</label>
                                            <input type="datetime-local" class="form-control" id="newAppointmentDate" required>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary" onclick="rescheduleAppointment()">Confirm Reschedule</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- content-wrapper ends -->
                    <!-- partial:partials/_footer.html -->
                    <footer class="footer">
                        <div class="d-sm-flex justify-content-center justify-content-sm-between">
                            <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2025 <a href="" target="_blank">Kerala. All rights reserved.</span>
                            <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
                        </div>
                    </footer>
                    <!-- partial -->
                </div>
                <!-- main-panel ends -->
            </div>
            <!-- page-body-wrapper ends -->
        </div>
        <!-- container-scroller -->

        <!-- plugins:js -->
        <script src="assets/vendors/js/vendor.bundle.base.js"></script>
        <!-- endinject -->
        <!-- Plugin js for this page -->
        <script src="assets/vendors/chart.js/chart.umd.js"></script>
        <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
        <!-- End plugin js for this page -->
        <!-- inject:js -->
        <script src="assets/js/off-canvas.js"></script>
        <script src="assets/js/misc.js"></script>
        <script src="assets/js/settings.js"></script>
        <script src="assets/js/todolist.js"></script>
        <script src="assets/js/jquery.cookie.js"></script>
        <!-- endinject -->
        <!-- Custom js for this page -->
        <script src="assets/js/dashboard.js"></script>
        <!-- End custom js for this page -->

        <script>
            // Function to retrieve authentication headers
            function getAuthHeaders() {
                const token = sessionStorage.getItem('token') || localStorage.getItem('token');
                const username = sessionStorage.getItem('username') || localStorage.getItem('username');
                const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken') || getCSRFToken();

                if (token && username && csrftoken) {
                    return {
                        'Authorization': 'Token ' + token,
                        'X-CSRFToken': csrftoken,
                        'Username': username
                    };
                }
                console.warn('Missing authentication details.');
                return {};
            }

            // Function to check session data on page load
            function checkSessionOnLoad() {
                const token = localStorage.getItem('token');
                const username = localStorage.getItem('username');
                const userType = localStorage.getItem('user_type');

                if (!token || !username || !userType) {
                    console.warn('🔴 Session data missing or invalid. Redirecting...');
                    window.location.href = 'http://smarthospitalmaintain.com';
                    return;
                }

                console.log('🟢 Session data exists. Validating session...');
                validateUserSession();
            }

            // Validate user session
            function validateUserSession() {
                const headers = getAuthHeaders();

                if (!headers['Authorization']) {
                    console.warn('🔴 No valid token. User is not authenticated.');
                    window.location.href = 'http://smarthospitalmaintain.com';
                    return;
                }

                $.ajax({
                    url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('🟢 Session validation success:', response);

                        if (response.message !== 'Cookie is valid.') {
                            console.warn('🔴 Invalid session. Logging out...');
                            showModal('Invalid session. Logging out.', 'error');
                            attemptLogout();
                        } else {
                            // Update navigation bar with user details
                            document.getElementById("logged_in_user_name").textContent = response.name;
                            document.getElementById("timeOfDay").textContent = getGreetingTime();
                            fetchAppointments(); // Fetch appointments after session validation
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Error validating session:', xhr.responseText);
                        attemptLogout();
                    }
                });
            }

            // Attempt to logout and handle failures
            function attemptLogout() {
                logoutUser();

                setTimeout(function() {
                    if (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) {
                        console.warn('🔴 Logout failed! Forcing session cleanup.');
                        forceLogout();
                    }
                }, 3000);
            }

            // Force logout by clearing session data and redirecting
            function forceLogout() {
                sessionStorage.clear();
                localStorage.clear();
                document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                console.log('🔄 Redirecting to landing page after forced logout...');
                window.location.href = 'http://smarthospitalmaintain.com/';
            }

            // Function to get time of day greeting
            function getGreetingTime() {
                const hours = new Date().getHours();
                if (hours < 12) return "Morning";
                else if (hours < 18) return "Afternoon";
                else return "Evening";
            }

            // Logout function
            function logoutUser() {
                const headers = getAuthHeaders();

                if (!headers['Authorization']) {
                    console.error('No authentication token. Redirecting to login...');
                    window.location.href = 'http://smarthospitalmaintain.com/profiling/login.html';
                    return;
                }

                $.ajax({
                    url: 'http://smarthospitalmaintain.com:8000/users/logout/',
                    type: 'POST',
                    headers: headers,
                    success: function(response) {
                        console.log('User logged out successfully:', response);
                        sessionStorage.clear();
                        localStorage.clear();
                        document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        window.location.href = 'http://smarthospitalmaintain.com/';
                    },
                    error: function(xhr, status, error) {
                        console.error('Logout error:', xhr.responseText);
                    }
                });
            }

            // Attach logout event
            $(document).on("click", "#logoutButton", function(event) {
                event.preventDefault();
                console.log("Logout button clicked!");
                logoutUser();
            });

            // Fetch appointments with role-based restrictions
            function fetchAppointments(status = null) {
                const headers = getAuthHeaders();
                const userType = localStorage.getItem('user_type');
                let url = 'http://smarthospitalmaintain.com:8000/appointments/list/';

                // For receptionists, show all appointments; for doctors, filter by their appointments
                if (userType === 'doctor') {
                    const username = localStorage.getItem('username');
                    url += `?doctor=${encodeURIComponent(username)}`;
                }
                if (status) url += `?status=${encodeURIComponent(status)}`;

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('Appointments fetched:', response);
                        let appointments = response.appointments || [];
                        populateAppointmentsTable(appointments, status);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching appointments:', error);
                        showModal('Failed to fetch appointments. Please try again.', 'error');
                    }
                });
            }

            // Populate appointments table for each tab
            function populateAppointmentsTable(appointments, status) {
                const tbodyId = (status ? status.charAt(0).toUpperCase() + status.slice(1) : 'Waiting') + '-tbody';
                const tbody = document.getElementById(tbodyId);
                if (!tbody) {
                    console.error(`Element with ID '${tbodyId}' not found.`);
                    return;
                }
                tbody.innerHTML = '';

                // Filter appointments by status if provided
                appointments = status ? appointments.filter(a => a.status === status) : appointments;

                appointments.forEach((appointment, index) => {
                    const patient = appointment.patient || {};
                    const doctor = appointment.doctor || {};
                    const doctorName = doctor.first_name && doctor.last_name ? `${doctor.first_name} ${doctor.last_name} (${doctor.specialization || 'N/A'})` : 'Not Assigned';
                    const appointmentTime = new Date(appointment.appointment_date).toLocaleString();

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${patient.patient_id || 'N/A'}</td>
                        <td>${patient.first_name || ''} ${patient.last_name || ''}</td>
                        <td>${patient.age >= 0 ? patient.age : 'N/A'}</td>
                        <td>${patient.contact_number || 'N/A'}</td>
                        <td>${patient.current_illness || 'N/A'}</td>
                        <td>${appointmentTime}</td>
                        <td>${doctorName}</td>
                        <td>${appointment.status || 'N/A'}</td>
                        <td>${appointment.created_by_username || 'N/A'}</td>
                        <td>${appointment.updated_by_username || 'N/A'}</td>
                        <td>${appointment.notes || 'N/A'}</td>
                        <td>
                            <button class="btn btn-primary btn-sm" onclick="openEditModal(${JSON.stringify(appointment).replace(/"/g, '&quot;')}, ${index})">Edit</button>
                            <button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id})">Cancel</button>
                            <button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id}, '${appointment.appointment_date}')">Reschedule</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            // Apply filters and refresh appointments
            function applyFilters() {
                const searchTerm = document.getElementById('appointmentFilter').value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                const dateFilter = document.getElementById('dateFilter').value;

                const headers = getAuthHeaders();
                let url = 'http://smarthospitalmaintain.com:8000/appointments/list/';
                if (searchTerm || statusFilter || dateFilter) {
                    url += '?';
                    if (searchTerm) url += `search=${encodeURIComponent(searchTerm)}&`;
                    if (statusFilter) url += `status=${encodeURIComponent(statusFilter)}&`;
                    if (dateFilter) url += `appointment_date=${encodeURIComponent(dateFilter)}&`;
                    url = url.slice(0, -1); // Remove trailing &
                }

                $.ajax({
                    url: url,
                    type: 'GET',
                    headers: headers,
                    success: function(response) {
                        console.log('Filtered appointments:', response);
                        const appointments = response.appointments || [];
                        // Clear all tabs and repopulate with filtered data
                        ['Waiting', 'Scheduled', 'Pending', 'Active', 'Completed', 'Canceled', 'Rescheduled'].forEach(status => {
                            populateAppointmentsTable(appointments, status.toLowerCase());
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error('Error applying filters:', error);
                        showModal('Failed to apply filters. Please try again.', 'error');
                    }
                });
            }

            // Show appointment form
            function showAppointmentForm() {
                $("#appointmentFormContainer").show();
                $("#appointmentTabs .nav-link").removeClass("active");
                // $("#appointmentTabs a[href='#waiting']").tab('show');
            }

            // Hide appointment form
            function hideAppointmentForm() {
                $("#appointmentFormContainer").hide();
                $("#appointmentForm")[0].reset();
                $(".form-control").removeClass("is-invalid");
            }

            // Calculate age based on date of birth
            document.getElementById('dateOfBirth').addEventListener('change', function() {
                const dob = new Date(this.value);
                const age = new Date().getFullYear() - dob.getFullYear();
                document.getElementById('age').value = age;
            });

            document.getElementById('editDateOfBirth').addEventListener('change', function() {
                const dob = new Date(this.value);
                const today = new Date();
                let age = today.getFullYear() - dob.getFullYear();
                const monthDiff = today.getMonth() - dob.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
                    age--;
                }
                document.getElementById('editAge').value = age >= 0 ? age : '';
            });

            // Date field restrictions
            $(document).ready(function() {
                $("#dateOfBirth").attr("max", new Date().toISOString().split("T")[0]);
                $("#appointmentDate").attr("min", new Date().toISOString().split("T")[0]);
                $("#editDateOfBirth").attr("max", new Date().toISOString().split("T")[0]);
                $("#editAppointmentDate").attr("min", new Date().toISOString().split("T")[0]);
            });

            // Unit conversion for vitals
            document.querySelectorAll(".unit-select").forEach(select => {
                select.addEventListener("change", function() {
                    convertMeasurement(this);
                });
            });

            function convertMeasurement(select) {
                let inputId = select.dataset.input;
                let inputField = document.getElementById(inputId);
                let currentValue = parseFloat(inputField.value);
                let fromUnit = select.getAttribute("data-prev-unit") || select.options[0].value;
                let toUnit = select.value;

                if (isNaN(currentValue)) return;

                let newValue = convertValue(currentValue, fromUnit, toUnit);
                inputField.value = newValue.toFixed(2);

                select.setAttribute("data-prev-unit", toUnit);
            }

            function convertValue(value, fromUnit, toUnit) {
                const conversions = {
                    "cm": { "in": value / 2.54 },
                    "in": { "cm": value * 2.54 },
                    "kg": { "lbs": value * 2.20462 },
                    "lbs": { "kg": value / 2.20462 },
                    "°C": { "°F": (value * 9/5) + 32 },
                    "°F": { "°C": (value - 32) * 5/9 },
                    "mmHg": { "kPa": value * 0.133322 },
                    "kPa": { "mmHg": value / 0.133322 }
                };
                return conversions[fromUnit]?.[toUnit] || value;
            }

            // Validate vitals
            function validateVitals() {
                let valid = true;
                document.querySelectorAll("#vitalsForm input").forEach(input => {
                    let value = input.value.trim();
                    if (value && isNaN(value)) {
                        valid = false;
                        input.classList.add("is-invalid");
                    } else {
                        input.classList.remove("is-invalid");
                    }
                });
                return valid;
            }

            // Add appointment
            function addAppointment() {
                const doctorId = $("#doctor").val();
                const patientId = $("#patientID").val().trim();
                const appointmentDate = $("#appointmentDate").val();
                const dateOfBirth = $("#dateOfBirth").val();
                const firstName = $("#firstName").val().trim();
                const lastName = $("#lastName").val().trim();
                const contactNumber = $("#contactNumber").val().trim();
                const notes = $("#notes").val().trim();
                const isEmergency = $("#isEmergency").is(":checked");
                const currentIllness = $("#currentIllness").val().trim();

                $(".form-control").removeClass("is-invalid");

                let missingFields = [];
                if (!doctorId) missingFields.push("Doctor");
                if (!patientId) missingFields.push("Patient ID");
                if (!firstName) missingFields.push("First Name");
                if (!lastName) missingFields.push("Last Name");
                if (!contactNumber) missingFields.push("Contact Number");
                if (!appointmentDate) missingFields.push("Appointment Date");

                if (missingFields.length > 0) {
                    missingFields.forEach(field => $(`#${field.toLowerCase().replace(/ /g, '')}`).addClass("is-invalid"));
                    showModal(`Please fill in the following required fields: ${missingFields.join(", ")}`, 'error');
                    return;
                }

                const contactRegex = /^\d{10}$/;
                if (!contactRegex.test(contactNumber)) {
                    $("#contactNumber").addClass("is-invalid");
                    showModal("Contact Number must be exactly 10 digits.", 'error');
                    return;
                }

                if (dateOfBirth && new Date(dateOfBirth) > new Date()) {
                    $("#dateOfBirth").addClass("is-invalid");
                    showModal("Date of birth cannot be in the future.", 'error');
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                if (new Date(appointmentDate) < today) {
                    $("#appointmentDate").addClass("is-invalid");
                    showModal("Appointment date cannot be in the past.", 'error');
                    return;
                }

                const age = dateOfBirth ? calculateAge(dateOfBirth) : null;
                if (age !== null && age < 0) {
                    $("#dateOfBirth").addClass("is-invalid");
                    showModal("Invalid Date of Birth.", 'error');
                    return;
                }

                if (age !== null) $("#age").val(age);

                const appointmentData = {
                    appointment: {
                        patient_id: patientId,
                        first_name: firstName,
                        last_name: lastName,
                        contact_number: contactNumber,
                        date_of_birth: dateOfBirth,
                        current_illness: currentIllness || null,
                    },
                    appointment_date: appointmentDate,
                    doctor: doctorId,
                    notes: notes || null,
                    is_emergency: isEmergency,
                };

                $.ajax({
                    url: "http://smarthospitalmaintain.com:8000/appointments/create/",
                    type: "POST",
                    headers: getAuthHeaders(),
                    data: JSON.stringify(appointmentData),
                    contentType: "application/json",
                    success: function(response) {
                        console.log("✅ Appointment created:", response);
                        const appointmentId = response.appointment?.id;
                        if (!appointmentId) {
                            showModal("Error: Appointment ID missing.", 'error');
                            return;
                        }
                        hideAppointmentForm();
                        fetchAppointments(); // Refresh all tabs
                        $("#vitalsModal").data("appointmentId", appointmentId).modal("show");
                    },
                    error: function(xhr, status, error) {
                        console.error("❌ Error creating appointment:", error);
                        showModal("Failed to create appointment. Please try again.", 'error');
                    }
                });
            }

            // Fetch patient details on patient ID input blur
            $(document).ready(function() {
                $("#patientID").on("blur", function() {
                    let patientId = $(this).val().trim();
                    if (patientId) {
                        $.ajax({
                            url: `http://smarthospitalmaintain.com:8000/appointments/get-patient-details/${patientId}/`,
                            type: "GET",
                            headers: getAuthHeaders(),
                            success: function(response) {
                                console.log("Patient details fetched:", response);
                                if (response.patient) {
                                    $("#firstName").val(response.patient.first_name || '');
                                    $("#lastName").val(response.patient.last_name || '');
                                    $("#contactNumber").val(response.patient.contact_number || '');
                                    $("#dateOfBirth").val(response.patient.date_of_birth || '');
                                    $("#currentIllness").val(response.patient.current_illness || '');
                                    const age = calculateAge(response.patient.date_of_birth);
                                    $("#age").val(age >= 0 ? age : '');
                                }
                            },
                            error: function(xhr) {
                                console.log("Patient not found, user can enter details manually.");
                            }
                        });
                    }
                });
            });

            // Calculate age
            function calculateAge(dob) {
                const birthDate = new Date(dob);
                const today = new Date();
                let age = today.getFullYear() - birthDate.getFullYear();
                const monthDiff = today.getMonth() - birthDate.getMonth();
                if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            // Save vitals
            function saveVitals() {
                const appointmentId = $("#vitalsModal").data("appointmentId");
                if (!appointmentId) {
                    showModal("Appointment ID is missing. Please try again.", 'error');
                    return;
                }

                const vitalsData = {
                    appointment: appointmentId,
                    blood_pressure: $("#modalBloodPressure").val().trim() || null,
                    heart_rate: $("#modalHeartRate").val().trim() || null,
                    temperature: $("#modalTemperature").val().trim() || null,
                    respiratory_rate: $("#modalRespiratoryRate").val().trim() || null,
                    oxygen_saturation: $("#modalOxygenSaturation").val().trim() || null,
                    weight: $("#modalWeight").val().trim() || null,
                    height: $("#modalHeight").val().trim() || null,
                };

                Object.keys(vitalsData).forEach(key => {
                    if (vitalsData[key] === null) delete vitalsData[key];
                });

                $.ajax({
                    url: `http://smarthospitalmaintain.com:8000/appointments/vitals/${appointmentId}/`,
                    type: 'POST',
                    headers: getAuthHeaders(),
                    data: JSON.stringify(vitalsData),
                    contentType: 'application/json',
                    success: function(response) {
                        console.log('✅ Vitals saved successfully:', response);
                        $("#vitalsModal").modal("hide");
                        showModal("Vitals saved successfully.", 'success');
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Error saving vitals:', error);
                        const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "Failed to save vitals. Please check the details and try again.";
                        showModal(errorMessage, 'error');
                    }
                });
            }

            // Open edit modal
            function openEditModal(appointment, rowIndex) {
                console.log("Editing Row:", rowIndex, "Appointment Data:", appointment);
                document.getElementById("editAppointmentID").value = appointment.id || '';
                document.getElementById("editPatientID").value = appointment.patient?.patient_id || '';
                document.getElementById("editFirstName").value = appointment.patient?.first_name || '';
                document.getElementById("editLastName").value = appointment.patient?.last_name || '';
                document.getElementById("editContactNumber").value = appointment.patient?.contact_number || '';
                document.getElementById("editDateOfBirth").value = appointment.patient?.date_of_birth || '';
                document.getElementById("editAge").value = appointment.patient?.age >= 0 ? appointment.patient.age : '';
                document.getElementById("editCurrentIllness").value = appointment.patient?.current_illness || '';
                document.getElementById("editAppointmentDate").value = formatDateTime(appointment.appointment_date) || '';
                document.getElementById("editAppointmentStatus").value = appointment.status || '';
                document.getElementById("editNotes").value = appointment.notes || '';
                document.getElementById("editIsEmergency").checked = appointment.is_emergency || false;

                loadDoctors(appointment.doctor?.id);
                $("#editAppointmentModal").modal("show");
            }

            // Update appointment
            function updateAppointment() {
                const appointmentId = document.getElementById("editAppointmentID").value;
                const updatedAppointment = {
                    patient_id: document.getElementById("editPatientID").value,
                    date_of_birth: document.getElementById("editDateOfBirth").value,
                    current_illness: document.getElementById("editCurrentIllness").value,
                    doctor_id: document.getElementById("editDoctor").value,
                    appointment_date: document.getElementById("editAppointmentDate").value,
                    status: document.getElementById("editAppointmentStatus").value,
                    notes: document.getElementById("editNotes").value,
                    is_emergency: document.getElementById("editIsEmergency").checked,
                };

                $.ajax({
                    url: `http://smarthospitalmaintain.com:8000/appointments/edit/${appointmentId}/`,
                    type: 'PATCH',
                    headers: getAuthHeaders(),
                    data: JSON.stringify(updatedAppointment),
                    contentType: 'application/json',
                    success: function(response) {
                        console.log("Appointment updated successfully:", response);
                        showModal("Appointment updated successfully!", 'success');
                        $("#editAppointmentModal").modal("hide");
                        fetchAppointments(); // Refresh all tabs
                    },
                    error: function(xhr, status, error) {
                        console.error("Error updating appointment:", error);
                        showModal("Failed to update appointment: " + (xhr.responseJSON?.error || "Server Fetch Error"), 'error');
                    }
                });
            }

            // Open reschedule modal
            function openRescheduleModal(appointmentId) {
                document.getElementById("rescheduleAppointmentID").value = appointmentId;
                document.getElementById("newAppointmentDate").value = '';
                $("#rescheduleAppointmentModal").modal("show");
            }

            // Reschedule appointment
            function rescheduleAppointment() {
                const appointmentId = document.getElementById("rescheduleAppointmentID").value;
                const newDate = document.getElementById("newAppointmentDate").value;

                if (!newDate) {
                    showModal("Please select a new appointment date and time.", 'error');
                    return;
                }

                $.ajax({
                    url: `http://smarthospitalmaintain.com:8000/appointments/reschedule/${appointmentId}/`,
                    type: 'PATCH',
                    headers: getAuthHeaders(),
                    data: JSON.stringify({ appointment_date: newDate, status: "Rescheduled" }),
                    contentType: 'application/json',
                    success: function(response) {
                        console.log("Appointment rescheduled successfully:", response);
                        showModal("Appointment rescheduled successfully!", 'success');
                        $("#rescheduleAppointmentModal").modal("hide");
                        fetchAppointments(); // Refresh all tabs
                    },
                    error: function(xhr, status, error) {
                        console.error("Error rescheduling appointment:", error);
                        showModal("Failed to reschedule appointment: " + (xhr.responseJSON?.error || "Server Fetch Error"), 'error');
                    }
                });
            }

            // Cancel appointment
            function cancelAppointment(appointmentId) {
                if (!confirm("Are you sure you want to cancel this appointment?")) return;

                $.ajax({
                    url: `http://smarthospitalmaintain.com:8000/appointments/cancel/${appointmentId}/`,
                    type: 'PATCH',
                    headers: getAuthHeaders(),
                    data: JSON.stringify({ status: "Canceled" }),
                    contentType: 'application/json',
                    success: function(response) {
                        console.log("Appointment canceled successfully:", response);
                        showModal("Appointment canceled successfully!", 'success');
                        fetchAppointments(); // Refresh all tabs
                    },
                    error: function(xhr, status, error) {
                        console.error("Error canceling appointment:", error);
                        showModal("Failed to cancel appointment: " + (xhr.responseJSON?.error || "Server Fetch Error"), 'error');
                    }
                });
            }

            // Load doctors for dropdowns
            function loadDoctors(selectedId = null) {
                $.ajax({
                    url: "http://smarthospitalmaintain.com:8000/appointments/doctors/list/",
                    type: "GET",
                    headers: getAuthHeaders(),
                    success: function(response) {
                        const doctorSelect = $("#doctor");
                        const editDoctorSelect = $("#editDoctor");
                        doctorSelect.empty();
                        editDoctorSelect.empty();
                        doctorSelect.append('<option value="" disabled selected>Select a doctor</option>');
                        editDoctorSelect.append('<option value="" disabled selected>Select a doctor</option>');

                        response.doctors.forEach(doctor => {
                            const option = `<option value="${doctor.id}" ${doctor.id === selectedId ? 'selected' : ''}>Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}</option>`;
                            doctorSelect.append(option);
                            editDoctorSelect.append(option);
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("❌ Error fetching doctors:", error);
                        showModal("Failed to load doctors. Please try again.", 'error');
                    }
                });
            }

            // Initialize page
            $(document).ready(function() {
                checkSessionOnLoad();
                loadDoctors();
                // Fetch appointments for all tabs on load
                ['Waiting', 'Scheduled', 'Pending', 'Active', 'Completed', 'Canceled', 'Rescheduled'].forEach(status => {
                    fetchAppointments(status.toLowerCase());
                });

                // Store and restore active tab
                var activeTab = localStorage.getItem("activeTab");
                if (activeTab) {
                    $("#appointmentTabs a[href='" + activeTab + "']").tab("show");
                }
                $("#appointmentTabs a").on("shown.bs.tab", function(e) {
                    localStorage.setItem("activeTab", $(e.target).attr("href"));
                });

                // Add event listener for filters
                $('#appointmentFilter, #statusFilter, #dateFilter').on('input change', applyFilters);
            });

            // Show notification
            function showNotification(message, duration = 3000) {
                const notification = document.getElementById("customNotification");
                const messageContainer = document.getElementById("notificationMessage");
                messageContainer.textContent = message;
                notification.style.display = "block";
                notification.style.animation = `fadeInOut ${duration / 1000}s ease-in-out`;
                setTimeout(() => {
                    notification.style.display = "none";
                }, duration);
            }

            // Show modal
            function showModal(message, type = 'success') {
                const modal = document.getElementById("messageModal");
                const modalMessage = document.getElementById("modalMessage");
                modalMessage.textContent = message;
                if (type === 'success') {
                    modalMessage.classList.add("success-message");
                    modalMessage.classList.remove("error-message");
                } else if (type === 'error') {
                    modalMessage.classList.add("error-message");
                    modalMessage.classList.remove("success-message");
                }
                modal.style.display = "block";
            }

            // Close modal
            document.querySelector(".close-btn").onclick = function() {
                document.getElementById("messageModal").style.display = "none";
            };
            window.onclick = function(event) {
                if (event.target == document.getElementById("messageModal")) {
                    document.getElementById("messageModal").style.display = "none";
                }
            };

            // International phone input
            document.addEventListener("DOMContentLoaded", function() {
                const phoneInputs = ["#contactNumber", "#editContactNumber"];
                phoneInputs.forEach(selector => {
                    const input = document.querySelector(selector);
                    if (input) {
                        const iti = window.intlTelInput(input, {
                            initialCountry: "in",
                            preferredCountries: ["in", "us", "gb", "ke", "ng"],
                            separateDialCode: true,
                            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
                        });
                        input.addEventListener("blur", function() {
                            console.log(`Full Phone Number (${selector}):`, iti.getNumber());
                        });
                    }
                });
            });
        </script>
    </body>
</html>