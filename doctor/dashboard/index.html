<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Kerala | Doctors</title>

  <!-- CSS -->
  <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
  <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
  <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
  <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="shortcut icon" href="assets/images/favicon.png">

  <!-- JavaScript -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
  <!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
     // Basic displayAlert function (if not already defined)
       // Enhanced notification function with type parameter
       function displayAlert(message, type = "danger", duration = 4000) {
        const alertId = `alert-${Date.now()}`;
        const alertHtml = `
          <div class="alert alert-${type} alert-dismissible fade show" role="alert" id="${alertId}">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        `;
        $("#alertContainer").prepend(alertHtml);
        
        // Auto-dismiss after duration
        if (duration > 0) {
          setTimeout(() => $(`#${alertId}`).alert("close"), duration);
        }
      
        // Log to console
        console.log(`[${type.toUpperCase()}] ${message}`);
      }
      
      // Helper to extract error messages from AJAX responses
      function getErrorMessage(xhr, defaultMsg) {
        const errorMsg = xhr.responseJSON?.error || xhr.responseText || defaultMsg;
        console.error(`AJAX Error: ${xhr.status} - ${errorMsg}`, xhr);
        return errorMsg;
      }


$(document).ready(function() {
  // Initialize Flatpickr for all custom-datetime-picker inputs
  function initializeDatePickers() {
    $(".custom-datetime-picker").each(function() {
      const $input = $(this);
      const isDateOnly = $input.attr("id") === "searchDob" || $input.attr("id") === "searchDate" || $input.attr("id") === "patientDob" || $input.attr("id") === "dateOfBirth" || $input.attr("id") === "editDateOfBirth";
      const config = {
        altInput: true,
        altFormat: isDateOnly ? "F j, Y" : "F j, Y, h:i K", // Readable format
        dateFormat: isDateOnly ? "Y-m-d" : "Y-m-d H:i", // Backend format
        enableTime: !isDateOnly,
        time_24hr: false,
        minDate: $input.attr("id") === "appointmentDate" || $input.attr("id") === "editAppointmentDate" || $input.attr("id") === "newAppointmentDate" ? "today" : null,
        maxDate: $input.attr("id") === "dateOfBirth" || $input.attr("id") === "editDateOfBirth" || $input.attr("id") === "patientDob" ? "today" : null,
        appendTo: document.body, // Ensure it works with modals
        position: "auto", // Dynamically adjust position (above/below/left/right)
        // Remove static: true to allow dynamic positioning
        onOpen: function(selectedDates, dateStr, instance) {
          // Adjust calendar position to stay within viewport
          const calendar = instance.calendarContainer;
          const inputRect = $input[0].getBoundingClientRect();
          const calendarRect = calendar.getBoundingClientRect();
          const viewportHeight = window.innerHeight;
          const viewportWidth = window.innerWidth;

          // Reset any previous adjustments
          calendar.style.top = "";
          calendar.style.left = "";
          calendar.style.bottom = "";
          calendar.style.right = "";

          // Check if calendar overflows bottom
          if (inputRect.bottom + calendarRect.height > viewportHeight) {
            calendar.style.top = "auto";
            calendar.style.bottom = (viewportHeight - inputRect.top) + "px";
          } else {
            calendar.style.top = inputRect.bottom + "px";
            calendar.style.bottom = "auto";
          }

          // Check if calendar overflows right
          if (inputRect.left + calendarRect.width > viewportWidth) {
            calendar.style.left = "auto";
            calendar.style.right = (viewportWidth - inputRect.right) + "px";
          } else {
            calendar.style.left = inputRect.left + "px";
            calendar.style.right = "auto";
          }
        },
        onReady: function(selectedDates, dateStr, instance) {
          const buttonContainer = document.createElement("div");
          buttonContainer.style.display = "flex";
          buttonContainer.style.justifyContent = "center";
          buttonContainer.style.gap = "10px"; // Space between buttons
          buttonContainer.style.padding = "5px";

          // OK Button
          const confirmButton = document.createElement("button");
          confirmButton.innerText = "OK";
          confirmButton.className = "flatpickr-confirm";
          confirmButton.onclick = function() {
            if (selectedDates.length > 0) {
              instance.close();
              $input.removeClass("is-invalid");
            } else {
              instance.close(); // Close the picker
            }
          };

          // Clear Button
          const clearButton = document.createElement("button");
          clearButton.innerText = "Clear";
          clearButton.className = "flatpickr-clear";
          clearButton.onclick = function() {
            instance.clear(); // Clear the selected date
            $input.val(""); // Clear the input value
            $input.removeClass("is-invalid");
            instance.close(); // Close the picker
          };

          // Append buttons to container
          buttonContainer.appendChild(confirmButton);
          buttonContainer.appendChild(clearButton);
          instance.calendarContainer.appendChild(buttonContainer);
        },
        onClose: function(selectedDates, dateStr, instance) {
          if (selectedDates.length === 0) {
            $input.val(""); // Clear if no selection confirmed
          }
        }
      };

      flatpickr($input[0], config);

      // Maintain readonly state if applicable
      if ($input.attr("readonly")) {
        $input.next(".flatpickr-input").prop("readonly", true);
      }
    });
  }

  // Call initialization on page load
  initializeDatePickers();

  // Re-initialize when modals are shown to ensure pickers work inside modals
  $("#createPatientModal, #appointmentFormContainer, #editAppointmentModal, #rescheduleAppointmentModal").on("shown.bs.modal", function() {
    initializeDatePickers();
  });

  // Existing code...
  checkSessionOnLoad();
  $("#logoutButton, #logoutDropdown").on("click", logoutUser);
});
  </script>

  <!-- Custom Styles -->
  <style>
    /* Style the Flatpickr calendar */
.flatpickr-calendar {
  z-index: 1200; /* Ensure it appears above modals */
  border-radius: 5px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.flatpickr-day.selected {
  background-color: #007bff;
  color: white;
}

/* Custom OK button styling */
.flatpickr-confirm {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
}

/* Custom Clear button styling */
.flatpickr-clear {
  background-color: #dc3545; /* Red for clear, matches Bootstrap danger */
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
}

.flatpickr-confirm:hover {
  background-color: #0056b3;
}

.flatpickr-clear:hover {
  background-color: #c82333;
}
    #customNotification .modal-content {
      border: none;
      border-radius: 0.5rem;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    #customNotification.success-message .modal-body {
      background-color: #d4edda;
      color: #155724;
    }
    
    #customNotification.error-message .modal-body {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      20% { opacity: 1; transform: translateY(0); }
      80% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
    
    
    /* Ensure tab content is scrollable if too tall */
.tab-content {
  max-height: 400px; /* Adjust as needed */
  overflow-y: auto;
}

/* Style for disabled tabs */
.nav-tabs .nav-link.disabled {
  color: #6c757d;
  pointer-events: none;
  background-color: #e9ecef;
}
#alertContainer .alert {
  margin-bottom: 10px;
  animation: fadeInOut 0.5s ease-in-out;
}
    .table-responsive {
      max-height: 400px;
      overflow-y: auto;
      position: relative;
    }
    .table {
      table-layout: auto;
      width: 100%;
      border-collapse: collapse;
    }
    .table th, .table td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 14px;
      padding: 8px;
      text-align: left;
    }
    .table thead th {
      position: sticky;
      top: 0;
      background-color: #fff;
      z-index: 1;
    }
    .table .btn {
      font-size: 12px;
      padding: 5px 8px;
      margin: 2px;
    }
    .search-filter {
      margin-bottom: 15px;
    }
    .search-filter input, .search-filter select {
      font-size: 14px;
      padding: 6px;
    }
    .modal-content {
      border-radius: 5px;
    }
    .success-message { color: green; }
    .error-message { color: red; }
    /* Ensure modals stack correctly */
    .modal {
      z-index: 1055; /* Default Bootstrap modal z-index is 1050, increase for stacking */
    }
    .form-control-sm, .form-select-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.875rem;
    }
    .form-control.is-invalid, .form-select.is-invalid {
      border-color: #dc3545;
    }
    .form-control.is-invalid:focus, .form-select.is-invalid:focus {
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }
    label {
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }
    .modal-body {
      padding: 1rem;
      max-height: 70vh;
      overflow-y: auto;
    }

     /* Add styling for the new patient search filter */
     .patient-search-container {
      margin-bottom: 20px;
    }
    #patientSearchInput {
      width: 100%;
      padding: 8px;
      font-size: 14px;
    }
    #patientSearchResults {
      position: absolute;
      z-index: 1060; /* Above modals */
      background: white;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      width: calc(100% - 30px); /* Match input width */
    }
    #patientSearchResults div {
      padding: 8px;
      cursor: pointer;
    }
    #patientSearchResults div:hover {
      background-color: #f0f0f0;
    }
    .modal-backdrop {
      z-index: 1050; /* Ensure backdrop is below modal */
    }
    @media (max-width: 768px) {
      .table th, .table td { font-size: 12px; padding: 6px; }
      .table .btn { font-size: 10px; padding: 4px 6px; }
      .search-filter input, .search-filter select { font-size: 12px; }
    }
    @media (max-width: 480px) {
      .table th, .table td { font-size: 10px; padding: 4px; }
      .table .btn { font-size: 9px; padding: 3px 5px; }
    }
    .search-filter label {
      font-size: 14px;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <div class="container-scroller">
    <!-- Top Banner -->
    <div class="row p-0 m-0 proBanner" id="proBanner">
      <div class="col-md-12 p-0 m-0">
        <div class="card-body card-body-padding d-flex align-items-center justify-content-between">
          <div class="ps-lg-3">
            <p class="mb-0 font-weight-medium me-3 buy-now-text">Free 24/7 customer support, updates</p>
            <a href="#" target="_blank" class="btn me-2 buy-now-btn border-0">Book Appointment</a>
          </div>
          <div class="d-flex align-items-center">
            <a href="#"><i class="mdi mdi-home me-3 text-white"></i></a>
            <button id="bannerClose" class="btn border-0 p-0"><i class="mdi mdi-close text-white"></i></button>
          </div>
        </div>
      </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar default-layout-navbar col-lg-12 col-12 p-0 fixed-top d-flex flex-row">
      <div class="text-center navbar-brand-wrapper d-flex align-items-center justify-content-start">
        <a class="navbar-brand brand-logo" href="index.html"><img src="assets/images/logo.png" alt="logo" height="190px"></a>
      </div>
      <div class="navbar-menu-wrapper d-flex align-items-stretch">
        <button class="navbar-toggler navbar-toggler align-self-center" type="button" data-bs-toggle="minimize">
          <span class="mdi mdi-menu"></span>
        </button>
        <div class="search-field d-none d-md-block">
          <form class="d-flex align-items-center h-100">
            <div class="input-group">
              <div class="input-group-prepend bg-transparent">
                <i class="input-group-text border-0 mdi mdi-magnify"></i>
              </div>
              <input type="text" class="form-control bg-transparent border-0" placeholder="Search patients, appointments">
            </div>
          </form>
        </div>

        <ul class="navbar-nav navbar-nav-right">
          <li class="nav-item nav-profile dropdown">
            <a class="nav-link dropdown-toggle" id="profileDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <div class="nav-profile-img">
                <img src="assets/images/placeholder-doctor.jpg" alt="profile" id="doctor-profile-picture">
                <span class="availability-status online"></span>
              </div>
              <div class="nav-profile-text">
                <p class="mb-1 text-black"><span id="logged_in_user_name"></span></p>
              </div>
            </a>
            <div class="dropdown-menu navbar-dropdown" aria-labelledby="profileDropdown">
              <a class="dropdown-item" href="#"><i class="mdi mdi-account-circle me-2 text-success"></i> My Profile</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="#" id="logoutDropdown"><i class="mdi mdi-logout me-2 text-primary"></i> Logout</a>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" id="messageDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="mdi mdi-email-outline"></i>
              <span class="count-symbol bg-warning" id="message-count">3</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="messageDropdown">
              <h6 class="p-3 mb-0">Messages</h6>
              <div id="message-list"><p class="text-gray mb-0 text-center">No new messages</p></div>
              <div class="dropdown-divider"></div>
              <h6 class="p-3 mb-0 text-center">See all messages</h6>
            </div>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link count-indicator dropdown-toggle" id="notificationDropdown" href="#" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="mdi mdi-bell-outline"></i>
              <span class="count-symbol bg-danger" id="notification-count">5</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end navbar-dropdown preview-list" aria-labelledby="notificationDropdown">
              <h6 class="p-3 mb-0">Notifications</h6>
              <div id="notification-list"><p class="text-gray mb-0 text-center">No new notifications</p></div>
              <div class="dropdown-divider"></div>
              <h6 class="p-3 mb-0 text-center">See all notifications</h6>
            </div>
          </li>
          <li class="nav-item nav-logout d-none d-lg-block">
            <a class="nav-link" href="#" id="logoutButton"><i class="mdi mdi-power"> Logout</i></a>
          </li>
        </ul>
        <button class="navbar-toggler navbar-toggler-right d-lg-none align-self-center" type="button" data-bs-toggle="offcanvas">
          <span class="mdi mdi-menu"></span>
        </button>
      </div>
    </nav>
<!-- Custom Notification Modal -->
<div class="modal fade" id="customNotification" tabindex="-1" aria-hidden="true" style="z-index: 1060;">
  <div class="modal-dialog modal-dialog-centered modal-sm">
    <div class="modal-content">
      <div class="modal-body text-center" id="notificationMessage">
        <!-- Message will be injected here -->
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
    <!-- Main Content -->
    <div class="container-fluid page-body-wrapper">
      <!-- Sidebar -->
      <nav class="sidebar sidebar-offcanvas" id="sidebar">
        <ul class="nav">
          <li class="nav-item nav-profile">
            <a href="#" class="nav-link">
              <div class="nav-profile-image">
                <img src="assets/images/faces/face1.jpg" alt="profile">
                <span class="login-status online"></span>
              </div>
              <div class="nav-profile-text d-flex flex-column">
                <span class="font-weight-bold mb-2">Dr. David Grey</span>
                <span class="text-secondary text-small">Cardiologist</span>
              </div>
              <i class="mdi mdi-stethoscope text-primary nav-profile-badge"></i>
            </a>
          </li>
          <li class="nav-item"><a class="nav-link" href="index.html"><span class="menu-title">Dashboard</span><i class="mdi mdi-home menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="patients.html"><span class="menu-title">Patients</span><i class="mdi mdi-account-group menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="appointments.html"><span class="menu-title">Appointments</span><i class="mdi mdi-calendar-check menu-icon"></i></a></li>
          <li class="nav-item">
            <a class="nav-link" data-bs-toggle="collapse" href="#medical-records" aria-expanded="false" aria-controls="medical-records">
              <span class="menu-title">Medical Records</span><i class="menu-arrow"></i><i class="mdi mdi-folder-multiple menu-icon"></i>
            </a>
            <div class="collapse" id="medical-records">
              <ul class="nav flex-column sub-menu">
                <li class="nav-item"><a class="nav-link" href="records/view-records.html">View Records</a></li>
                <li class="nav-item"><a class="nav-link" href="records/upload-records.html">Upload Records</a></li>
              </ul>
            </div>
          </li>
          <li class="nav-item"><a class="nav-link" href="prescriptions.html"><span class="menu-title">Prescriptions</span><i class="mdi mdi-pill menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="reports.html"><span class="menu-title">Reports</span><i class="mdi mdi-chart-bar menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="lab-tests.html"><span class="menu-title">Lab Tests</span><i class="mdi mdi-flask-outline menu-icon"></i></a></li>
          <li class="nav-item"><a class="nav-link" href="settings.html"><span class="menu-title">Settings</span><i class="mdi mdi-settings menu-icon"></i></a></li>
        </ul>
      </nav>

      <!-- Main Panel -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="page-header">
            <h3 class="page-title">
              <span class="page-title-icon bg-gradient-primary text-white me-2"><i class="mdi mdi-home"></i></span> Dashboard
            </h3>
            <nav aria-label="breadcrumb">
              <ul class="breadcrumb">
                <li class="breadcrumb-item active" aria-current="page">
                  Welcome, <span id="logged_in_user_name_breadcrumb"></span> - Good <span id="timeOfDay">Morning</span>
                </li>
              </ul>
            </nav>
          </div>
          <div class="container-fluid page-body-wrapper">
            <div class="main-panel">
              <div class="content-wrapper">
                <div id="alertContainer" class="mb-3"></div> <!-- Alert container -->
                <!-- Rest of your content -->
              </div>
            </div>
          </div>
          <!-- Notification Modal -->
          <div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="notificationModalLabel">Notification</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p id="notificationMessage"></p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
           <!-- New Patient Search Filter -->
           <div class="row g-2">
            <div class="col-md-12">
              <div class="patient-search-container">
                <input type="text" class="form-control" id="patientSearchInput" placeholder="Search for a patient (Name, ID, Mobile, DOB) to make an appointment...">
                <div id="patientSearchResults" class="dropdown-menu" style="display: none;"></div>
              </div>
            </div>
          </div>

          <!-- Tabbed Table Section -->
          <div class="row">
            <div class="col-md-12 stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Current Patient Details & Appointments</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <div>
                      <button class="btn btn-success btn-sm d-none me-2" id="cancelBtn" onclick="bulkCancel()">Cancel</button>
                      <button class="btn btn-warning btn-sm d-none" id="rescheduleBtn" onclick="bulkReschedule()">Reschedule</button>
                    </div>
                    <button class="btn btn-primary btn-sm"><a href="search.html" class="text-white text-decoration-none">Search Patient</a></button>
                  </div>

                  <!-- Search Filter -->
                  <div class="search-filter row g-2">
                    <div class="col-md-3">
                      <input type="text" class="form-control" id="searchPatientId" placeholder="Patient ID">
                    </div>
                    <div class="col-md-3">
                      <input type="text" class="form-control" id="searchName" placeholder="Patient Name">
                    </div>
                    <div class="col-md-2">
                      <input type="text" class="form-control" id="searchMobile" placeholder="Mobile Number">
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                      <label for="searchDob" class="me-2">DOB:</label>
                      <input type="text" class="form-control custom-datetime-picker" id="searchDob">
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                      <label for="searchDate" class="me-2">Appt. Date:</label>
                      <input type="text" class="form-control custom-datetime-picker" id="searchDate">
                    </div>
                  </div>

                  <!-- Tabs -->
                  <ul class="nav nav-tabs" id="appointmentTabs" role="tablist">
                    <li class="nav-item"><a class="nav-link active" id="waiting-tab" data-bs-toggle="tab" href="#waiting" role="tab">Waiting in Clinic</a></li>
                    <li class="nav-item"><a class="nav-link" id="scheduled-tab" data-bs-toggle="tab" href="#scheduled" role="tab">Scheduled</a></li>
                    <li class="nav-item"><a class="nav-link" id="pending-tab" data-bs-toggle="tab" href="#pending" role="tab">Pending</a></li>
                    <li class="nav-item"><a class="nav-link" id="completed-tab" data-bs-toggle="tab" href="#completed" role="tab">Completed</a></li>
                    <li class="nav-item"><a class="nav-link" id="canceled-tab" data-bs-toggle="tab" href="#canceled" role="tab">Canceled</a></li>
                    <li class="nav-item"><a class="nav-link" id="rescheduled-tab" data-bs-toggle="tab" href="#rescheduled" role="tab">Rescheduled</a></li>
                  </ul>

                  <!-- Tab Content -->
                  <div class="tab-content mt-3" id="appointmentTabContent">
                    <div class="tab-pane fade show active" id="waiting" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Waiting-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="scheduled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Scheduled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="pending" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Pending-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="completed" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Completed-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="canceled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Canceled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                    <div class="tab-pane fade" id="rescheduled" role="tabpanel">
                      <button class="btn btn-primary btn-sm mb-3" onclick="showAppointmentForm()">Add Appointment</button>
                      <div class="table-responsive">
                        <table class="table">
                          <thead><tr></tr></thead>
                          <tbody id="Rescheduled-tbody"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

             <!-- New Patient Details Modal -->
             <div class="modal fade" id="patientDetailsModal" tabindex="-1" aria-labelledby="patientDetailsModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="patientDetailsModalLabel">Patient Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="patientDetailsContent">
                    <!-- Patient details will be populated here -->
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="makeAppointmentFromPatientBtn">Make Appointment</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
         <!-- Create Patient Modal -->
<div class="modal fade" id="createPatientModal" tabindex="-1" aria-labelledby="createPatientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createPatientModalLabel">Create New Patient</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="createPatientForm">
          <!-- Accordion Sections -->
          <div class="accordion" id="patientFormAccordion">
            <!-- Basic Information Section (Expanded by Default) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingBasic">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBasic" aria-expanded="true" aria-controls="collapseBasic">
                  Basic Information
                </button>
              </h2>
              <div id="collapseBasic" class="accordion-collapse collapse show" aria-labelledby="headingBasic" data-bs-parent="#patientFormAccordion">
                <div class="accordion-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="patientFirstName">First Name <span class="text-danger">*</span></label>
                      <input type="text" id="patientFirstName" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-6">
                      <label for="patientLastName">Last Name <span class="text-danger">*</span></label>
                      <input type="text" id="patientLastName" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-4">
                      <label for="patientGender">Gender <span class="text-danger">*</span></label>
                      <select id="patientGender" class="form-select form-select-sm" required>
                        <option value="" disabled selected>Select</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="patientDob">Date of Birth <span class="text-danger">*</span></label>
                      <input type="text" id="patientDob" class="form-control form-control-sm custom-datetime-picker" required>
                    </div>
                    <div class="col-md-4">
                      <label for="patientAge">Age</label>
                      <input type="number" id="patientAge" class="form-control form-control-sm" readonly>
                    </div>
                    <div class="col-md-6">
                      <label for="patientFatherName">Father's Name <span class="text-danger">*</span></label>
                      <input type="text" id="patientFatherName" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-6">
                      <label for="patientAddress">Address</label>
                      <input type="text" id="patientAddress" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="patientCity">City</label>
                      <input type="text" id="patientCity" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="patientPincode">Pincode</label>
                      <input type="number" id="patientPincode" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="patientEmail">Email</label>
                      <input type="email" id="patientEmail" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="patientMobile">Mobile <span class="text-danger">*</span></label>
                      <input type="tel" id="patientMobile" class="form-control form-control-sm" required>
                    </div>
                    <div class="col-md-4">
                      <label for="patientAltMobile">Alt Mobile</label>
                      <input type="tel" id="patientAltMobile" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="patientAadhar">Aadhar</label>
                      <input type="text" id="patientAadhar" class="form-control form-control-sm" maxlength="12">
                    </div>
                    <div class="col-md-4">
                      <label for="admissionType">Admission Type <span class="text-danger">*</span></label>
                      <select id="admissionType" class="form-select form-select-sm" required>
                        <option value="OU" selected>Outpatient</option>
                        <option value="IN">Inpatient</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Medical Information Section (Collapsed by Default) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingMedical">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMedical" aria-expanded="false" aria-controls="collapseMedical">
                  Medical Information
                </button>
              </h2>
              <div id="collapseMedical" class="accordion-collapse collapse" aria-labelledby="headingMedical" data-bs-parent="#patientFormAccordion">
                <div class="accordion-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="patientBloodGroup">Blood Group</label>
                      <select id="patientBloodGroup" class="form-select form-select-sm">
                        <option value="">Select</option>
                        <option value="A+">A+</option>
                        <option value="A-">A-</option>
                        <option value="B+">B+</option>
                        <option value="B-">B-</option>
                        <option value="AB+">AB+</option>
                        <option value="AB-">AB-</option>
                        <option value="O+">O+</option>
                        <option value="O-">O-</option>
                      </select>
                    </div>
                    <div class="col-md-8">
                      <label for="patientAllergies">Allergies</label>
                      <textarea id="patientAllergies" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="patientMedications">Medications</label>
                      <textarea id="patientMedications" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="patientPastHistory">Past History</label>
                      <textarea id="patientPastHistory" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="patientNotes">Notes</label>
                      <textarea id="patientNotes" class="form-control form-control-sm" rows="2"></textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="patientPrimaryDoctor">Primary Doctor</label>
                      <select id="patientPrimaryDoctor" class="form-select form-select-sm">
                        <option value="" disabled selected>Select</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Emergency Contact Section (Collapsed by Default) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingEmergency">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEmergency" aria-expanded="false" aria-controls="collapseEmergency">
                  Emergency Contact
                </button>
              </h2>
              <div id="collapseEmergency" class="accordion-collapse collapse" aria-labelledby="headingEmergency" data-bs-parent="#patientFormAccordion">
                <div class="accordion-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="emergencyName">Name</label>
                      <input type="text" id="emergencyName" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="emergencyRelation">Relationship</label>
                      <input type="text" id="emergencyRelation" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="emergencyNumber">Number</label>
                      <input type="tel" id="emergencyNumber" class="form-control form-control-sm">
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Insurance & Billing Section (Collapsed by Default) -->
            <div class="accordion-item">
              <h2 class="accordion-header" id="headingInsurance">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseInsurance" aria-expanded="false" aria-controls="collapseInsurance">
                  Insurance & Billing
                </button>
              </h2>
              <div id="collapseInsurance" class="accordion-collapse collapse" aria-labelledby="headingInsurance" data-bs-parent="#patientFormAccordion">
                <div class="accordion-body">
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label for="insuranceProvider">Provider</label>
                      <input type="text" id="insuranceProvider" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="policyNumber">Policy No.</label>
                      <input type="text" id="policyNumber" class="form-control form-control-sm">
                    </div>
                    <div class="col-md-4">
                      <label for="paymentPreference">Payment</label>
                      <select id="paymentPreference" class="form-select form-select-sm">
                        <option value="">Select</option>
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Insurance">Insurance</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="savePatientBtn">Save Patient</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
        

          <!-- Appointment Form -->
          <div id="appointmentFormContainer" class="card mt-3" style="display: none;">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title m-0">Create New Appointment</h5>
                <button type="button" class="btn btn-outline-primary" onclick="$('#createPatientModal').modal('show')">Add Patient</button>
              </div>
              <form id="appointmentForm">
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="patientID">Patient ID <span class="text-danger">*</span></label>
                    <input type="text" id="patientID" class="form-control" placeholder="Enter Patient ID" required>
                    <div class="invalid-feedback" id="patientIDFeedback"></div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="firstName">First Name</label>
                    <input type="text" id="firstName" class="form-control" readonly>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="lastName">Last Name</label>
                    <input type="text" id="lastName" class="form-control" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="contactNumber">Contact Number</label>
                    <input type="tel" id="contactNumber" class="form-control" readonly>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="dateOfBirth">Date of Birth</label>
                    <input type="text" id="dateOfBirth" class="form-control custom-datetime-picker" readonly>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="age">Age</label>
                    <input type="number" id="age" class="form-control" readonly>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="appointmentDate">Appointment Date <span class="text-danger">*</span></label>
                    <input type="text" id="appointmentDate" class="form-control custom-datetime-picker" required>
                    <div class="invalid-feedback" id="appointmentDateFeedback"></div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="doctor">Doctor <span class="text-danger">*</span></label>
                    <select id="doctor" class="form-control" required>
                      <option value="" disabled selected>Select a doctor</option>
                    </select>
                    <div class="invalid-feedback" id="doctorFeedback"></div>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="notes">Notes</label>
                    <input type="text" id="notes" class="form-control">
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="currentIllness">Current Illness</label>
                    <input type="text" id="currentIllness" class="form-control">
                  </div>
                </div>
                <div class="mt-3">
                  <button type="button" class="btn btn-success" onclick="addAppointment()">Next</button>
                  <button type="button" class="btn btn-danger" onclick="hideAppointmentForm()">Cancel</button>
                </div>
              </form>
            </div>
          </div>

          <!-- Vitals Modal -->
          <div class="modal fade" id="vitalsModal" tabindex="-1" aria-labelledby="vitalsModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="vitalsModalLabel">Enter Patient Vitals</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="vitalsForm">
                    <div class="mb-3">
                      <label for="modalBloodPressure">Blood Pressure</label>
                      <div class="input-group">
                        <input type="text" id="modalBloodPressure" class="form-control" placeholder="120/80">
                        <select class="form-select unit-select" data-input="modalBloodPressure">
                          <option value="mmHg">mmHg</option>
                          <option value="kPa">kPa</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalHeartRate">Heart Rate</label>
                      <div class="input-group">
                        <input type="text" id="modalHeartRate" class="form-control" placeholder="60-100">
                        <span class="input-group-text">bpm</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalTemperature">Temperature</label>
                      <div class="input-group">
                        <input type="text" id="modalTemperature" class="form-control" placeholder="37.0">
                        <select class="form-select unit-select" data-input="modalTemperature">
                          <option value="°C">°C</option>
                          <option value="°F">°F</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalRespiratoryRate">Respiratory Rate</label>
                      <div class="input-group">
                        <input type="text" id="modalRespiratoryRate" class="form-control" placeholder="12-20">
                        <span class="input-group-text">breaths/min</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalOxygenSaturation">Oxygen Saturation</label>
                      <div class="input-group">
                        <input type="text" id="modalOxygenSaturation" class="form-control" placeholder="95-100">
                        <span class="input-group-text">%</span>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalWeight">Weight</label>
                      <div class="input-group">
                        <input type="text" id="modalWeight" class="form-control" placeholder="70">
                        <select class="form-select unit-select" data-input="modalWeight">
                          <option value="kg">kg</option>
                          <option value="lbs">lbs</option>
                        </select>
                      </div>
                    </div>
                    <div class="mb-3">
                      <label for="modalHeight">Height</label>
                      <div class="input-group">
                        <input type="text" id="modalHeight" class="form-control" placeholder="170">
                        <select class="form-select unit-select" data-input="modalHeight">
                          <option value="cm">cm</option>
                          <option value="in">in</option>
                        </select>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" onclick="saveVitals()">Save Vitals</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Edit Appointment Modal -->
          <div class="modal fade" id="editAppointmentModal" tabindex="-1" aria-labelledby="editAppointmentModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="editAppointmentModalLabel">Edit Appointment</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="editAppointmentForm">
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAppointmentID">Appointment ID</label>
                        <input type="text" id="editAppointmentID" class="form-control" readonly>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editPatientID">Patient ID</label>
                        <input type="text" id="editPatientID" class="form-control" readonly>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editFirstName">First Name</label>
                        <input type="text" id="editFirstName" class="form-control" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editLastName">Last Name</label>
                        <input type="text" id="editLastName" class="form-control" required>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editContactNumber">Contact Number</label>
                        <input type="tel" id="editContactNumber" class="form-control" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editDateOfBirth">Date of Birth</label>
                        <input type="text" id="editDateOfBirth" class="form-control custom-datetime-picker" required readonly>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAge">Age</label>
                        <input type="number" id="editAge" class="form-control" readonly>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editCurrentIllness">Current Illness</label>
                        <input type="text" id="editCurrentIllness" class="form-control">
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-6 mb-3">
                        <label for="editAppointmentDate">Appointment Date</label>
                        <input type="text" id="editAppointmentDate" class="form-control custom-datetime-picker" required>
                      </div>
                      <div class="col-md-6 mb-3">
                        <label for="editDoctor">Doctor</label>
                        <select id="editDoctor" class="form-control" required>
                          <option value="" disabled selected>Loading...</option>
                        </select>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-12 mb-3">
                        <label for="editNotes">Notes</label>
                        <textarea id="editNotes" class="form-control"></textarea>
                      </div>
                    </div>
                    <div class="row">
                      <div class="col-md-12 mb-3">
                        <label for="editAppointmentStatus">Status</label>
                        <select id="editAppointmentStatus" class="form-control">
                          <option value="Waiting">Waiting</option>
                          <option value="Scheduled">Scheduled</option>
                          <option value="Pending">Pending</option>
                          <option value="Completed">Completed</option>
                          <option value="Canceled">Canceled</option>
                          <option value="Rescheduled">Rescheduled</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-check mb-3">
                      <input type="checkbox" id="editIsEmergency" class="form-check-input">
                      <label for="editIsEmergency" class="form-check-label">Is this an emergency?</label>
                    </div>
                    <div class="mt-3">
                      <button type="button" class="btn btn-success" onclick="updateAppointment()">Save Changes</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <!-- Reschedule Modal -->
          <div class="modal fade" id="rescheduleAppointmentModal" tabindex="-1" aria-labelledby="rescheduleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="rescheduleModalLabel">Reschedule Appointment</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <form id="rescheduleForm">
                    <input type="hidden" id="rescheduleAppointmentID">
                    <div class="mb-3">
                      <label for="newAppointmentDate">New Date & Time</label>
                      <input type="text" class="form-control custom-datetime-picker" id="newAppointmentDate" required>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="button" class="btn btn-primary" onclick="rescheduleAppointment()">Confirm Reschedule</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Patient ID Popup Modal -->
          <div class="modal fade" id="patientIdPopupModal" tabindex="-1" aria-labelledby="patientIdPopupModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="patientIdPopupModalLabel">Patient Created</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>Patient has been successfully created!</p>
                  <div class="input-group mb-3">
                    <input type="text" class="form-control" id="newPatientIdInput" readonly>
                    <button class="btn btn-outline-secondary" type="button" id="copyPatientIdBtn">Copy</button>
                  </div>
                  <p class="text-success" id="copySuccessMsg" style="display: none;">Patient ID copied to clipboard!</p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" id="makeAppointmentBtn">Make Appointment</button>
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
          <div class="d-sm-flex justify-content-center justify-content-sm-between">
            <span class="text-muted text-center text-sm-left d-block d-sm-inline-block">Copyright © 2025 <a href="#" target="_blank">Kerala. All rights reserved.</a></span>
            <span class="float-none float-sm-right d-block mt-1 mt-sm-0 text-center">Doctors Dashboard <i class="mdi mdi-heart text-danger"></i></span>
          </div>
        </footer>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>


    $(document).ready(function() {
      // Event handlers for buttons
      $(".btn-primary.btn-sm.mb-3").on("click", function() {
        if ($(this).text() === "Add Appointment") {
          console.log("Add Appointment button clicked");
          showAppointmentForm();
        }
      });

      $("#addPatientBtn").on("click", function() {
        console.log("Add Patient button clicked");
        $("#createPatientModal").modal("show");
      });

      // Copy Patient ID to Clipboard
      $("#copyPatientIdBtn").on("click", function() {
        const patientId = $("#newPatientIdInput").val();
        navigator.clipboard.writeText(patientId).then(() => {
          console.log("Patient ID copied to clipboard:", patientId);
          $("#copySuccessMsg").show();
          setTimeout(() => $("#copySuccessMsg").hide(), 2000);
        }).catch(err => {
          console.error("Failed to copy patient ID:", err);
          displayAlert("Failed to copy patient ID", "error");
        });
      });
    });

    // Utility Functions
    function getAuthHeaders() {
      const token = sessionStorage.getItem('token') || localStorage.getItem('token');
      const username = sessionStorage.getItem('username') || localStorage.getItem('username');
      const csrftoken = sessionStorage.getItem('csrftoken') || localStorage.getItem('csrftoken');
      if (!token || !username || !csrftoken) {
        console.warn("Missing authentication details");
        return {};
      }
      return {
        'Authorization': 'Token ' + token,
        'X-CSRFToken': csrftoken,
        'Username': username
      };
    }

   // function displayAlert(message, type = 'success') {
   //   console.log(`Showing notification: ${message} (${type})`);
 //     $("#notificationMessage").text(message)
   //     .removeClass("success-message error-message")
  //      .addClass(type === 'success' ? "success-message" : "error-message");
   //   $("#notificationModal").modal("show");
 //   }

    function formatDateTime(dateTimeString) {
      return new Date(dateTimeString).toISOString().slice(0, 16);
    }

    function calculateAge(dob) {
      const birthDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      if (today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) {
        age--;
      }
      return age;
    }

    // Session Management
    function checkSessionOnLoad() {
      const token = localStorage.getItem('token');
      const username = localStorage.getItem('username');
      const userType = localStorage.getItem('user_type');
      console.log("Checking session:", { token, username, userType });
      if (!token || !username || !userType) {
        console.warn("Session data missing. Redirecting to login...");
        window.location.href = 'http://smarthospitalmaintain.com';
        return;
      }
      validateUserSession();
    }

    function validateUserSession() {
      const headers = getAuthHeaders();
      if (!headers['Authorization']) {
        console.warn("No authorization token found. Redirecting...");
        window.location.href = 'http://smarthospitalmaintain.com';
        return;
      }
      $.ajax({
        url: 'http://smarthospitalmaintain.com:8000/cookie/check/',
        type: 'GET',
        headers: headers,
        success: function(response) {
          console.log("Session validation response:", response);
          if (response.message !== 'Cookie is valid.') {
            displayAlert('Invalid session. Logging out.', 'error');
            attemptLogout();
          } else {
            $("#logged_in_user_name, #logged_in_user_name_breadcrumb").text(response.name);
            $("#timeOfDay").text(getGreetingTime());
            const statuses = ["Waiting", "Scheduled", "Pending", "Completed", "Canceled", "Rescheduled"];
            statuses.forEach(fetchAppointments);
            loadDoctors();
          }
        },
        error: function(xhr) {
          console.error("Session validation failed:", xhr.status, xhr.responseText);
          attemptLogout();
        }
      });
    }

    function attemptLogout() {
      console.log("Attempting logout...");
      logoutUser();
      setTimeout(() => {
        if (sessionStorage.getItem('authToken') || localStorage.getItem('authToken')) {
          forceLogout();
        }
      }, 3000);
    }

    function forceLogout() {
      console.log("Forcing logout...");
      sessionStorage.clear();
      localStorage.clear();
      document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
      window.location.href = 'http://smarthospitalmaintain.com/';
    }

    function logoutUser() {
      const headers = getAuthHeaders();
      if (!headers['Authorization']) {
        console.warn("No authorization for logout. Redirecting...");
        window.location.href = 'http://smarthospitalmaintain.com/';
        return;
      }
      $.ajax({
        url: 'http://smarthospitalmaintain.com:8000/users/logout/',
        type: 'POST',
        headers: headers,
        success: function() {
          console.log("Logout successful");
          sessionStorage.clear();
          localStorage.clear();
          document.cookie = "sessionid=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
          window.location.href = 'http://smarthospitalmaintain.com/';
        },
        error: function(xhr) {
          console.error("Logout failed:", xhr.status, xhr.responseText);
        }
      });
    }

    function getGreetingTime() {
      const hours = new Date().getHours();
      return hours < 12 ? "Morning" : hours < 18 ? "Afternoon" : "Evening";
    }

    // Appointment Management
    function fetchAppointments(status) {
      console.log(`Fetching appointments for status: ${status}`);
      $.ajax({
        url: `http://smarthospitalmaintain.com:8000/appointments/list/?status=${status}`,
        type: 'GET',
        headers: getAuthHeaders(),
        success: function(response) {
          console.log(`Appointments fetched for ${status}:`, response.appointments);
          populateAppointmentsTable(status, response.appointments);
        },
        error: function(xhr) {
          console.error(`Failed to fetch ${status} appointments:`, xhr.status, xhr.responseText);
          displayAlert(`Error fetching ${status} appointments`, 'error');
        }
      });
    }

    let filteredAppointments = [];
    function populateAppointmentsTable(status, appointments) {
      let tbodyId = `${status}-tbody`;
      let tbody = document.getElementById(tbodyId);
      if (!tbody) return;
      tbody.innerHTML = "";
    
      filteredAppointments = appointments;
    
      if (!document.getElementById(`${status}-select-all`)) {
        let thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th><input type="checkbox" id="${status}-select-all" onclick="toggleAll('${status}')"></th>
            <th>#</th>
            <th>Patient ID</th>
            <th>Patient Name</th>
            <th>Age</th>
            <th>Contact Number</th>
            <th>Current Illness</th>
            <th>Notes</th>
            <th>Appointment Time</th>
            <th>Doctor</th>
            <th>Created By</th>
            <th>Updated By</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        `;
        tbody.parentElement.insertBefore(thead, tbody);
      }
    
      appointments.forEach((appointment, index) => {
        let patient = appointment.patient || {};
        let doctor = appointment.doctor || {};
        let doctorName = `${doctor.first_name || ''} ${doctor.last_name || ''}` || "Unknown Doctor";
        let appointmentTime = formatDateTimeForTable(appointment.appointment_date);
        console.log("populateAppointmentsTable - appointment_date:", appointment.appointment_date, "Formatted:", appointmentTime);    
        let row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="checkbox" class="${status}-checkbox" value="${appointment.id}" onclick="updateBulkSelection('${status}')"></td>
          <td>${index + 1}</td>
          <td>${patient.patient_id || "N/A"}</td>
          <td>${patient.first_name} ${patient.last_name}</td>
          <td>${patient.age >= 0 ? patient.age : "N/A"}</td>
          <td>${patient.mobile_number || "N/A"}</td>
          <td>${patient.current_medications || "N/A"}</td>
          <td>${appointment.notes || "N/A"}</td>
          <td>${appointmentTime}</td>
          <td>Dr. ${doctorName} (${doctor.specialization || "N/A"})</td>
          <td>${appointment.created_by_username || "N/A"}</td>
          <td>${appointment.updated_by ? `${appointment.updated_by_username} updated` : "Not Updated"}</td>
          <td>${appointment.status || "N/A"}</td>
          <td>${getActionButton(appointment.status, appointment, index)}</td>
        `;
        tbody.appendChild(row);
      });
    
      filterTable(); // Apply filter after populating
    }
    
    // Helper function to format date/time like Flatpickr's altFormat
    function formatDateTimeForTable(date, includeTime = true) {
      const dateObj = (typeof date === 'string') ? new Date(date) : date;
      if (isNaN(dateObj.getTime())) {
          console.error("Invalid date provided:", date);
          return "Invalid Date";
      }
  
      // Force IST
      const istOffset = 5.5 * 60; // 330 minutes
      const utcDate = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000));
      const istDate = new Date(utcDate.getTime() + (istOffset * 60000));
  
      const months = [
          "January", "February", "March", "April", "May", "June",
          "July", "August", "September", "October", "November", "December"
      ];
      let month = months[istDate.getMonth()];
      let day = istDate.getDate();
      let year = istDate.getFullYear();
  
      if (!includeTime) {
          return `${month} ${day}, ${year}`;
      }
  
      let hours = istDate.getHours();
      let minutes = istDate.getMinutes();
      let period = hours >= 12 ? "PM" : "AM";
      hours = hours % 12 || 12;
      minutes = minutes < 10 ? `0${minutes}` : minutes;
  
      return `${month} ${day}, ${year}, ${hours}:${minutes} ${period}`;
  }

    function toggleAll(status) {
      const selectAllCheckbox = document.getElementById(`${status}-select-all`);
      const checkboxes = document.querySelectorAll(`.${status}-checkbox`);
      const selectedIds = [];

      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAllCheckbox.checked;
        if (checkbox.checked) selectedIds.push(checkbox.value);
      });

      console.log(`Toggle all for ${status}:`, selectedIds);
      updateBulkActions(status, selectedIds);
    }

    function updateBulkSelection(status) {
      const checkboxes = document.querySelectorAll(`.${status}-checkbox`);
      const selectAllCheckbox = document.getElementById(`${status}-select-all`);
      const selectedIds = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);

      selectAllCheckbox.checked = checkboxes.length > 0 && selectedIds.length === checkboxes.length;
      console.log(`Updated selection for ${status}:`, selectedIds);
      updateBulkActions(status, selectedIds);
    }

    function updateBulkActions(status, selectedIds) {
      const cancelBtn = document.getElementById("cancelBtn");
      const rescheduleBtn = document.getElementById("rescheduleBtn");

      if (!cancelBtn || !rescheduleBtn) {
        console.warn("Bulk action buttons not found");
        return;
      }

      const shouldShow = selectedIds.length > 0;
      cancelBtn.classList.toggle("d-none", !shouldShow);
      rescheduleBtn.classList.toggle("d-none", !shouldShow);
    }

    function bulkCancel() {
      const status = $("#appointmentTabs .nav-link.active").attr("href").substring(1).charAt(0).toUpperCase() + $("#appointmentTabs .nav-link.active").attr("href").substring(2);
      const selectedIds = Array.from(document.querySelectorAll(`.${status}-checkbox:checked`)).map(cb => cb.value);
      console.log("Bulk cancel selected IDs:", selectedIds);

      if (selectedIds.length === 0) {
        displayAlert("No appointments selected for cancellation", "error");
        return;
      }
      cancelAppointment(selectedIds, null, status);
    }

    function bulkReschedule() {
      const status = $("#appointmentTabs .nav-link.active").attr("href").substring(1).charAt(0).toUpperCase() + $("#appointmentTabs .nav-link.active").attr("href").substring(2);
      const selectedIds = Array.from(document.querySelectorAll(`.${status}-checkbox:checked`)).map(cb => cb.value);
      console.log("Bulk reschedule selected IDs:", selectedIds);

      if (selectedIds.length === 0) {
        displayAlert("No appointments selected for rescheduling", "error");
        return;
      }
      openRescheduleModal(selectedIds, null, status);
    }

    function getActionButton(status, appointment, rowIndex) {
      let buttons = "";
      const appointmentData = encodeURIComponent(JSON.stringify(appointment));
      switch (status) {
        case 'Waiting':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-success btn-sm">Start Consulting</button>`;
          break;
        case 'Scheduled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id})">Reschedule</button>`;
          buttons += `<button class="btn btn-success btn-sm">Start Consulting</button>`;
          break;
        case 'Pending':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id})">Reschedule</button>`;
          break;
        case 'Canceled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id})">Reschedule</button>`;
          break;
        case 'Completed':
          buttons += `<button class="btn btn-secondary btn-sm">Review</button>`;
          break;
        case 'Rescheduled':
          buttons += `<button class="btn btn-primary btn-sm" onclick='openEditModal("${appointmentData}", ${rowIndex})'>Edit</button> `;
          buttons += `<button class="btn btn-danger btn-sm" onclick="cancelAppointment(${appointment.id}, ${rowIndex})">Cancel</button> `;
          buttons += `<button class="btn btn-warning btn-sm" onclick="openRescheduleModal(${appointment.id})">Reschedule</button>`;
          break;
        default:
          buttons += `<button class="btn btn-light btn-sm">No Action</button>`;
      }
      return buttons;
    }

    // Form Handling
    $("#makeAppointmentBtn").on("click", function() {
      const patientId = $("#newPatientIdInput").val().trim();
      console.log("Make appointment with patient ID:", patientId);
      if (!patientId) {
        displayAlert("Patient ID is missing", "error");
        return;
      }
      $(".modal").modal("hide");
      showAppointmentForm(patientId);
      fetchPatientDetails(patientId);
    });

    function showAppointmentForm(patientId = null) {
      console.log("Showing appointment form with patient ID:", patientId);
      $("#appointmentFormContainer").show();
      $(".tab-pane").removeClass("show active");
      $("#appointmentTabs .nav-link").removeClass("active");
      $("#appointmentForm")[0].reset();
      $("#appointmentForm .form-control").removeClass("is-invalid");
      if (patientId) {
        $("#patientID").val(patientId);
        $("#patientID").trigger("blur");
      }
    }

    function hideAppointmentForm() {
      console.log("Hiding appointment form");
      $("#appointmentFormContainer").hide();
      $("#appointmentForm")[0].reset();
      const activeTab = localStorage.getItem("activeTab") || "#waiting";
      $(`#appointmentTabs a[href="${activeTab}"]`).tab("show");
    }

    function fetchPatientDetails(patientId) {
      console.log("Fetching patient details for ID:", patientId);
      if (patientId) {
        $.ajax({
          url: `http://smarthospitalmaintain.com:8000/appointments/get-patient-details/${patientId}/`,
          type: "GET",
          headers: getAuthHeaders(),
          success: function(response) {
            console.log("Patient details fetched:", response);
            if (response.patient) {
              $("#firstName").val(response.patient.first_name || "");
              $("#lastName").val(response.patient.last_name || "");
              $("#contactNumber").val(response.patient.mobile_number || "");
              $("#dateOfBirth").val(response.patient.date_of_birth || "");
              $("#age").val(response.patient.date_of_birth ? calculateAge(response.patient.date_of_birth) : "");
            } else {
              displayAlert("Patient not found", "error");
              $("#firstName, #lastName, #contactNumber, #dateOfBirth, #age").val("");
            }
          },
          error: function(xhr) {
            console.error("Failed to fetch patient details:", xhr.status, xhr.responseText);
            displayAlert("Failed to fetch patient details", "error");
            $("#firstName, #lastName, #contactNumber, #dateOfBirth, #age").val("");
          }
        });
      }
    }

    let doctorMap = {};
    function loadDoctors(selectedId = null) {
      console.log("Loading doctors...");
      $.ajax({
        url: "http://smarthospitalmaintain.com:8000/appointments/doctors/list/",
        type: "GET",
        headers: getAuthHeaders(),
        success: function(response) {
          console.log("Doctors loaded:", response.doctors);
          $("#doctor, #editDoctor, #patientPrimaryDoctor").empty().append('<option value="" disabled selected>Select a doctor</option>');
          response.doctors.forEach(doctor => {
            doctorMap[doctor.id] = doctor;
            const option = `<option value="${doctor.id}">Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}</option>`;
            $("#doctor, #editDoctor, #patientPrimaryDoctor").append(option);
          });
          if (selectedId) $("#editDoctor").val(selectedId);
        },
        error: function(xhr) {
          console.error("Failed to load doctors:", xhr.status, xhr.responseText);
          displayAlert("Failed to load doctors list", "error");
        }
      });
    }

    function addAppointment() {
      const patientId = $("#patientID").val().trim();
      const doctorId = $("#doctor").val();
      const appointmentDate = $("#appointmentDate").val();
      const formattedDate = appointmentDate + ":00";
      const notes = $("#notes").val().trim();
      const currentIllness = $("#currentIllness").val().trim();
    
      // Clear previous validation
      $(".form-control").removeClass("is-invalid");
      $(".invalid-feedback").text("");
    
      let isValid = true;
      if (!patientId) {
        $("#patientID").addClass("is-invalid");
        $("#patientIDFeedback").text("Patient ID is required.");
        isValid = false;
      }
      if (!doctorId) {
        $("#doctor").addClass("is-invalid");
        $("#doctorFeedback").text("Doctor selection is required.");
        isValid = false;
      }
      if (!appointmentDate) {
        $("#appointmentDate").addClass("is-invalid");
        $("#appointmentDateFeedback").text("Appointment date is required.");
        isValid = false;
      } else {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        if (new Date(appointmentDate) < today) {
          $("#appointmentDate").addClass("is-invalid");
          $("#appointmentDateFeedback").text("Appointment date cannot be in the past.");
          isValid = false;
        }
      }
    
      if (!isValid) {
        displayAlert("Please correct the form errors.", "danger");
        return;
      }
    
      const appointmentData = {
        patient_id: patientId,
        doctor_id: doctorId,
        appointment_date: formattedDate,
        notes: notes,
        current_illness: currentIllness
      };
    
      $.ajax({
        url: "http://smarthospitalmaintain.com:8000/appointments/create/",
        type: "POST",
        headers: getAuthHeaders(),
        data: JSON.stringify(appointmentData),
        contentType: "application/json",
        success: function(response) {
          const appointmentId = response.appointment?.id;
          if (!appointmentId) {
            displayAlert("Error: Appointment ID missing from response.", "danger");
            return;
          }
          hideAppointmentForm();
          fetchAppointments("Scheduled");
          $("#vitalsModal").modal("show").data("appointmentId", appointmentId);
          displayAlert("Appointment created successfully!", "success");
        },
        error: function(xhr) {
          displayAlert(getErrorMessage(xhr, "Failed to create appointment."), "danger");
        }
      });
    }

    let currentAppointment = null;
    function openEditModal(appointmentData, rowIndex) {
      currentAppointment = JSON.parse(decodeURIComponent(appointmentData));
  
      $("#editFirstName").val(currentAppointment.patient?.first_name || "");
      $("#editLastName").val(currentAppointment.patient?.last_name || "");
      $("#editContactNumber").val(currentAppointment.patient?.contact_number || "");
      $("#editDateOfBirth").val(currentAppointment.patient?.date_of_birth || "");
  
      const dob = currentAppointment.patient?.date_of_birth;
      if (dob) {
          const calculatedAge = calculateAge(dob);
          $("#editAge").val(calculatedAge >= 0 ? calculatedAge : "");
      } else {
          $("#editAge").val("");
      }
  
      $("#editCurrentIllness").val(currentAppointment.current_medications || "");
  
      // Get the Flatpickr instance
      const flatpickrInstance = $("#editAppointmentDate")[0]._flatpickr;
      if (!flatpickrInstance) {
          console.error("Flatpickr instance not found for #editAppointmentDate. Ensure Flatpickr is initialized.");
          displayAlert("Date picker not initialized.", "error");
          return;
      }
  
      // Set appointment_date from API string
      const appointmentDateStr = currentAppointment.appointment_date; // e.g., "2025-03-21T01:52:00+05:30"
      const appointmentDate = new Date(appointmentDateStr);
      if (isNaN(appointmentDate.getTime())) {
          console.error("Invalid appointment_date:", appointmentDateStr);
          displayAlert("Invalid appointment date received.", "error");
          return;
      }
  
      // Adjust to IST explicitly (undo local timezone offset and apply IST)
      const istOffset = 5.5 * 60; // IST is UTC+05:30 in minutes
      const utcDate = new Date(appointmentDate.getTime() - (appointmentDate.getTimezoneOffset() * 60000)); // To UTC
      const istDate = new Date(utcDate.getTime() + (istOffset * 60000)); // To IST
  
      flatpickrInstance.setDate(istDate, true, "Y-m-d H:i"); // Sets "2025-03-21 01:52"
      console.log("openEditModal - appointment_date:", appointmentDateStr, "Flatpickr set to:", flatpickrInstance.selectedDates[0]);
  
      $("#editAppointmentStatus").val(currentAppointment.status || "");
      $("#editNotes").val(currentAppointment.notes || "");
      $("#editAppointmentID").val(currentAppointment.id);
      $("#editPatientID").val(currentAppointment.patient?.patient_id || "");
  
      $("#editFirstName, #editLastName, #editContactNumber, #editPatientID, #editDateOfBirth").prop("readonly", true);
      $("#editAge").prop("readonly", true);
      $("#editCurrentIllness, #editNotes, #editAppointmentDate, #editAppointmentStatus").prop("readonly", false);
  
      let previousDoctorId = currentAppointment.doctor?.id || "";
      loadDoctors(previousDoctorId);
  
      $("#editAppointmentModal").modal("show");
  }


  function updateAppointment() {
    const flatpickrInstance = document.querySelector("#editAppointmentDate")._flatpickr;
    let appointmentDate = flatpickrInstance.selectedDates[0];
    if (!appointmentDate || isNaN(appointmentDate.getTime())) {
        displayAlert("Please select a valid appointment date and time", "error");
        $("#现状").addClass("is-invalid");
        return;
    }

    // Convert to IST
    const istOffset = 5.5 * 60; // 330 minutes
    const utcDate = new Date(appointmentDate.getTime() - (appointmentDate.getTimezoneOffset() * 60000));
    const istDate = new Date(utcDate.getTime() + (istOffset * 60000));
    const formattedAppointmentDate = istDate.toISOString().slice(0, 19) + "+05:30";

    const updatedAppointment = {
        id: $("#editAppointmentID").val(),
        patient_id: $("#editPatientID").val(),
        date_of_birth: $("#editDateOfBirth").val(),
        current_illness: $("#editCurrentIllness").val(),
        doctor_id: $("#editDoctor").val() || currentAppointment.doctor?.id || "",
        status: $("#editAppointmentStatus").val(),
        notes: $("#editNotes").val(),
        appointment_date: formattedAppointmentDate
    };

    console.log("updateAppointment - Sending to API:", updatedAppointment);

    fetch(`http://smarthospitalmaintain.com:8000/appointments/edit/${updatedAppointment.id}/`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", ...getAuthHeaders() },
        body: JSON.stringify(updatedAppointment)
    })
    .then(response => {
        if (!response.ok) throw new Error("Failed to update");
        return response.json();
    })
    .then(data => {
        console.log("Appointment updated:", data);
        displayAlert("Appointment updated successfully", "success");
        $("#editAppointmentModal").modal("hide");
        fetchAppointments(updatedAppointment.status);
    })
    .catch(error => {
        console.error("Update failed:", error);
        displayAlert("Failed to update appointment", "error");
    });
}

    function cancelAppointment(appointmentIds, rowIndex = null, status = null) {
      const selectedIds = Array.isArray(appointmentIds) ? appointmentIds : [appointmentIds];
      console.log("Canceling appointments:", selectedIds);

      if (selectedIds.length === 0 || !selectedIds[0]) {
        displayAlert("No appointments selected", "error");
        return;
      }

      if (!confirm(`Are you sure you want to cancel ${selectedIds.length} appointment(s)?`)) return;

      fetch("http://smarthospitalmaintain.com:8000/appointments/cancel/", {
        method: "PATCH",
        headers: { "Content-Type": "application/json", ...getAuthHeaders() },
        body: JSON.stringify({ appointment_ids: selectedIds, status: "Canceled" })
      })
        .then(response => {
          if (!response.ok) throw new Error("Failed to cancel");
          return response.json();
        })
        .then(data => {
          console.log("Appointments canceled:", data);
          displayAlert(`Successfully canceled ${selectedIds.length} appointment(s)`);
          location.reload();
          fetchAppointments(status || "Canceled");
        })
        .catch(error => {
          console.error("Cancel failed:", error);
          displayAlert("Failed to cancel appointments", "error");
        });
    }

    function openRescheduleModal(appointmentIds = null, date = null, status = null) {
      const selectedIds = Array.isArray(appointmentIds) ? appointmentIds : [appointmentIds];
      console.log("Opening reschedule modal for IDs:", selectedIds);

      if (selectedIds.length === 0) {
        displayAlert("No appointments selected", "error");
        return;
      }

      $("#rescheduleAppointmentID").val(selectedIds.join(","));
      $("#newAppointmentDate").val(date || "");
      $("#rescheduleAppointmentModal").modal("show");
    }

    function rescheduleAppointment() {
      const appointmentIds = $("#rescheduleAppointmentID").val().split(",");
      const newDate = $("#newAppointmentDate").val().trim();
      console.log("Rescheduling appointments:", { appointmentIds, newDate });

      if (!newDate) {
        displayAlert("Please select a new date and time", "error");
        return;
      }

      fetch("http://smarthospitalmaintain.com:8000/appointments/reschedule/", {
        method: "PATCH",
        headers: { "Content-Type": "application/json", ...getAuthHeaders() },
        body: JSON.stringify({ appointment_ids: appointmentIds, appointment_date: new Date(newDate + ":00").toISOString() })
      })
        .then(response => {
          if (!response.ok) throw new Error("Failed to reschedule");
          return response.json();
        })
        .then(data => {
          console.log("Appointments rescheduled:", data);
          displayAlert(`Successfully rescheduled ${appointmentIds.length} appointment(s)`);
          $("#rescheduleAppointmentModal").modal("hide");
          fetchAppointments("Rescheduled");
          location.reload();
        })
        .catch(error => {
          console.error("Reschedule failed:", error);
          displayAlert("Try with a later date than today", "error");
        });
    }

    // Search Filter Logic
    function filterTable() {
      const patientId = $("#searchPatientId").val().toLowerCase().trim();
      const name = $("#searchName").val().toLowerCase().trim();
      const mobile = $("#searchMobile").val().trim();
      const dob = $("#searchDob").val(); // Y-m-d format
      const date = $("#searchDate").val(); // Y-m-d format
    
      $(".tab-pane tbody tr").each(function() {
        const row = $(this);
        const rowPatientId = row.find("td:nth-child(3)").text().toLowerCase().trim();
        const rowName = row.find("td:nth-child(4)").text().toLowerCase().trim();
        const rowMobile = row.find("td:nth-child(6)").text().trim();
        const rowDob = row.find("td:nth-child(5)")?.text() || ""; // Adjust if DOB is displayed
        const rowDateTime = row.find("td:nth-child(9)").text().trim(); // e.g., "March 12, 2025, 3:30 PM"
    
        // Parse "March 12, 2025" from "March 12, 2025, 3:30 PM" and convert to Y-m-d
        let formattedRowDate = "";
        if (rowDateTime) {
          const datePart = rowDateTime.split(", ").slice(0, 2).join(", "); // "March 12, 2025"
          const dateObj = new Date(datePart);
          if (!isNaN(dateObj.getTime())) {
            formattedRowDate = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, "0")}-${String(dateObj.getDate()).padStart(2, "0")}`;
          }
        }
    
        const matches = (!patientId || rowPatientId.includes(patientId)) &&
                       (!name || rowName.includes(name)) &&
                       (!mobile || rowMobile.includes(mobile)) &&
                       (!dob || rowDob.includes(dob)) &&
                       (!date || formattedRowDate === date);
    
        row.toggle(matches);
      });
    }

    $("#searchPatientId, #searchName, #searchMobile, #searchDob, #searchDate").on("input change", filterTable);

    // Initialization
    document.addEventListener("DOMContentLoaded", function() {
      ["#contactNumber", "#editContactNumber"].forEach(selector => {
        const input = document.querySelector(selector);
        if (input) {
          const iti = window.intlTelInput(input, {
            initialCountry: "in",
            preferredCountries: ["in", "us", "gb", "ke", "ng"],
            separateDialCode: true
          });
          input.addEventListener("blur", () => console.log(`Phone number (${selector}):`, iti.getNumber()));
        }
      });

      $("#dateOfBirth").attr("max", new Date().toISOString().split("T")[0]);
      const now = new Date();
      const formattedNow = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}T${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      $("#appointmentDate").attr("min", formattedNow);

      $("#dateOfBirth, #editDateOfBirth").on("change", function() {
        const age = calculateAge(this.value);
        $(this.id === "dateOfBirth" ? "#age" : "#editAge").val(age >= 0 ? age : "");
      });

      $("#appointmentTabs a").on("shown.bs.tab", function(e) {
        localStorage.setItem("activeTab", $(e.target).attr("href"));
      });
      const activeTab = localStorage.getItem("activeTab");
      if (activeTab) $("#appointmentTabs a[href='" + activeTab + "']").tab("show");

      $("#logoutButton, #logoutDropdown").on("click", function(e) {
        e.preventDefault();
        logoutUser();
      });

      checkSessionOnLoad();
    });

    // Patient Management
    //$("#patientDob").on("change", function() {
      //const age = calculateAge(this.value);
      //$("#patientAge").val(age >= 0 ? age : "");
    //});
    $(document).ready(function() {
      $('#createPatientModal').on('shown.bs.modal', function() {
        $("#createPatientForm")[0].reset();
        $("#createPatientForm .form-control, #createPatientForm .form-select").removeClass('is-invalid');
        // Ensure Basic Information is expanded
        $('#collapseBasic').addClass('show');
        $('#collapseMedical, #collapseEmergency, #collapseInsurance').removeClass('show');
        loadDoctorsForPatientModal();
      });
    
      // Age calculation
      $("#patientDob").on("change", function() {
        const dob = new Date(this.value);
        if (isNaN(dob.getTime())) {
          $("#patientAge").val("");
          return;
        }
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) {
          age--;
        }
        $("#patientAge").val(age >= 0 ? age : "");
      });
    
      // Save button
      $('#savePatientBtn').on('click', function() {
        if (validateBasicInfo()) {
          savePatient();
        } else {
          displayAlert('Please fill all required fields in Basic Information correctly.', 'error');
        }
      });
    
      // Validate Basic Information section
      function validateBasicInfo() {
        let isValid = true;
        const requiredFields = {
          'patientFirstName': { value: $('#patientFirstName').val().trim(), message: "First name is required." },
          'patientLastName': { value: $('#patientLastName').val().trim(), message: "Last name is required." },
          'patientGender': { value: $('#patientGender').val(), message: "Gender is required." },
          'patientDob': { value: $('#patientDob').val(), message: "Date of birth is required." },
          'patientFatherName': { value: $('#patientFatherName').val().trim(), message: "Father's name is required." },
          'patientMobile': { value: $('#patientMobile').val().trim(), message: "Mobile number is required." },
          'admissionType': { value: $('#admissionType').val(), message: "Admission type is required." }
        };
      
        Object.entries(requiredFields).forEach(([id, { value, message }]) => {
          const $input = $(`#${id}`);
          const $feedback = $(`#${id}Feedback`);
          if (!value) {
            $input.addClass('is-invalid');
            $feedback.text(message);
            isValid = false;
          } else {
            $input.removeClass('is-invalid');
            $feedback.text('');
          }
        });
      
        const mobile = requiredFields.patientMobile.value;
        if (mobile && !/^\d{10}$/.test(mobile)) {
          $('#patientMobile').addClass('is-invalid');
          $('#patientMobileFeedback').text("Mobile number must be exactly 10 digits.");
          isValid = false;
        }
      
        return isValid;
      }
      
      // In savePatient
      $('#savePatientBtn').on('click', function() {
        if (!validateBasicInfo()) {
          displayAlert("Please fill all required fields correctly.", "danger");
          return;
        }
        savePatient();
      });
    });
 
    
    // Save patient function
    function savePatient() {
      const patientData = {
        first_name: $("#patientFirstName").val().trim(),
        last_name: $("#patientLastName").val().trim(),
        gender: $("#patientGender").val(),
        date_of_birth: $("#patientDob").val(),
        father_name: $("#patientFatherName").val().trim(),
        address: $("#patientAddress").val().trim() || null,
        city: $("#patientCity").val().trim() || null,
        pincode: $("#patientPincode").val() || null,
        email: $("#patientEmail").val().trim() || null,
        mobile_number: $("#patientMobile").val().trim(),
        alternate_mobile_number: $("#patientAltMobile").val().trim() || null,
        aadhar_number: $("#patientAadhar").val().trim() || null,
        blood_group: $("#patientBloodGroup").val() || null,
        known_allergies: $("#patientAllergies").val().trim() || null,
        current_medications: $("#patientMedications").val().trim() || null,
        past_medical_history: $("#patientPastHistory").val().trim() || null,
        specific_notes: $("#patientNotes").val().trim() || null,
        primary_doctor: $("#patientPrimaryDoctor").val() || null,
        emergency_contact_name: $("#emergencyName").val().trim() || null,
        emergency_contact_relationship: $("#emergencyRelation").val().trim() || null,
        emergency_contact_number: $("#emergencyNumber").val().trim() || null,
        insurance_provider: $("#insuranceProvider").val().trim() || null,
        policy_number: $("#policyNumber").val().trim() || null,
        payment_preference: $("#paymentPreference").val() || null,
        admission_type: $("#admissionType").val()
      };
    
      // Additional validation
      const requiredFields = {
        'patientFirstName': patientData.first_name,
        'patientLastName': patientData.last_name,
        'patientGender': patientData.gender,
        'patientDob': patientData.date_of_birth,
        'patientFatherName': patientData.father_name,
        'patientMobile': patientData.mobile_number,
        'admissionType': patientData.admission_type
      };
    
      let isValid = true;
      Object.keys(requiredFields).forEach(id => {
        if (!requiredFields[id]) {
          $(`#${id}`).addClass('is-invalid');
          isValid = false;
        } else {
          $(`#${id}`).removeClass('is-invalid');
        }
      });
    
      if (!/^\d{10}$/.test(patientData.mobile_number)) {
        $("#patientMobile").addClass('is-invalid');
        displayAlert("Mobile number must be exactly 10 digits.", "error");
        return;
      }
    
      if (patientData.alternate_mobile_number && !/^\d{10}$/.test(patientData.alternate_mobile_number)) {
        $("#patientAltMobile").addClass('is-invalid');
        displayAlert("Alternate mobile number must be exactly 10 digits.", "error");
        return;
      }
    
      if (patientData.emergency_contact_number && !/^\d{10}$/.test(patientData.emergency_contact_number)) {
        $("#emergencyNumber").addClass('is-invalid');
        displayAlert("Emergency contact number must be exactly 10 digits.", "error");
        return;
      }
    
      if (patientData.aadhar_number && !/^\d{12}$/.test(patientData.aadhar_number)) {
        $("#patientAadhar").addClass('is-invalid');
        displayAlert("Aadhar number must be exactly 12 digits.", "error");
        return;
      }
    
      if (!isValid) {
        displayAlert("Please fill all required fields.", "error");
        return;
      }
    
      console.log("Submitting patient data:", patientData);
    
      $.ajax({
        url: "http://smarthospitalmaintain.com:8000/appointments/patients/create/",
        type: "POST",
        headers: getAuthHeaders(),
        data: JSON.stringify(patientData),
        contentType: "application/json",
        success: function(response) {
          displayAlert("Patient created successfully!", "success");
          $("#createPatientModal").modal("hide");
          $("#newPatientIdInput").val(response.patient.patient_id);
          $("#patientIdPopupModal").modal("show");
        },
        error: function(xhr) {
          const errorMsg = getErrorMessage(xhr, "Failed to create patient.");
          displayAlert(errorMsg, "danger");
          console.error("Patient creation failed:", {
            status: xhr.status,
            response: xhr.responseJSON || xhr.responseText,
            dataSent: patientData
          });
        }
      });
    }
    
    // Assuming this function exists elsewhere to load doctors
    function loadDoctorsForPatientModal() {
      $.ajax({
        url: "http://smarthospitalmaintain.com:8000/appointments/doctors/list/",
        type: "GET",
        headers: getAuthHeaders(),
        success: function(response) {
          $("#patientPrimaryDoctor").empty().append('<option value="" disabled selected>Select</option>');
          response.doctors.forEach(doctor => {
            $("#patientPrimaryDoctor").append(`<option value="${doctor.id}">Dr. ${doctor.first_name} ${doctor.last_name} - ${doctor.specialization}</option>`);
          });
        },
        error: function() {
          displayAlert("Failed to load doctors.", "error");
        }
      });
    }
    
   

    $("#patientDob, #dateOfBirth, #editDateOfBirth").on("change", function() {
      const dob = new Date(this.value); // Flatpickr uses altInput value
      if (isNaN(dob.getTime())) {
        $(this.id === "dateOfBirth" ? "#age" : this.id === "editDateOfBirth" ? "#editAge" : "#patientAge").val("");
        return;
      }
      const today = new Date();
      let age = today.getFullYear() - dob.getFullYear();
      if (today.getMonth() < dob.getMonth() || (today.getMonth() === dob.getMonth() && today.getDate() < dob.getDate())) {
        age--;
      }
      $(this.id === "dateOfBirth" ? "#age" : this.id === "editDateOfBirth" ? "#editAge" : "#patientAge").val(age >= 0 ? age : "");
    });



    $("#patientID").on("blur", function() {
      let patientId = $(this).val().trim();
      if (patientId) {
        $.ajax({
          url: `http://smarthospitalmaintain.com:8000/appointments/get-patient-details/${patientId}/`,
          type: "GET",
          headers: getAuthHeaders(),
          success: function(response) {
            if (response.patient) {
              $("#firstName").val(response.patient.first_name || "");
              $("#lastName").val(response.patient.last_name || "");
              $("#contactNumber").val(response.patient.mobile_number || "");
    
              // Set date_of_birth in Flatpickr
              const dateOfBirthStr = response.patient.date_of_birth || ""; // e.g., "1990-05-15"
              const flatpickrInstance = $("#dateOfBirth")[0]._flatpickr;
              if (dateOfBirthStr) {
                const dob = new Date(dateOfBirthStr); // Parse "YYYY-MM-DD"
                if (!isNaN(dob.getTime())) {
                  flatpickrInstance.setDate(dob, true, "Y-m-d"); // Set as "1990-05-15"
                  // Displays as "May 15, 1990" via altFormat: "F j, Y"
                  $("#age").val(calculateAge(dateOfBirthStr));
                } else {
                  flatpickrInstance.clear();
                  $("#age").val("");
                }
              } else {
                flatpickrInstance.clear();
                $("#age").val("");
              }
            } else {
              displayAlert("Patient not found.", "error");
              $("#firstName, #lastName, #contactNumber, #dateOfBirth, #age").val("");
              const flatpickrInstance = $("#dateOfBirth")[0]._flatpickr;
              flatpickrInstance.clear();
            }
          },
          error: function(xhr) {
            displayAlert("Failed to fetch patient details.", "error");
            $("#firstName, #lastName, #contactNumber, #dateOfBirth, #age").val("");
            const flatpickrInstance = $("#dateOfBirth")[0]._flatpickr;
            flatpickrInstance.clear();
          }
        });
      } else {
        $("#firstName, #lastName, #contactNumber, #dateOfBirth, #age").val("");
        const flatpickrInstance = $("#dateOfBirth")[0]._flatpickr;
        flatpickrInstance.clear();
      }
    });

// Ensure intl-tel-input works for patient mobile numbers
$(document).ready(function() {
  ["#patientMobile", "#patientAltMobile", "#emergencyNumber"].forEach(selector => {
    const input = document.querySelector(selector);
    if (input) {
      window.intlTelInput(input, {
        initialCountry: "in",
        preferredCountries: ["in", "us", "gb", "ke", "ng"],
        separateDialCode: true
      });
    }
  });
});

    

// New Patient Search Functionality
let allPatients = [];
function searchPatients(query) {
  if (!query.trim()) {
    $('#patientSearchResults').hide().empty();
    return;
  }

  $.ajax({
    url: `http://smarthospitalmaintain.com:8000/patients/search/?query=${encodeURIComponent(query)}`,
    type: 'GET',
    headers: getAuthHeaders(),
    success: function(response) {
      console.log('✅ Patients search response:', response);
      allPatients = response.patients || [];
      const resultsContainer = $('#patientSearchResults');
      resultsContainer.empty();

      if (allPatients.length === 0) {
        resultsContainer.append('<div>No patients found.</div>');
      } else {
        allPatients.forEach(patient => {
          resultsContainer.append(`
            <div data-patient-id="${patient.patient_id}" onclick="showPatientDetails('${patient.patient_id}')">
              ${patient.first_name} ${patient.last_name || ''} (ID: ${patient.patient_id}, Mobile: ${patient.mobile_number || 'N/A'})
            </div>
          `);
        });
      }
      resultsContainer.show();
    },
    error: function(xhr) {
      console.error('❌ Patient search error:', xhr.responseText);
      $('#patientSearchResults').hide().empty();
      displayAlert('Failed to search patients.', 'error');
    }
  });
}
function showPatientDetails(patientId) {
  const patient = allPatients.find(p => p.patient_id === patientId);
  if (!patient) {
    displayAlert('Patient not found.', 'error');
    return;
  }

  $('#patientDetailsContent').html(`
    <h6>Basic Information</h6>
    <table class="table table-bordered">
      <tr><th>Patient ID</th><td>${patient.patient_id}</td></tr>
      <tr><th>Name</th><td>${patient.first_name} ${patient.last_name || ''}</td></tr>
      <tr><th>Gender</th><td>${patient.gender || 'N/A'}</td></tr>
      <tr><th>DOB</th><td>${patient.date_of_birth || 'N/A'}</td></tr>
      <tr><th>Age</th><td>${patient.age || calculateAge(patient.date_of_birth) || 'N/A'}</td></tr>
      <tr><th>Mobile Number</th><td>${patient.mobile_number || 'N/A'}</td></tr>
      <tr><th>Email</th><td>${patient.email || 'N/A'}</td></tr>
      <tr><th>Address</th><td>${patient.address || 'N/A'}, ${patient.city || 'N/A'}, ${patient.pincode || 'N/A'}</td></tr>
    </table>
  `);

  $('#patientDetailsModal').modal('show');
  $('#patientSearchResults').hide();

  // Set up the Make Appointment button
  $('#makeAppointmentFromPatientBtn').off('click').on('click', function() {
    $('.modal').modal('hide'); // Close all modals
    showAppointmentForm(patient.patient_id); // Open appointment form with patient ID
    fetchPatientDetails(patient.patient_id); // Pre-fill the form
  });
}

// Add event listeners for the new search filter
$(document).ready(function() {
  // Existing event listeners remain unchanged
  checkSessionOnLoad();
  $("#logoutButton, #logoutDropdown").on("click", logoutUser);

  // New patient search listener
  $('#patientSearchInput').on('input', function() {
    const query = $(this).val();
    searchPatients(query);
  });

  // Hide search results when clicking outside
  $(document).on('click', function(e) {
    if (!$(e.target).closest('.patient-search-container').length) {
      $('#patientSearchResults').hide();
    }
  });
});
// Store original values and units
const originalVitals = {};

// Initialize vitals modal
$("#vitalsModal").on("show.bs.modal", function() {
  $("#vitalsForm")[0].reset();
  $("#vitalsForm .form-control").removeClass("is-invalid");
  $(".invalid-feedback").text("");

  // Initialize original values and units
  const vitalFields = [
    "modalBloodPressure", "modalHeartRate", "modalTemperature", "modalRespiratoryRate",
    "modalOxygenSaturation", "modalWeight", "modalHeight"
  ];
  vitalFields.forEach(id => {
    const input = document.getElementById(id);
    const select = document.querySelector(`.unit-select[data-input="${id}"]`);
    originalVitals[id] = {
      value: input.value || "",
      unit: select ? select.options[0].value : null // Default to first option
    };
    if (select) select.setAttribute("data-prev-unit", originalVitals[id].unit);
  });
});

// Unit selection (no immediate conversion)
$(".unit-select").on("change", function() {
  const inputId = this.dataset.input;
  const toUnit = this.value;
  this.setAttribute("data-prev-unit", toUnit); // Track selected unit
  console.log(`Unit for ${inputId} changed to ${toUnit}`);
});

// Conversion logic
$(".convert-btn").on("click", function() {
  const inputId = this.dataset.input;
  convertMeasurement(inputId);
});

function convertMeasurement(inputId) {
  const inputField = document.getElementById(inputId);
  const select = document.querySelector(`.unit-select[data-input="${inputId}"]`);
  const toUnit = select.value;
  const fromUnit = select.getAttribute("data-prev-unit") || select.options[0].value;
  const currentValue = inputField.value.trim();

  if (!currentValue) {
    displayAlert(`Enter a value for ${inputId} before converting.`, "error");
    return;
  }

  let newValue;
  if (inputId === "modalBloodPressure") {
    const [systolic, diastolic] = currentValue.split("/").map(v => parseFloat(v.trim()));
    if (isNaN(systolic) || isNaN(diastolic)) {
      displayAlert("Invalid blood pressure format. Use 'systolic/diastolic'.", "error");
      inputField.classList.add("is-invalid");
      document.getElementById(`${inputId}Feedback`).textContent = "Use format 'systolic/diastolic' (e.g., 120/80).";
      return;
    }
    const convertedSystolic = convertValue(systolic, fromUnit, toUnit, inputId);
    const convertedDiastolic = convertValue(diastolic, fromUnit, toUnit, inputId);
    newValue = `${convertedSystolic}/${convertedDiastolic}`;
  } else {
    const numericValue = parseFloat(currentValue);
    if (isNaN(numericValue)) {
      displayAlert(`Invalid value for ${inputId}. Enter a number.`, "error");
      inputField.classList.add("is-invalid");
      document.getElementById(`${inputId}Feedback`).textContent = "Enter a valid number.";
      return;
    }
    newValue = convertValue(numericValue, fromUnit, toUnit, inputId);
  }

  inputField.value = newValue;
  select.setAttribute("data-prev-unit", toUnit);
  inputField.classList.remove("is-invalid");
  document.getElementById(`${inputId}Feedback`).textContent = "";
}

function convertValue(value, fromUnit, toUnit, inputId) {
  if (fromUnit === toUnit) return value;

  const conversions = {
    "mmHg": { "kPa": v => v * 0.1333223684 },
    "kPa": { "mmHg": v => v / 0.1333223684 },
    "°C": { "°F": v => (v * 9/5) + 32 },
    "°F": { "°C": v => (v - 32) * 5/9 },
    "kg": { "lbs": v => v * 2.2046226218 },
    "lbs": { "kg": v => v / 2.2046226218 },
    "cm": { "in": v => v / 2.54 },
    "in": { "cm": v => v * 2.54 }
  };

  const conversionFunc = conversions[fromUnit]?.[toUnit];
  if (!conversionFunc) return value;

  const result = conversionFunc(value);
  // Avoid unnecessary rounding for blood pressure to preserve precision
  return inputId === "modalBloodPressure" ? result.toFixed(2) : result.toFixed(2);
}

// Validation function
function validateVitals() {
  const validations = {
    "modalBloodPressure": {
      validate: val => {
        if (!val) return true; // Optional
        const [systolic, diastolic] = val.split("/").map(v => parseFloat(v));
        return !isNaN(systolic) && !isNaN(diastolic) && systolic >= 50 && systolic <= 250 && diastolic >= 30 && diastolic <= 150 && systolic > diastolic;
      },
      message: "Blood Pressure must be in 'systolic/diastolic' format (e.g., 120/80), with systolic 50-250 and diastolic 30-150 mmHg."
    },
    "modalHeartRate": {
      validate: val => !val || (!isNaN(val) && val >= 30 && val <= 200),
      message: "Heart Rate must be between 30-200 bpm."
    },
    "modalTemperature": {
      validate: val => {
        if (!val) return true; // Optional
        const temp = parseFloat(val);
        const unit = document.querySelector(`.unit-select[data-input="modalTemperature"]`).value;
        return !isNaN(temp) && (
          (unit === "°C" && temp >= 35 && temp <= 42) ||
          (unit === "°F" && temp >= 95 && temp <= 107.6)
        );
      },
      message: "Temperature must be 35-42°C or 95-107.6°F."
    },
    "modalRespiratoryRate": {
      validate: val => !val || (!isNaN(val) && val >= 8 && val <= 40),
      message: "Respiratory Rate must be between 8-40 breaths/min."
    },
    "modalOxygenSaturation": {
      validate: val => !val || (!isNaN(val) && val >= 70 && val <= 100),
      message: "Oxygen Saturation must be between 70-100%."
    },
    "modalWeight": {
      validate: val => {
        if (!val) return true; // Optional
        const weight = parseFloat(val);
        const unit = document.querySelector(`.unit-select[data-input="modalWeight"]`).value;
        return !isNaN(weight) && (
          (unit === "kg" && weight >= 2 && weight <= 300) ||
          (unit === "lbs" && weight >= 4.4 && weight <= 661)
        );
      },
      message: "Weight must be 2-300 kg or 4.4-661 lbs."
    },
    "modalHeight": {
      validate: val => {
        if (!val) return true; // Optional
        const height = parseFloat(val);
        const unit = document.querySelector(`.unit-select[data-input="modalHeight"]`).value;
        return !isNaN(height) && (
          (unit === "cm" && height >= 20 && height <= 250) ||
          (unit === "in" && height >= 7.9 && height <= 98.4)
        );
      },
      message: "Height must be 20-250 cm or 7.9-98.4 in."
    }
  };

  let isValid = true;
  Object.keys(validations).forEach(id => {
    const input = document.getElementById(id);
    const value = input.value.trim();
    const feedback = document.getElementById(`${id}Feedback`);
    if (!validations[id].validate(value)) {
      input.classList.add("is-invalid");
      feedback.textContent = validations[id].message;
      isValid = false;
    } else {
      input.classList.remove("is-invalid");
      feedback.textContent = "";
    }
  });
  return isValid;
}

// Save vitals with validation
function saveVitals() {
  if (!validateVitals()) {
    displayAlert("Please correct the invalid fields.", "error");
    return;
  }

  const appointmentId = $("#vitalsModal").data("appointmentId");
  if (!appointmentId) {
    displayAlert("Appointment ID is missing.", "error");
    return;
  }

  const vitalsData = {
    appointment: appointmentId,
    blood_pressure: $("#modalBloodPressure").val().trim() || null,
    heart_rate: $("#modalHeartRate").val().trim() || null,
    temperature: $("#modalTemperature").val().trim() || null,
    respiratory_rate: $("#modalRespiratoryRate").val().trim() || null,
    oxygen_saturation: $("#modalOxygenSaturation").val().trim() || null,
    weight: $("#modalWeight").val().trim() || null,
    height: $("#modalHeight").val().trim() || null,
    blood_pressure_unit: document.querySelector(`.unit-select[data-input="modalBloodPressure"]`).value,
    temperature_unit: document.querySelector(`.unit-select[data-input="modalTemperature"]`).value,
    weight_unit: document.querySelector(`.unit-select[data-input="modalWeight"]`).value,
    height_unit: document.querySelector(`.unit-select[data-input="modalHeight"]`).value
  };

  // Remove null values
  Object.keys(vitalsData).forEach(key => { if (vitalsData[key] === null) delete vitalsData[key]; });

  console.log("Saving vitals with data:", vitalsData);

  $.ajax({
    url: `http://smarthospitalmaintain.com:8000/appointments/vitals/${appointmentId}/`,
    type: "POST",
    headers: getAuthHeaders(),
    data: JSON.stringify(vitalsData),
    contentType: "application/json",
    success: function(response) {
      $("#vitalsModal").modal("hide");
      displayAlert("Vitals saved successfully!", "success");
      location.reload();
    },
    error: function(xhr) {
      const errorMsg = getErrorMessage(xhr, "Failed to save vitals.");
      displayAlert(errorMsg, "error");
    }
  });
}

  </script>

  <!-- Vendor Scripts -->
  <script src="assets/vendors/js/vendor.bundle.base.js"></script>
  <script src="assets/vendors/chart.js/chart.umd.js"></script>
  <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
  <script src="assets/js/off-canvas.js"></script>
  <script src="assets/js/misc.js"></script>
  <script src="assets/js/settings.js"></script>
  <script src="assets/js/todolist.js"></script>
  <script src="assets/js/jquery.cookie.js"></script>
  <script src="assets/js/dashboard.js"></script>
</body>
</html>
